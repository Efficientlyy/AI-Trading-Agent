<!-- 
    Trade Entry/Exit Quality Analysis Component
    
    This component provides visualizations to analyze the timing and quality of trade entries
    and exits, slippage across market conditions, and missed opportunity analysis to help
    users improve their trading strategy execution.
-->

<div class="card trade-quality-panel">
    <div class="card-header">
        <div class="card-title">
            <h3>Trade Entry/Exit Quality Analysis</h3>
            <div class="card-actions">
                <button id="trade-quality-settings-btn" class="btn btn-icon" data-tooltip="Trade quality settings" data-position="top">
                    <i data-feather="settings"></i>
                </button>
                <button id="download-trade-quality-data-btn" class="btn btn-icon" data-tooltip="Download data" data-position="top">
                    <i data-feather="download"></i>
                </button>
                <button id="expand-trade-quality-panel-btn" class="btn btn-icon" data-tooltip="Expand panel" data-position="top">
                    <i data-feather="maximize-2"></i>
                </button>
            </div>
        </div>
        <div class="trade-quality-controls">
            <div class="strategy-selector">
                <label for="trade-quality-strategy">Strategy:</label>
                <select id="trade-quality-strategy" class="form-select">
                    <option value="all" selected>All Strategies</option>
                    <option value="ml_strategy">ML Strategy</option>
                    <option value="sentiment_strategy">Sentiment Strategy</option>
                    <option value="technical_strategy">Technical Strategy</option>
                    <option value="meta_strategy">Meta Strategy</option>
                </select>
            </div>
            <div class="asset-selector">
                <label for="trade-quality-asset">Asset:</label>
                <select id="trade-quality-asset" class="form-select">
                    <option value="all" selected>All Assets</option>
                    <option value="BTC-USD">BTC/USD</option>
                    <option value="ETH-USD">ETH/USD</option>
                    <option value="SOL-USD">SOL/USD</option>
                    <option value="BNB-USD">BNB/USD</option>
                </select>
            </div>
            <div class="time-range-selector">
                <label for="trade-quality-timerange">Time Range:</label>
                <select id="trade-quality-timerange" class="form-select">
                    <option value="1w">1 Week</option>
                    <option value="1m" selected>1 Month</option>
                    <option value="3m">3 Months</option>
                    <option value="6m">6 Months</option>
                    <option value="1y">1 Year</option>
                </select>
            </div>
            <div class="trade-type-selector">
                <label for="trade-quality-type">Trade Type:</label>
                <select id="trade-quality-type" class="form-select">
                    <option value="all" selected>All Trades</option>
                    <option value="entry">Entries Only</option>
                    <option value="exit">Exits Only</option>
                    <option value="profitable">Profitable Only</option>
                    <option value="losing">Losing Only</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        <div class="trade-quality-grid">
            <!-- Entry/Exit Timing Efficiency Chart -->
            <div class="trade-quality-grid-item timing-efficiency-container">
                <h4 class="chart-title">Entry/Exit Timing Efficiency</h4>
                <div class="visualization-controls">
                    <div class="efficiency-metric-selector">
                        <label for="efficiency-metric">Metric:</label>
                        <select id="efficiency-metric" class="form-select">
                            <option value="percent" selected>% of Optimal</option>
                            <option value="pips">Pips from Optimal</option>
                            <option value="time">Time Deviation</option>
                        </select>
                    </div>
                    <div class="trade-count-selector">
                        <label for="trade-count">Trades:</label>
                        <select id="trade-count" class="form-select">
                            <option value="20">Last 20</option>
                            <option value="50" selected>Last 50</option>
                            <option value="100">Last 100</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                </div>
                <div id="timing-efficiency-chart" class="trade-quality-chart">
                    <div class="chart-overlay">Loading...</div>
                </div>
            </div>
            
            <!-- Slippage Visualization Chart -->
            <div class="trade-quality-grid-item slippage-container">
                <h4 class="chart-title">Slippage by Market Conditions</h4>
                <div class="visualization-controls">
                    <div class="slippage-view-selector">
                        <label for="slippage-view">View:</label>
                        <select id="slippage-view" class="form-select">
                            <option value="heatmap" selected>Heatmap</option>
                            <option value="scatter">Scatter</option>
                            <option value="bar">Bar Chart</option>
                        </select>
                    </div>
                    <div class="condition-selector">
                        <label for="market-condition">Condition:</label>
                        <select id="market-condition" class="form-select">
                            <option value="volatility" selected>Volatility</option>
                            <option value="volume">Volume</option>
                            <option value="spread">Spread</option>
                            <option value="timeofday">Time of Day</option>
                        </select>
                    </div>
                </div>
                <div id="slippage-chart" class="trade-quality-chart">
                    <div class="chart-overlay">Loading...</div>
                </div>
            </div>
            
            <!-- Missed Opportunity Analysis -->
            <div class="trade-quality-grid-item missed-opportunity-container">
                <h4 class="chart-title">Missed Opportunity Analysis</h4>
                <div class="visualization-controls">
                    <div class="opportunity-type-selector">
                        <label for="opportunity-type">Type:</label>
                        <select id="opportunity-type" class="form-select">
                            <option value="signals" selected>Missed Signals</option>
                            <option value="entries">Late Entries</option>
                            <option value="exits">Early Exits</option>
                        </select>
                    </div>
                    <div class="threshold-selector">
                        <label for="opportunity-threshold">Threshold:</label>
                        <select id="opportunity-threshold" class="form-select">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div id="missed-opportunity-chart" class="trade-quality-chart">
                    <div class="chart-overlay">Loading...</div>
                </div>
            </div>
            
            <!-- What-if Scenario Analysis -->
            <div class="trade-quality-grid-item what-if-container">
                <h4 class="chart-title">"What-If" Scenario Simulation</h4>
                <div class="visualization-controls">
                    <div class="scenario-selector">
                        <label for="scenario-type">Scenario:</label>
                        <select id="scenario-type" class="form-select">
                            <option value="optimal-entry" selected>Optimal Entries</option>
                            <option value="optimal-exit">Optimal Exits</option>
                            <option value="zero-slippage">No Slippage</option>
                            <option value="all-signals">All Signals</option>
                        </select>
                    </div>
                    <div class="impact-metric-selector">
                        <label for="impact-metric">Impact:</label>
                        <select id="impact-metric" class="form-select">
                            <option value="pnl" selected>P&L</option>
                            <option value="roi">ROI</option>
                            <option value="drawdown">Drawdown</option>
                        </select>
                    </div>
                </div>
                <div id="what-if-chart" class="trade-quality-chart">
                    <div class="chart-overlay">Loading...</div>
                </div>
            </div>
        </div>
        
        <div class="trade-quality-insights">
            <div class="insight-card">
                <div class="insight-header">
                    <h4>Trade Execution Summary</h4>
                </div>
                <div class="insight-body">
                    <div class="execution-summary">
                        <div class="summary-metrics">
                            <div class="metric-group">
                                <div class="metric-item">
                                    <span class="metric-label">Avg. Entry Efficiency:</span>
                                    <span class="metric-value" id="avg-entry-efficiency">68%</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Avg. Exit Efficiency:</span>
                                    <span class="metric-value" id="avg-exit-efficiency">72%</span>
                                </div>
                            </div>
                            <div class="metric-group">
                                <div class="metric-item">
                                    <span class="metric-label">Avg. Slippage:</span>
                                    <span class="metric-value" id="avg-slippage">0.21%</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Signal Execution Rate:</span>
                                    <span class="metric-value" id="execution-rate">83%</span>
                                </div>
                            </div>
                            <div class="metric-group">
                                <div class="metric-item">
                                    <span class="metric-label">Potential Improvement:</span>
                                    <span class="metric-value positive" id="improvement-potential">+12.5%</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Trade Count:</span>
                                    <span class="metric-value" id="trade-count-value">128</span>
                                </div>
                            </div>
                        </div>
                        <div class="trend-analysis">
                            <h5>Execution Quality Trend</h5>
                            <div id="quality-trend-chart" class="mini-chart"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="insight-card">
                <div class="insight-header">
                    <h4>Improvement Recommendations</h4>
                </div>
                <div class="insight-body">
                    <div class="recommendations-list" id="trade-recommendations">
                        <div class="recommendation-item high-priority">
                            <div class="recommendation-header">
                                <span class="recommendation-title">Reduce Slippage During High Volatility</span>
                                <span class="recommendation-priority">High Impact</span>
                            </div>
                            <div class="recommendation-description">
                                Slippage is 3.2x higher during volatility spikes. Consider using limit orders instead of market orders when volatility exceeds 2 standard deviations from the mean.
                            </div>
                        </div>
                        <div class="recommendation-item medium-priority">
                            <div class="recommendation-header">
                                <span class="recommendation-title">Improve Exit Timing for BTC Trades</span>
                                <span class="recommendation-priority">Medium Impact</span>
                            </div>
                            <div class="recommendation-description">
                                BTC exits are on average 15.3% away from optimal. Using trailing stops at 5% instead of fixed stops may improve exit efficiency.
                            </div>
                        </div>
                        <div class="recommendation-item low-priority">
                            <div class="recommendation-header">
                                <span class="recommendation-title">Increase Signal Response Time</span>
                                <span class="recommendation-priority">Low Impact</span>
                            </div>
                            <div class="recommendation-description">
                                Average delay between signal generation and trade execution is 1.2 minutes. Optimize API connection or use WebSocket for faster execution.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-footer">
        <div class="trade-quality-metrics-summary">
            <div class="metric-item">
                <span class="metric-label">Best Asset:</span>
                <span class="metric-value" id="best-asset">ETH/USD (85% efficiency)</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">Worst Market Condition:</span>
                <span class="metric-value" id="worst-condition">High Vol. + Low Liquidity</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">Best Strategy:</span>
                <span class="metric-value" id="best-strategy">Meta Strategy (79%)</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">Updated:</span>
                <span class="metric-value" id="trade-quality-last-updated">3 minutes ago</span>
            </div>
        </div>
        <div class="trade-quality-actions">
            <button class="btn btn-sm" id="trade-quality-learn-more">
                <i data-feather="info"></i> Learn More
            </button>
            <button class="btn btn-sm" id="export-trade-quality-report">
                <i data-feather="file-text"></i> Export Report
            </button>
        </div>
    </div>
</div>

<!-- Trade Quality Settings Modal -->
<div id="trade-quality-settings-modal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Trade Quality Analysis Settings</h3>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="optimal-calculation">Optimal Price Calculation:</label>
                    <select id="optimal-calculation" class="form-select">
                        <option value="local-extrema" selected>Local Extrema (24h)</option>
                        <option value="signal-window">Signal Window (±6h)</option>
                        <option value="trend-based">Trend-Based</option>
                        <option value="custom">Custom Window</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="slippage-calculation">Slippage Calculation Method:</label>
                    <select id="slippage-calculation" class="form-select">
                        <option value="expected-vs-executed" selected>Expected vs. Executed</option>
                        <option value="quoted-vs-executed">Quoted vs. Executed</option>
                        <option value="arrival-price">Arrival Price</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Efficiency Thresholds:</label>
                    <div class="threshold-settings">
                        <div class="threshold-item">
                            <span class="threshold-label">Good:</span>
                            <input type="number" id="good-threshold" class="form-input threshold-input" value="80" min="0" max="100">
                            <span class="threshold-unit">%</span>
                        </div>
                        <div class="threshold-item">
                            <span class="threshold-label">Medium:</span>
                            <input type="number" id="medium-threshold" class="form-input threshold-input" value="50" min="0" max="100">
                            <span class="threshold-unit">%</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="missed-opportunity-detection">Missed Opportunity Detection:</label>
                    <div class="slider-container">
                        <input type="range" id="missed-opportunity-detection" class="form-range" min="1" max="10" value="5">
                        <span class="slider-value">5</span>
                        <span class="slider-label">(Sensitivity)</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Advanced Options:</label>
                    <div class="checkbox-item">
                        <input type="checkbox" id="include-canceled-orders" checked>
                        <label for="include-canceled-orders">Include Canceled Orders</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="normalize-by-volatility" checked>
                        <label for="normalize-by-volatility">Normalize by Volatility</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="exclude-outliers">
                        <label for="exclude-outliers">Exclude Outliers (±3σ)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="show-benchmarks" checked>
                        <label for="show-benchmarks">Show Benchmarks</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="custom-benchmark">Custom Benchmark:</label>
                    <select id="custom-benchmark" class="form-select">
                        <option value="none" selected>None</option>
                        <option value="market-vwap">Market VWAP</option>
                        <option value="best-execution">Best Historical Execution</option>
                        <option value="competing-strategy">Competing Strategy</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-trade-quality-settings">Apply Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Add CSS for the trade quality panel -->
<style>
    .trade-quality-panel {
        margin-bottom: 1.5rem;
    }
    
    .trade-quality-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        margin-top: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-light);
    }
    
    .strategy-selector,
    .asset-selector,
    .time-range-selector,
    .trade-type-selector {
        min-width: 150px;
    }
    
    .trade-quality-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 300px 300px;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .trade-quality-grid-item {
        background-color: var(--bg-light);
        border-radius: 6px;
        overflow: hidden;
        position: relative;
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
    }
    
    .chart-title {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text);
        margin: 0 0 0.5rem 0;
        padding: 0 0 0.5rem 0;
        border-bottom: 1px solid var(--border-light);
    }
    
    .trade-quality-chart {
        flex: 1;
        position: relative;
        min-height: 200px;
        background-color: var(--card-bg);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .chart-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(var(--card-bg-rgb), 0.8);
        font-size: 1rem;
        color: var(--text-light);
        z-index: 5;
    }
    
    .visualization-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        align-items: center;
        justify-content: space-between;
    }
    
    .efficiency-metric-selector,
    .trade-count-selector,
    .slippage-view-selector,
    .condition-selector,
    .opportunity-type-selector,
    .threshold-selector,
    .scenario-selector,
    .impact-metric-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .visualization-controls label {
        font-size: 0.8rem;
        color: var(--text-light);
    }
    
    .visualization-controls select {
        max-width: 120px;
        font-size: 0.8rem;
    }
    
    .trade-quality-insights {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .insight-card {
        background-color: var(--bg-light);
        border-radius: 6px;
        overflow: hidden;
    }
    
    .insight-header {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-light);
    }
    
    .insight-header h4 {
        margin: 0;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .insight-body {
        padding: 0.75rem 1rem;
    }
    
    .execution-summary {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .summary-metrics {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .metric-group {
        flex: 1;
        min-width: 150px;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .metric-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
    }
    
    .metric-label {
        color: var(--text-light);
    }
    
    .metric-value {
        font-weight: 500;
    }
    
    .metric-value.positive {
        color: var(--success);
    }
    
    .metric-value.negative {
        color: var(--danger);
    }
    
    .metric-value.neutral {
        color: var(--warning);
    }
    
    .trend-analysis {
        margin-top: 0.5rem;
    }
    
    .trend-analysis h5 {
        font-size: 0.85rem;
        margin: 0 0 0.5rem 0;
        color: var(--text-light);
    }
    
    .mini-chart {
        height: 60px;
        width: 100%;
        background-color: var(--card-bg);
        border-radius: 4px;
    }
    
    .recommendations-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .recommendation-item {
        padding: 0.75rem;
        border-radius: 4px;
        border-left: 3px solid var(--primary);
        background-color: var(--card-bg);
    }
    
    .recommendation-item.high-priority {
        border-left-color: var(--danger);
    }
    
    .recommendation-item.medium-priority {
        border-left-color: var(--warning);
    }
    
    .recommendation-item.low-priority {
        border-left-color: var(--info);
    }
    
    .recommendation-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }
    
    .recommendation-title {
        font-weight: 500;
        font-size: 0.85rem;
    }
    
    .recommendation-priority {
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        background-color: var(--primary-light);
        color: var(--primary);
    }
    
    .high-priority .recommendation-priority {
        background-color: rgba(var(--danger-rgb), 0.1);
        color: var(--danger);
    }
    
    .medium-priority .recommendation-priority {
        background-color: rgba(var(--warning-rgb), 0.1);
        color: var(--warning);
    }
    
    .low-priority .recommendation-priority {
        background-color: rgba(var(--info-rgb), 0.1);
        color: var(--info);
    }
    
    .recommendation-description {
        font-size: 0.8rem;
        color: var(--text-light);
        line-height: 1.4;
    }
    
    .trade-quality-metrics-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
    }
    
    .trade-quality-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    /* Modal specific styles */
    .threshold-settings {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
    }
    
    .threshold-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .threshold-label {
        min-width: 70px;
        font-size: 0.85rem;
    }
    
    .threshold-input {
        width: 60px;
        padding: 0.25rem;
        border: 1px solid var(--border-light);
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .threshold-unit {
        font-size: 0.85rem;
        color: var(--text-light);
    }
    
    .slider-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .form-range {
        flex: 1;
    }
    
    .slider-value {
        min-width: 1.5rem;
        text-align: right;
    }
    
    .slider-label {
        font-size: 0.8rem;
        color: var(--text-light);
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .checkbox-item label {
        font-size: 0.85rem;
        margin: 0;
    }
    
    /* Responsive adjustments */
    @media (max-width: 992px) {
        .trade-quality-grid {
            grid-template-columns: 1fr;
            grid-template-rows: repeat(4, 300px);
        }
        
        .trade-quality-insights {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 768px) {
        .trade-quality-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .strategy-selector,
        .asset-selector,
        .time-range-selector,
        .trade-type-selector {
            width: 100%;
        }
        
        .trade-quality-metrics-summary {
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .summary-metrics {
            flex-direction: column;
        }
    }
</style>

<!-- JavaScript for trade quality panel functionality will be loaded separately -->