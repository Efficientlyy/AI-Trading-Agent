<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - AI Trading Agent</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Base styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern_dashboard.css') }}">
    <!-- Include Plotly.js for charts -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Include Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <!-- Include Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <!-- Include Shepherd.js for guided tours -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
    
    {% include 'tooltip.html' %}
    <!-- Include Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>
<body class="dashboard-body">
    <!-- Main container -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-text">AI Trading</span>
                </div>
                <button class="mobile-toggle" id="sidebarToggle">
                    <i data-feather="menu"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="nav-links">
                    <li class="nav-item {{ 'active' if active_tab == 'overview' else '' }}">
                        <a href="{{ url_for('dashboard') }}">
                            <i data-feather="home"></i>
                            <span>Overview</span>
                        </a>
                    </li>
                    <li class="nav-item {{ 'active' if active_tab == 'sentiment' else '' }}">
                        <a href="{{ url_for('sentiment_tab') }}">
                            <i data-feather="activity"></i>
                            <span>Sentiment</span>
                        </a>
                    </li>
                    <li class="nav-item {{ 'active' if active_tab == 'market-regime' else '' }}">
                        <a href="{{ url_for('market_regime_tab') }}">
                            <i data-feather="trending-up"></i>
                            <span>Market Regime</span>
                        </a>
                    </li>
                    <li class="nav-item {{ 'active' if active_tab == 'risk' else '' }}">
                        <a href="{{ url_for('risk_tab') }}">
                            <i data-feather="shield"></i>
                            <span>Risk</span>
                        </a>
                    </li>
                    <li class="nav-item {{ 'active' if active_tab == 'performance' else '' }}">
                        <a href="{{ url_for('performance_tab') }}">
                            <i data-feather="bar-chart-2"></i>
                            <span>Performance</span>
                        </a>
                    </li>
                    <li class="nav-item {{ 'active' if active_tab == 'logs' else '' }}">
                        <a href="{{ url_for('logs_tab') }}">
                            <i data-feather="list"></i>
                            <span>Logs</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <div class="version">v1.0.0</div>
            </div>
        </aside>
        
        <!-- Main content area -->
        <main class="main-content">
            <!-- Top bar with system controls -->
            <div class="top-bar">
                <div class="system-controls">
                    <div class="control-group master-control">
                        <span class="control-label">System Power</span>
                        <div class="control-buttons">
                            <button id="startSystem" class="control-button start {{ 'disabled' if system_state != 'stopped' else '' }}">
                                <i data-feather="power"></i>
                                <span>Start</span>
                            </button>
                            <button id="stopSystem" class="control-button stop {{ 'disabled' if system_state != 'running' else '' }}">
                                <i data-feather="power-off"></i>
                                <span>Stop</span>
                            </button>
                        </div>
                        <div class="system-status">
                            <span class="status-indicator {{ system_state }}"></span>
                            <span class="status-text">{{ system_state|title }}</span>
                        </div>
                    </div>
                    
                    <div class="control-group trading-control">
                        <span class="control-label">Trading</span>
                        <div class="control-buttons">
                            <button id="enableTrading" class="control-button enable {{ 'disabled' if system_state != 'running' or trading_state == 'enabled' else '' }}">
                                <i data-feather="play"></i>
                                <span>Enable</span>
                            </button>
                            <button id="disableTrading" class="control-button disable {{ 'disabled' if trading_state != 'enabled' else '' }}">
                                <i data-feather="pause"></i>
                                <span>Disable</span>
                            </button>
                        </div>
                        <div class="trading-status">
                            <span class="status-indicator {{ trading_state }}"></span>
                            <span class="status-text">{{ trading_state|title }}</span>
                        </div>
                    </div>
                    
                    <div class="control-group mode-control">
                        <span class="control-label">Mode</span>
                        <div class="control-buttons mode-buttons">
                            <button class="mode-button {{ 'active' if system_mode == 'paper' else '' }}" data-mode="paper">Paper</button>
                            <button class="mode-button {{ 'active' if system_mode == 'live' else '' }}" data-mode="live">Live</button>
                            <button class="mode-button {{ 'active' if system_mode == 'backtest' else '' }}" data-mode="backtest">Backtest</button>
                        </div>
                    </div>
                    
                    <div class="control-group data-source-control">
                        <span class="control-label">Data Source</span>
                        <div class="control-buttons data-source-buttons">
                            <button class="data-source-button {{ 'active' if data_source == 'mock' else '' }}" data-source="mock">Mock</button>
                            <button class="data-source-button {{ 'active' if data_source == 'real' else '' }}" data-source="real">Real</button>
                        </div>
                        <div class="data-source-status">
                            <span class="status-indicator {{ data_source }}"></span>
                            <span class="status-text">{{ data_source|title }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="user-menu">
                    <div class="time-display" id="currentTime"></div>
                    <div class="connection-status-container">
                        <div id="connectionStatus" class="connection-status disconnected" title="Disconnected">
                            <i data-feather="wifi"></i>
                        </div>
                    </div>
                    <div class="theme-toggle-container" title="Toggle dark mode">
                        <button class="theme-toggle" id="themeToggleBtn">
                            <i data-feather="sun" class="light-icon"></i>
                            <i data-feather="moon" class="dark-icon"></i>
                        </button>
                    </div>
                    <div class="settings-button-container" title="Dashboard Settings">
                        <button class="settings-button" id="openSettingsBtn">
                            <i data-feather="settings"></i>
                        </button>
                    </div>
                    <div class="notifications" id="notificationTrigger">
                        <i data-feather="bell"></i>
                        <span class="notification-badge" id="alertCount">0</span>
                    </div>
                    <div class="user-profile">
                        <i data-feather="user"></i>
                        <span class="username">{{ user }}</span>
                        <div class="user-dropdown">
                            <ul class="user-dropdown-menu">
                                {% if user_role == 'admin' %}
                                <li>
                                    <a href="{{ url_for('users_page') }}" class="user-dropdown-item">
                                        <i data-feather="users"></i>
                                        <span>User Management</span>
                                    </a>
                                </li>
                                {% endif %}
                                <li>
                                    <a href="{{ url_for('logout') }}" class="user-dropdown-item">
                                        <i data-feather="log-out"></i>
                                        <span>Logout</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Page header -->
            <div class="page-header">
                <h1>{{ active_tab|title }}</h1>
                <div class="page-actions">
                    <button id="exportDataBtn" class="export-data-btn">
                        <i data-feather="download"></i>
                        <span>Export Data</span>
                    </button>
                </div>
            </div>
            
            <!-- Dashboard content -->
            <div class="dashboard-content">
                {% if active_tab == 'logs' %}
                <div id="logsMonitoringDashboard" class="dashboard-grid">
                    <!-- System Logs Card -->
                    <div class="card system-logs">
                        <div class="card-header">
                            <h2>System Logs</h2>
                            <div class="card-actions">
                                <button class="refresh-button" data-target="systemLogs">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                                <div class="search-container">
                                    <input type="text" id="logsSearchInput" placeholder="Search logs..." class="search-input">
                                    <button id="logsSearchButton" class="search-button">
                                        <i data-feather="search"></i>
                                    </button>
                                </div>
                                <div class="filter-container">
                                    <select id="logLevelFilter" class="filter-select">
                                        <option value="all">All Levels</option>
                                        <option value="INFO">INFO</option>
                                        <option value="WARNING">WARNING</option>
                                        <option value="ERROR">ERROR</option>
                                        <option value="DEBUG">DEBUG</option>
                                    </select>
                                    <select id="componentFilter" class="filter-select">
                                        <option value="all">All Components</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="logs-container">
                                <table class="logs-table">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Level</th>
                                            <th>Component</th>
                                            <th>Message</th>
                                        </tr>
                                    </thead>
                                    <tbody id="systemLogsBody">
                                        <!-- System logs will be added here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination">
                                <button id="prevLogsPage" class="page-button">
                                    <i data-feather="chevron-left"></i>
                                </button>
                                <span id="logsPageInfo">Page 1 of 1</span>
                                <button id="nextLogsPage" class="page-button">
                                    <i data-feather="chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resource Utilization Card -->
                    <div class="card resource-utilization">
                        <div class="card-header">
                            <h2>Resource Utilization</h2>
                        </div>
                        <div class="card-body">
                            <div class="resources-overview">
                                <div class="resource-metric">
                                    <div class="resource-name">CPU Usage</div>
                                    <div class="resource-gauge">
                                        <div class="gauge-value" id="cpuGaugeValue">--</div>
                                        <div class="gauge-meter">
                                            <div class="gauge-fill" id="cpuGaugeFill"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="resource-metric">
                                    <div class="resource-name">Memory</div>
                                    <div class="resource-gauge">
                                        <div class="gauge-value" id="memoryGaugeValue">--</div>
                                        <div class="gauge-meter">
                                            <div class="gauge-fill" id="memoryGaugeFill"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="resource-metric">
                                    <div class="resource-name">Network</div>
                                    <div class="resource-gauge">
                                        <div class="gauge-value" id="networkGaugeValue">--</div>
                                        <div class="gauge-meter">
                                            <div class="gauge-fill" id="networkGaugeFill"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="resource-metric">
                                    <div class="resource-name">API Latency</div>
                                    <div class="resource-gauge">
                                        <div class="gauge-value" id="latencyGaugeValue">--</div>
                                        <div class="gauge-meter">
                                            <div class="gauge-fill" id="latencyGaugeFill"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="resources-charts">
                                <div id="resourceUtilizationChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Error Distribution Card -->
                    <div class="card error-distribution">
                        <div class="card-header">
                            <h2>Error Distribution</h2>
                        </div>
                        <div class="card-body">
                            <div class="error-charts-container">
                                <div class="error-chart">
                                    <h3>Errors by Component</h3>
                                    <div id="errorByComponentChart" class="chart-container-small"></div>
                                </div>
                                <div class="error-chart">
                                    <h3>Errors by Type</h3>
                                    <div id="errorByTypeChart" class="chart-container-small"></div>
                                </div>
                                <div class="error-chart">
                                    <h3>Errors by Severity</h3>
                                    <div id="errorBySeverityChart" class="chart-container-small"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- API Status Card -->
                    <div class="card api-status">
                        <div class="card-header">
                            <h2>Exchange API Status</h2>
                        </div>
                        <div class="card-body">
                            <div class="api-status-grid" id="apiStatusGrid">
                                <!-- API status items will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Requests Card -->
                    <div class="card recent-requests">
                        <div class="card-header">
                            <h2>Recent API Requests</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="data-table requests-table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Exchange</th>
                                            <th>Method</th>
                                            <th>URL</th>
                                            <th>Status</th>
                                            <th>Response Time</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentRequestsBody">
                                        <!-- Recent requests will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trade Event Flow Card -->
                    <div class="card trade-event-flow">
                        <div class="card-header">
                            <h2>Trade Event Flow</h2>
                        </div>
                        <div class="card-body">
                            <div class="flow-container" id="tradeEventFlow">
                                <!-- Trade event flow will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
                {% elif active_tab == 'performance' %}
                <div id="performanceAnalyticsDashboard" class="dashboard-grid">
                    <!-- Performance Overview Card -->
                    <div class="card performance-overview">
                        <div class="card-header">
                            <h2>Performance Overview</h2>
                            <div class="card-actions">
                                <button class="refresh-button" data-target="performanceOverview">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="period-tabs">
                                <button class="period-tab active" data-period="daily">Daily</button>
                                <button class="period-tab" data-period="weekly">Weekly</button>
                                <button class="period-tab" data-period="monthly">Monthly</button>
                                <button class="period-tab" data-period="quarterly">Quarterly</button>
                                <button class="period-tab" data-period="yearly">Yearly</button>
                                <button class="period-tab" data-period="all_time">All Time</button>
                            </div>
                            
                            <div class="performance-metrics">
                                <div class="main-metrics">
                                    <div class="main-metric-item">
                                        <div class="metric-name">Return</div>
                                        <div class="metric-value positive" id="returnPct">--</div>
                                    </div>
                                    <div class="main-metric-item">
                                        <div class="metric-name">Win Rate</div>
                                        <div class="metric-value" id="winRate">--</div>
                                    </div>
                                    <div class="main-metric-item">
                                        <div class="metric-name">Total Trades</div>
                                        <div class="metric-value" id="totalTrades">--</div>
                                    </div>
                                    <div class="main-metric-item">
                                        <div class="metric-name">Profit Factor</div>
                                        <div class="metric-value" id="profitFactor">--</div>
                                    </div>
                                    <div class="main-metric-item">
                                        <div class="metric-name">Expected Value</div>
                                        <div class="metric-value" id="expectedValue">--</div>
                                    </div>
                                    <div class="main-metric-item">
                                        <div class="metric-name">Sharpe Ratio</div>
                                        <div class="metric-value" id="sharpeRatio">--</div>
                                    </div>
                                    <div class="main-metric-item">
                                        <div class="metric-name">Max Drawdown</div>
                                        <div class="metric-value" id="maxDrawdown">--</div>
                                    </div>
                                </div>
                                
                                <div class="additional-metrics">
                                    <div class="metric-row">
                                        <div class="metric-item">
                                            <div class="metric-name">Winning Trades</div>
                                            <div class="metric-value" id="winningTrades">--</div>
                                        </div>
                                        <div class="metric-item">
                                            <div class="metric-name">Losing Trades</div>
                                            <div class="metric-value" id="losingTrades">--</div>
                                        </div>
                                        <div class="metric-item">
                                            <div class="metric-name">Avg Profit</div>
                                            <div class="metric-value" id="avgProfit">--</div>
                                        </div>
                                        <div class="metric-item">
                                            <div class="metric-name">Avg Loss</div>
                                            <div class="metric-value" id="avgLoss">--</div>
                                        </div>
                                    </div>
                                    <div class="metric-row">
                                        <div class="metric-item">
                                            <div class="metric-name">Trading Volume</div>
                                            <div class="metric-value" id="tradingVolume">--</div>
                                        </div>
                                        <div class="metric-item">
                                            <div class="metric-name">Trading Fees</div>
                                            <div class="metric-value" id="tradingFees">--</div>
                                        </div>
                                        <div class="metric-item">
                                            <div class="metric-name">Last Updated</div>
                                            <div class="metric-value timestamp" id="performanceLastUpdated">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Equity Curve Card -->
                    <div class="card equity-curve">
                        <div class="card-header">
                            <h2>Equity Curve</h2>
                        </div>
                        <div class="card-body">
                            <div id="equityChart" class="chart-container"></div>
                        </div>
                    </div>
                    
                    <!-- Drawdown Analysis Card -->
                    <div class="card drawdown-analysis">
                        <div class="card-header">
                            <h2>Drawdown Analysis</h2>
                        </div>
                        <div class="card-body">
                            <div id="drawdownChart" class="chart-container"></div>
                        </div>
                    </div>
                    
                    <!-- Strategy Performance Card -->
                    <div class="card strategy-performance">
                        <div class="card-header">
                            <h2>Strategy Performance</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="data-table performance-table">
                                    <thead>
                                        <tr>
                                            <th>Strategy</th>
                                            <th>Return</th>
                                            <th>Trades</th>
                                            <th>Win Rate</th>
                                            <th>Profit Factor</th>
                                            <th>Sharpe</th>
                                            <th>Max DD</th>
                                            <th>Holding Time</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="strategyPerformanceTableBody">
                                        <!-- Strategy performance rows will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Asset Performance Card -->
                    <div class="card asset-performance">
                        <div class="card-header">
                            <h2>Asset Performance</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="data-table performance-table">
                                    <thead>
                                        <tr>
                                            <th>Asset</th>
                                            <th>Return</th>
                                            <th>Trades</th>
                                            <th>Win Rate</th>
                                            <th>Profit Factor</th>
                                            <th>Avg Profit</th>
                                            <th>Avg Loss</th>
                                            <th>Holding Time</th>
                                            <th>Unrealized P&L</th>
                                        </tr>
                                    </thead>
                                    <tbody id="assetPerformanceTableBody">
                                        <!-- Asset performance rows will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trade Distribution Card -->
                    <div class="card trade-distribution">
                        <div class="card-header">
                            <h2>Trade Distribution</h2>
                        </div>
                        <div class="card-body">
                            <div class="distribution-container">
                                <div class="distribution-row">
                                    <div class="distribution-chart-container">
                                        <h3>Time of Day</h3>
                                        <div id="timeOfDayChart" class="chart-container-small"></div>
                                    </div>
                                    <div class="distribution-chart-container">
                                        <h3>Day of Week</h3>
                                        <div id="dayOfWeekChart" class="chart-container-small"></div>
                                    </div>
                                </div>
                                <div class="distribution-row">
                                    <div class="distribution-chart-container">
                                        <h3>Trade Size</h3>
                                        <div id="tradeSizeChart" class="chart-container-small"></div>
                                    </div>
                                    <div class="distribution-chart-container">
                                        <h3>Holding Time</h3>
                                        <div id="holdingTimeChart" class="chart-container-small"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Factors Card -->
                    <div class="card performance-factors">
                        <div class="card-header">
                            <h2>Performance Factors</h2>
                        </div>
                        <div class="card-body">
                            <div class="factors-container">
                                <div class="factor-item">
                                    <div class="factor-name">Volatility Impact</div>
                                    <div class="factor-bar-container">
                                        <div class="factor-bar" id="volatilityImpactBar"></div>
                                    </div>
                                    <div class="factor-value" id="volatilityImpactValue">--</div>
                                </div>
                                <div class="factor-item">
                                    <div class="factor-name">Volume Impact</div>
                                    <div class="factor-bar-container">
                                        <div class="factor-bar" id="volumeImpactBar"></div>
                                    </div>
                                    <div class="factor-value" id="volumeImpactValue">--</div>
                                </div>
                                <div class="factor-item">
                                    <div class="factor-name">Market Hour Impact</div>
                                    <div class="factor-bar-container">
                                        <div class="factor-bar" id="marketHourImpactBar"></div>
                                    </div>
                                    <div class="factor-value" id="marketHourImpactValue">--</div>
                                </div>
                                <div class="factor-item">
                                    <div class="factor-name">News Sentiment Impact</div>
                                    <div class="factor-bar-container">
                                        <div class="factor-bar" id="newsSentimentImpactBar"></div>
                                    </div>
                                    <div class="factor-value" id="newsSentimentImpactValue">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Trades Card -->
                    <div class="card recent-trades-performance">
                        <div class="card-header">
                            <h2>Recent Trades</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="data-table performance-table">
                                    <thead>
                                        <tr>
                                            <th>Asset</th>
                                            <th>Strategy</th>
                                            <th>Side</th>
                                            <th>Entry</th>
                                            <th>Exit</th>
                                            <th>P&L</th>
                                            <th>P&L %</th>
                                            <th>Holding Time</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentTradesPerformanceTableBody">
                                        <!-- Recent trades rows will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% elif active_tab == 'overview' %}
                <div id="overviewDashboard" class="dashboard-grid">
                    <!-- System Overview Card -->
                    <div class="card system-overview">
                        <div class="card-header">
                            <h2>System Overview</h2>
                            <div class="card-actions">
                                <button class="refresh-button" data-target="systemOverview">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="metrics-grid">
                                <div class="metric-item">
                                    <div class="metric-icon cpu-icon">
                                        <i data-feather="cpu"></i>
                                    </div>
                                    <div class="metric-data">
                                        <div class="metric-value" id="cpuUsage">--</div>
                                        <div class="metric-label">CPU Usage</div>
                                    </div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-icon memory-icon">
                                        <i data-feather="database"></i>
                                    </div>
                                    <div class="metric-data">
                                        <div class="metric-value" id="memoryUsage">--</div>
                                        <div class="metric-label">Memory</div>
                                    </div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-icon disk-icon">
                                        <i data-feather="hard-drive"></i>
                                    </div>
                                    <div class="metric-data">
                                        <div class="metric-value" id="diskUsage">--</div>
                                        <div class="metric-label">Disk</div>
                                    </div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-icon network-icon">
                                        <i data-feather="activity"></i>
                                    </div>
                                    <div class="metric-data">
                                        <div class="metric-value" id="networkLatency">--</div>
                                        <div class="metric-label">Network</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="system-health">
                                <h3>Component Status</h3>
                                <div class="component-list" id="componentList">
                                    <div class="loading-placeholder">Loading component status...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- P&L Summary Card -->
                    <div class="card pnl-summary">
                        <div class="card-header">
                            <h2>P&L Summary</h2>
                            <div class="card-actions">
                                <button class="refresh-button" data-target="pnlSummary">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="pnl-grid">
                                <div class="pnl-item">
                                    <div class="pnl-period">Daily</div>
                                    <div class="pnl-value" id="dailyPnl">$0.00</div>
                                </div>
                                <div class="pnl-item">
                                    <div class="pnl-period">Weekly</div>
                                    <div class="pnl-value" id="weeklyPnl">$0.00</div>
                                </div>
                                <div class="pnl-item">
                                    <div class="pnl-period">Monthly</div>
                                    <div class="pnl-value" id="monthlyPnl">$0.00</div>
                                </div>
                                <div class="pnl-item">
                                    <div class="pnl-period">YTD</div>
                                    <div class="pnl-value" id="ytdPnl">$0.00</div>
                                </div>
                            </div>
                            
                            <div class="pnl-details">
                                <div class="pnl-detail-item">
                                    <span class="detail-label">Realized</span>
                                    <span class="detail-value" id="realizedPnl">$0.00</span>
                                </div>
                                <div class="pnl-detail-item">
                                    <span class="detail-label">Unrealized</span>
                                    <span class="detail-value" id="unrealizedPnl">$0.00</span>
                                </div>
                                <div class="pnl-detail-item">
                                    <span class="detail-label">Win Rate</span>
                                    <span class="detail-value" id="winRate">0%</span>
                                </div>
                                <div class="pnl-detail-item">
                                    <span class="detail-label">Best Trade</span>
                                    <span class="detail-value" id="bestTrade">$0.00</span>
                                </div>
                            </div>
                            
                            <div id="equityCurveChart" class="chart-container">
                                <!-- Equity curve chart will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Positions Card -->
                    <div class="card positions-card">
                        <div class="card-header">
                            <h2>Current Positions</h2>
                            <div class="card-actions">
                                <button class="refresh-button" data-target="currentPositions">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="positions-table-wrapper">
                                <table class="data-table positions-table">
                                    <thead>
                                        <tr>
                                            <th>Asset</th>
                                            <th>Quantity</th>
                                            <th>Entry Price</th>
                                            <th>Current Price</th>
                                            <th>Current Value</th>
                                            <th>P&L</th>
                                            <th>P&L %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="positionsTableBody">
                                        <tr>
                                            <td colspan="7" class="loading-message">Loading positions...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Trades Card -->
                    <div class="card trades-card">
                        <div class="card-header">
                            <h2>Recent Trades</h2>
                            <div class="card-actions">
                                <button class="refresh-button" data-target="recentTrades">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="trades-table-wrapper">
                                <table class="data-table trades-table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Asset</th>
                                            <th>Side</th>
                                            <th>Price</th>
                                            <th>Quantity</th>
                                            <th>Value</th>
                                            <th>P&L</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tradesTableBody">
                                        <tr>
                                            <td colspan="7" class="loading-message">Loading trades...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Alerts Card -->
                    <div class="card alerts-card">
                        <div class="card-header">
                            <h2>System Alerts</h2>
                            <div class="card-actions">
                                <button class="refresh-button" data-target="systemAlerts">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="alerts-list" id="alertsList">
                                <div class="loading-placeholder">Loading alerts...</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% elif active_tab == 'sentiment' %}
                <div id="sentimentDashboard" class="dashboard-grid">
                    <!-- Overall Sentiment Card -->
                    <div class="card sentiment-overview">
                        <div class="card-header">
                            <h2>Overall Sentiment</h2>
                            <div class="card-actions">
                                <button class="refresh-button" data-target="sentimentOverview">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="sentiment-display">
                                <div class="sentiment-score-container">
                                    <div class="sentiment-label">Current Market Sentiment</div>
                                    <div class="sentiment-score" id="overallSentimentScore">Loading...</div>
                                </div>
                                <div class="sentiment-gauge-container">
                                    <div class="sentiment-gauge" id="sentimentGauge">
                                        <div class="gauge-marker" id="sentimentGaugeMarker"></div>
                                        <div class="gauge-labels">
                                            <div class="gauge-label negative">Bearish</div>
                                            <div class="gauge-label neutral">Neutral</div>
                                            <div class="gauge-label positive">Bullish</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="source-breakdown">
                                <h3>Sentiment by Source</h3>
                                <div class="source-list" id="sentimentSources">
                                    <!-- Sentiment sources will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sentiment Trend Chart Card -->
                    <div class="card sentiment-trend">
                        <div class="card-header">
                            <h2>Sentiment Trends</h2>
                        </div>
                        <div class="card-body">
                            <div id="sentimentTrendChart" class="chart-container-large">
                                <!-- Sentiment trend chart will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trading Signals Card -->
                    <div class="card trading-signals">
                        <div class="card-header">
                            <h2>Sentiment-Based Trading Signals</h2>
                        </div>
                        <div class="card-body">
                            <div class="signals-intro">
                                Based on current sentiment analysis, the system has generated the following trading signals:
                            </div>
                            
                            <div class="signals-table-wrapper">
                                <table class="signals-table">
                                    <thead>
                                        <tr>
                                            <th>Asset</th>
                                            <th>Signal</th>
                                            <th>Strength</th>
                                            <th>Confidence</th>
                                            <th>Timeframe</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tradingSignalsBody">
                                        <!-- Trading signals will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- News Sentiment Card -->
                    <div class="card news-sentiment">
                        <div class="card-header">
                            <h2>News Sentiment</h2>
                        </div>
                        <div class="card-body">
                            <div class="news-list" id="newsList">
                                <!-- News items will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Social Media Sentiment Card -->
                    <div class="card social-sentiment">
                        <div class="card-header">
                            <h2>Social Media Topics</h2>
                        </div>
                        <div class="card-body">
                            <div class="topics-list" id="topicsList">
                                <!-- Social media topics will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sentiment Correlation Card -->
                    <div class="card sentiment-correlation">
                        <div class="card-header">
                            <h2>Price-Sentiment Correlation</h2>
                        </div>
                        <div class="card-body">
                            <div class="correlation-metrics">
                                <div class="correlation-item">
                                    <div class="correlation-label">7-Day Correlation</div>
                                    <div class="correlation-value" id="correlation7d">--</div>
                                </div>
                                <div class="correlation-item">
                                    <div class="correlation-label">30-Day Correlation</div>
                                    <div class="correlation-value" id="correlation30d">--</div>
                                </div>
                                <div class="correlation-item">
                                    <div class="correlation-label">90-Day Correlation</div>
                                    <div class="correlation-value" id="correlation90d">--</div>
                                </div>
                            </div>
                            
                            <div class="lead-lag-info">
                                <div class="lead-lag-label">Lead/Lag Relationship:</div>
                                <div class="lead-lag-value" id="leadLagValue">--</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% elif active_tab == 'market-regime' %}
                <div id="marketRegimeDashboard" class="dashboard-grid">
                    <!-- Current Regime Card -->
                    <div class="card regime-summary">
                        <div class="card-header">
                            <h2>Current Market Regime</h2>
                            <div class="card-actions">
                                <button class="refresh-button" data-target="marketRegime">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="regime-display">
                                <div class="dominant-regime">
                                    <div class="regime-title">Dominant Regime</div>
                                    <div class="regime-name" id="dominantRegime">Loading...</div>
                                </div>
                                <div class="regime-confidence">
                                    <div class="confidence-title">Confidence</div>
                                    <div class="confidence-gauge" id="regimeConfidenceGauge">
                                        <div class="gauge-value" id="regimeConfidenceValue">--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="regime-probabilities">
                                <h3>Regime Probabilities</h3>
                                <div class="probability-list" id="regimeProbabilities">
                                    <!-- Regime probabilities will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Regime Description Card -->
                    <div class="card regime-description">
                        <div class="card-header">
                            <h2>Regime Characteristics</h2>
                        </div>
                        <div class="card-body">
                            <div id="regimeDescriptionContent">
                                <!-- Regime description will be added here -->
                            </div>
                            
                            <div class="market-indicators" id="marketIndicators">
                                <h3>Market Indicators</h3>
                                <!-- Market indicators will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Strategy Recommendations Card -->
                    <div class="card strategy-recommendations">
                        <div class="card-header">
                            <h2>Strategy Recommendations</h2>
                        </div>
                        <div class="card-body">
                            <div class="strategy-intro" id="strategyIntro">
                                Based on the current <span class="regime-name-inline" id="strategyRegimeName">market regime</span>, the system recommends the following strategies:
                            </div>
                            
                            <div class="strategy-list" id="strategyList">
                                <!-- Strategy recommendations will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Regime Transition Card -->
                    <div class="card regime-transition">
                        <div class="card-header">
                            <h2>Regime Transition Probabilities</h2>
                        </div>
                        <div class="card-body">
                            <div class="transition-intro">
                                Likelihood of transitioning from current dominant regime:
                            </div>
                            
                            <div class="transition-matrix" id="transitionMatrix">
                                <!-- Transition probabilities will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Regime History Chart Card -->
                    <div class="card regime-chart">
                        <div class="card-header">
                            <h2>Regime History</h2>
                        </div>
                        <div class="card-body">
                            <div id="regimeHistoryChart" class="chart-container-large">
                                <!-- Regime history chart will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                {% elif active_tab == 'risk' %}
                <div id="riskManagementDashboard" class="dashboard-grid">
                    <!-- Risk Overview Card -->
                    <div class="card risk-overview">
                        <div class="card-header">
                            <h2>Risk Overview</h2>
                            <div class="card-actions">
                                <button class="refresh-button" data-target="riskOverview">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="risk-meters">
                                <div class="risk-meter">
                                    <div class="meter-label">Risk Capacity Utilization</div>
                                    <div class="meter-container">
                                        <div class="meter-value" id="riskCapacityValue">--</div>
                                        <div class="meter-gauge">
                                            <div class="meter-bar" id="riskCapacityBar"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="risk-meter">
                                    <div class="meter-label">Risk Tolerance Level</div>
                                    <div class="meter-container">
                                        <div class="meter-value" id="riskToleranceValue">--</div>
                                        <div class="meter-gauge">
                                            <div class="meter-bar" id="riskToleranceBar"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="key-risk-metrics">
                                <h3>Key Risk Metrics</h3>
                                <div class="metrics-grid">
                                    <div class="metric-card">
                                        <div class="metric-name">Daily VaR (95%)</div>
                                        <div class="metric-value" id="dailyVaR">--</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-name">Weekly VaR (95%)</div>
                                        <div class="metric-value" id="weeklyVaR">--</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-name">Max Drawdown</div>
                                        <div class="metric-value" id="maxDrawdown">--</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-name">Current Drawdown</div>
                                        <div class="metric-value" id="currentDrawdown">--</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-name">Sharpe Ratio</div>
                                        <div class="metric-value" id="sharpeRatio">--</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-name">Sortino Ratio</div>
                                        <div class="metric-value" id="sortinoRatio">--</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-name">Beta</div>
                                        <div class="metric-value" id="portfolioBeta">--</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-name">Risk-Adjusted Return</div>
                                        <div class="metric-value" id="riskAdjustedReturn">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Risk History Chart Card -->
                    <div class="card risk-history">
                        <div class="card-header">
                            <h2>Risk Metrics History</h2>
                        </div>
                        <div class="card-body">
                            <div id="riskHistoryChart" class="chart-container-large">
                                <!-- Risk history chart will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Asset Risk Card -->
                    <div class="card asset-risk">
                        <div class="card-header">
                            <h2>Asset Risk Exposure</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="data-table risk-table">
                                    <thead>
                                        <tr>
                                            <th>Asset</th>
                                            <th>Weight</th>
                                            <th>Exposure</th>
                                            <th>VaR Contrib</th>
                                            <th>Risk Contrib</th>
                                            <th>Beta</th>
                                            <th>Max DD</th>
                                        </tr>
                                    </thead>
                                    <tbody id="assetRiskTableBody">
                                        <!-- Asset risk rows will be added here -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="exposure-chart-container">
                                <div id="assetExposureChart" class="chart-container">
                                    <!-- Asset exposure chart will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Strategy Risk Allocation Card -->
                    <div class="card strategy-risk">
                        <div class="card-header">
                            <h2>Strategy Risk Allocation</h2>
                        </div>
                        <div class="card-body">
                            <div class="strategy-allocation-chart">
                                <div id="strategyAllocationChart" class="chart-container">
                                    <!-- Strategy allocation chart will be rendered here -->
                                </div>
                            </div>
                            
                            <div class="strategy-table-container">
                                <table class="data-table strategy-risk-table">
                                    <thead>
                                        <tr>
                                            <th>Strategy</th>
                                            <th>Allocation</th>
                                            <th>Usage</th>
                                            <th>VaR Contrib</th>
                                            <th>Sharpe</th>
                                            <th>Max DD</th>
                                        </tr>
                                    </thead>
                                    <tbody id="strategyRiskTableBody">
                                        <!-- Strategy risk rows will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Correlation Matrix Card -->
                    <div class="card correlation-matrix-card">
                        <div class="card-header">
                            <h2>Asset Correlation Matrix</h2>
                        </div>
                        <div class="card-body">
                            <div id="correlationMatrixHeatmap" class="chart-container-large">
                                <!-- Correlation matrix heatmap will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Circuit Breakers Card -->
                    <div class="card circuit-breakers">
                        <div class="card-header">
                            <h2>Risk Circuit Breakers</h2>
                        </div>
                        <div class="card-body">
                            <div class="circuit-breakers-container" id="circuitBreakersContainer">
                                <!-- Circuit breakers will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stress Test Results Card -->
                    <div class="card stress-tests">
                        <div class="card-header">
                            <h2>Stress Test Results</h2>
                        </div>
                        <div class="card-body">
                            <div class="stress-test-container">
                                <table class="data-table stress-test-table">
                                    <thead>
                                        <tr>
                                            <th>Scenario</th>
                                            <th>Portfolio Impact</th>
                                            <th>Max Drawdown</th>
                                            <th>VaR Change</th>
                                            <th>Est. Recovery</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stressTestTableBody">
                                        <!-- Stress test rows will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% elif active_tab == 'performance' %}
                <div id="performanceAnalyticsDashboard" class="dashboard-grid">
                    <!-- Performance Summary Card -->
                    <div class="card performance-summary">
                        <div class="card-header">
                            <h2>Performance Summary</h2>
                            <div class="card-actions">
                                <button class="refresh-button" data-target="performanceAnalytics">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="time-period-selector">
                                <div class="period-tabs" id="performancePeriodTabs">
                                    <button class="period-tab active" data-period="daily">Daily</button>
                                    <button class="period-tab" data-period="weekly">Weekly</button>
                                    <button class="period-tab" data-period="monthly">Monthly</button>
                                    <button class="period-tab" data-period="quarterly">Quarterly</button>
                                    <button class="period-tab" data-period="yearly">Yearly</button>
                                    <button class="period-tab" data-period="all_time">All Time</button>
                                </div>
                            </div>
                            
                            <div class="performance-metrics-grid">
                                <div class="performance-metric-card highlight">
                                    <div class="metric-icon">
                                        <i data-feather="trending-up"></i>
                                    </div>
                                    <div class="metric-data">
                                        <div class="metric-label">Return</div>
                                        <div class="metric-value" id="performanceReturn">--</div>
                                    </div>
                                </div>
                                <div class="performance-metric-card">
                                    <div class="metric-icon">
                                        <i data-feather="activity"></i>
                                    </div>
                                    <div class="metric-data">
                                        <div class="metric-label">Win Rate</div>
                                        <div class="metric-value" id="performanceWinRate">--</div>
                                    </div>
                                </div>
                                <div class="performance-metric-card">
                                    <div class="metric-icon">
                                        <i data-feather="repeat"></i>
                                    </div>
                                    <div class="metric-data">
                                        <div class="metric-label">Trades</div>
                                        <div class="metric-value" id="performanceTrades">--</div>
                                    </div>
                                </div>
                                <div class="performance-metric-card">
                                    <div class="metric-icon">
                                        <i data-feather="dollar-sign"></i>
                                    </div>
                                    <div class="metric-data">
                                        <div class="metric-label">Volume</div>
                                        <div class="metric-value" id="performanceVolume">--</div>
                                    </div>
                                </div>
                                <div class="performance-metric-card">
                                    <div class="metric-icon">
                                        <i data-feather="pie-chart"></i>
                                    </div>
                                    <div class="metric-data">
                                        <div class="metric-label">Profit Factor</div>
                                        <div class="metric-value" id="performanceProfitFactor">--</div>
                                    </div>
                                </div>
                                <div class="performance-metric-card">
                                    <div class="metric-icon">
                                        <i data-feather="arrow-up-circle"></i>
                                    </div>
                                    <div class="metric-data">
                                        <div class="metric-label">Avg Profit</div>
                                        <div class="metric-value" id="performanceAvgProfit">--</div>
                                    </div>
                                </div>
                                <div class="performance-metric-card">
                                    <div class="metric-icon">
                                        <i data-feather="arrow-down-circle"></i>
                                    </div>
                                    <div class="metric-data">
                                        <div class="metric-label">Avg Loss</div>
                                        <div class="metric-value" id="performanceAvgLoss">--</div>
                                    </div>
                                </div>
                                <div class="performance-metric-card">
                                    <div class="metric-icon">
                                        <i data-feather="bar-chart-2"></i>
                                    </div>
                                    <div class="metric-data">
                                        <div class="metric-label">Sharpe Ratio</div>
                                        <div class="metric-value" id="performanceSharpe">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Equity Curve Card -->
                    <div class="card equity-curve">
                        <div class="card-header">
                            <h2>Equity Curve</h2>
                        </div>
                        <div class="card-body">
                            <div id="equityCurveAdvancedChart" class="chart-container-large">
                                <!-- Equity curve chart will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Drawdown Analysis Card -->
                    <div class="card drawdown-analysis">
                        <div class="card-header">
                            <h2>Drawdown Analysis</h2>
                        </div>
                        <div class="card-body">
                            <div id="drawdownChart" class="chart-container">
                                <!-- Drawdown chart will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Strategy Performance Card -->
                    <div class="card strategy-performance">
                        <div class="card-header">
                            <h2>Strategy Performance</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="data-table performance-table">
                                    <thead>
                                        <tr>
                                            <th>Strategy</th>
                                            <th>Return</th>
                                            <th>Win Rate</th>
                                            <th>Trades</th>
                                            <th>Profit Factor</th>
                                            <th>Sharpe</th>
                                            <th>Max DD</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="strategyPerformanceTableBody">
                                        <!-- Strategy performance rows will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Asset Performance Card -->
                    <div class="card asset-performance">
                        <div class="card-header">
                            <h2>Asset Performance</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="data-table performance-table">
                                    <thead>
                                        <tr>
                                            <th>Asset</th>
                                            <th>Return</th>
                                            <th>Win Rate</th>
                                            <th>Trades</th>
                                            <th>Profit Factor</th>
                                            <th>Avg Profit</th>
                                            <th>Avg Loss</th>
                                            <th>Unrealized P&L</th>
                                        </tr>
                                    </thead>
                                    <tbody id="assetPerformanceTableBody">
                                        <!-- Asset performance rows will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trade Distribution Card -->
                    <div class="card trade-distribution">
                        <div class="card-header">
                            <h2>Trade Distribution</h2>
                        </div>
                        <div class="card-body">
                            <div class="distribution-container">
                                <div class="distribution-row">
                                    <div class="distribution-chart-container">
                                        <h3>Time of Day</h3>
                                        <div id="timeOfDayChart" class="chart-container-small"></div>
                                    </div>
                                    <div class="distribution-chart-container">
                                        <h3>Day of Week</h3>
                                        <div id="dayOfWeekChart" class="chart-container-small"></div>
                                    </div>
                                </div>
                                <div class="distribution-row">
                                    <div class="distribution-chart-container">
                                        <h3>Trade Size</h3>
                                        <div id="tradeSizeChart" class="chart-container-small"></div>
                                    </div>
                                    <div class="distribution-chart-container">
                                        <h3>Holding Time</h3>
                                        <div id="holdingTimeChart" class="chart-container-small"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Factors Card -->
                    <div class="card performance-factors">
                        <div class="card-header">
                            <h2>Performance Factors</h2>
                        </div>
                        <div class="card-body">
                            <div class="factors-container">
                                <div class="factor-item">
                                    <div class="factor-name">Volatility Impact</div>
                                    <div class="factor-bar-container">
                                        <div class="factor-bar" id="volatilityFactorBar"></div>
                                    </div>
                                    <div class="factor-value" id="volatilityFactorValue">--</div>
                                </div>
                                <div class="factor-item">
                                    <div class="factor-name">Volume Impact</div>
                                    <div class="factor-bar-container">
                                        <div class="factor-bar" id="volumeFactorBar"></div>
                                    </div>
                                    <div class="factor-value" id="volumeFactorValue">--</div>
                                </div>
                                <div class="factor-item">
                                    <div class="factor-name">Market Hour Impact</div>
                                    <div class="factor-bar-container">
                                        <div class="factor-bar" id="marketHourFactorBar"></div>
                                    </div>
                                    <div class="factor-value" id="marketHourFactorValue">--</div>
                                </div>
                                <div class="factor-item">
                                    <div class="factor-name">News Sentiment Impact</div>
                                    <div class="factor-bar-container">
                                        <div class="factor-bar" id="newsSentimentFactorBar"></div>
                                    </div>
                                    <div class="factor-value" id="newsSentimentFactorValue">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Trades Card -->
                    <div class="card recent-trades-performance">
                        <div class="card-header">
                            <h2>Recent Trades</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="data-table performance-table">
                                    <thead>
                                        <tr>
                                            <th>Asset</th>
                                            <th>Strategy</th>
                                            <th>Side</th>
                                            <th>Entry</th>
                                            <th>Exit</th>
                                            <th>P&L</th>
                                            <th>P&L %</th>
                                            <th>Holding Time</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentTradesPerformanceTableBody">
                                        <!-- Recent trades rows will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="tab-content-placeholder">
                    <div class="placeholder-message">
                        <i data-feather="code"></i>
                        <h2>{{ active_tab|title }} Dashboard</h2>
                        <p>This tab is under development as part of the dashboard redesign.</p>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Footer -->
            <footer class="footer">
                <div class="footer-content">
                    <span class="copyright">© 2025 AI Trading Agent</span>
                    <span class="footer-links">
                        <a href="#" class="footer-link">Documentation</a>
                        <a href="#" class="footer-link">Support</a>
                    </span>
                </div>
            </footer>
        </main>
    </div>
    
    <!-- JavaScript -->
    <script>
        // WebSocket connection and management
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 3000; // 3 seconds
        
        // Update connection status indicator in UI
        function updateConnectionStatus(status) {
            const connectionIndicator = document.getElementById('connectionStatus');
            if (!connectionIndicator) return;
            
            // Remove all status classes
            connectionIndicator.classList.remove('connected', 'disconnected', 'reconnecting', 'failed');
            
            // Add current status class
            connectionIndicator.classList.add(status);
            
            // Update status text
            let statusText = '';
            switch (status) {
                case 'connected':
                    statusText = 'Connected';
                    break;
                case 'disconnected':
                    statusText = 'Disconnected';
                    break;
                case 'reconnecting':
                    statusText = `Reconnecting (${reconnectAttempts})...`;
                    break;
                case 'failed':
                    statusText = 'Connection Failed';
                    break;
                default:
                    statusText = 'Unknown';
            }
            
            connectionIndicator.setAttribute('title', statusText);
        }
        
        // Add manual reconnect button when auto-reconnection fails
        function addManualReconnectButton() {
            const userMenu = document.querySelector('.user-menu');
            if (!userMenu) return;
            
            // Check if button already exists
            if (document.getElementById('reconnectButton')) return;
            
            const reconnectButton = document.createElement('button');
            reconnectButton.id = 'reconnectButton';
            reconnectButton.className = 'reconnect-button';
            reconnectButton.innerHTML = '<i data-feather="refresh-cw"></i> Reconnect';
            reconnectButton.title = 'Manually reconnect to server';
            
            reconnectButton.addEventListener('click', function() {
                // Try to reconnect
                initializeWebSocket();
                this.remove();
            });
            
            userMenu.appendChild(reconnectButton);
            feather.replace();
        }
        
        // Initialize WebSocket connection
        function initializeWebSocket() {
            // If there's an existing socket, clean it up
            if (socket) {
                socket.disconnect();
                socket.close();
            }
            
            // Create socket connection with reconnection options
            socket = io({
                reconnection: true,
                reconnectionAttempts: maxReconnectAttempts,
                reconnectionDelay: reconnectDelay,
                reconnectionDelayMax: 10000,
                timeout: 10000
            });
            
            // Connection events
            socket.on('connect', function() {
                console.log('WebSocket connected');
                showNotification('info', 'Real-time connection established');
                reconnectAttempts = 0; // Reset reconnect attempts on successful connection
                
                // Update connection status indicator
                updateConnectionStatus('connected');
                
                // Subscribe to channels for the active tab
                subscribeToActiveTabChannels();
            });
            
            socket.on('disconnect', function() {
                console.log('WebSocket disconnected');
                showNotification('warning', 'Real-time connection lost');
                
                // Update connection status indicator
                updateConnectionStatus('disconnected');
            });
            
            socket.on('reconnect_attempt', function(attemptNumber) {
                console.log(`Attempting to reconnect (${attemptNumber}/${maxReconnectAttempts})...`);
                reconnectAttempts = attemptNumber;
                
                // Update connection status indicator
                updateConnectionStatus('reconnecting');
            });
            
            socket.on('reconnect', function() {
                console.log('WebSocket reconnected successfully');
                showNotification('success', 'Real-time connection restored');
                
                // Update connection status indicator
                updateConnectionStatus('connected');
            });
            
            socket.on('reconnect_failed', function() {
                console.log('WebSocket reconnection failed');
                showNotification('error', 'Failed to restore real-time connection');
                
                // Update connection status indicator
                updateConnectionStatus('failed');
                
                // Add manual reconnect button
                addManualReconnectButton();
            });
            
            // Subscribe to relevant channels based on active tab
            subscribeToActiveTabChannels();
            
            // Dashboard data update handlers
            socket.on('dashboard_update', function(data) {
                updateDashboardData(data);
            });
            
            socket.on('system_status_update', function(data) {
                updateSystemStatus(data.state);
            });
            
            socket.on('trading_status_update', function(data) {
                updateTradingStatus(data.state);
            });
            
            socket.on('alert', function(data) {
                showNotification(data.type, data.message);
                incrementAlertCount();
            });
        }
        
        // Subscribe to channels based on active tab
        function subscribeToActiveTabChannels() {
            const activeTab = document.querySelector('.tab-button.active');
            if (!activeTab || !socket) return;
            
            const tabId = activeTab.getAttribute('data-tab');
            
            // Unsubscribe from all channels first
            socket.emit('unsubscribe', { channel: 'all' });
            
            // Subscribe to base channels
            socket.emit('subscribe', { channel: 'system_status_update' });
            socket.emit('subscribe', { channel: 'trading_status_update' });
            socket.emit('subscribe', { channel: 'alert' });
            
            // Subscribe to tab-specific channels
            if (tabId === 'overview') {
                socket.emit('subscribe', { channel: 'dashboard_summary' });
            } else if (tabId === 'market-regime') {
                socket.emit('subscribe', { channel: 'market_regime_update' });
            } else if (tabId === 'sentiment') {
                socket.emit('subscribe', { channel: 'sentiment_update' });
            } else if (tabId === 'risk') {
                socket.emit('subscribe', { channel: 'risk_update' });
            } else if (tabId === 'performance') {
                socket.emit('subscribe', { channel: 'performance_update' });
            } else if (tabId === 'logs') {
                socket.emit('subscribe', { channel: 'logs_update' });
            }
        }
        
        // Update dashboard data from WebSocket
        function updateDashboardData(data) {
            if (!data || !data.type) return;
            
            // Handle different types of updates
            switch (data.type) {
                case 'system_health':
                    updateSystemHealthUI(data.data);
                    break;
                case 'component_status':
                    updateComponentStatusUI(data.data);
                    break;
                case 'trading_performance':
                    updateTradingPerformanceUI(data.data);
                    break;
                case 'market_regime':
                    updateMarketRegimeUI(data.data);
                    break;
                case 'sentiment':
                    updateSentimentUI(data.data);
                    break;
                case 'risk_management':
                    updateRiskManagementUI(data.data);
                    break;
                case 'performance_analytics':
                    updatePerformanceAnalyticsUI(data.data);
                    break;
                case 'logs_monitoring':
                    updateLogsMonitoringUI(data.data);
                    break;
                default:
                    console.log('Unknown update type:', data.type);
            }
        }
        
        // Notification System
        const notifications = [];
        let notificationCounter = 0;
        
        // Notification center elements
        const notificationTrigger = document.getElementById('notificationTrigger');
        const notificationCenter = document.getElementById('notificationCenter');
        const notificationOverlay = document.getElementById('notificationOverlay');
        const closeNotificationCenter = document.getElementById('closeNotificationCenter');
        const notificationList = document.getElementById('notificationList');
        const notificationTabs = document.querySelectorAll('.notification-tab');
        const markAllRead = document.getElementById('markAllRead');
        const clearAllNotifications = document.getElementById('clearAllNotifications');
        const notificationSettings = document.getElementById('notificationSettings');
        const notificationToast = document.getElementById('notificationToast');
        const alertCountElement = document.getElementById('alertCount');
        
        // Initialize notification system
        function initializeNotificationSystem() {
            if (notificationTrigger && notificationCenter && notificationOverlay) {
                // Open notification center
                notificationTrigger.addEventListener('click', function() {
                    notificationCenter.classList.add('active');
                    notificationOverlay.classList.add('active');
                    renderNotifications();
                });
                
                // Close notification center
                if (closeNotificationCenter) {
                    closeNotificationCenter.addEventListener('click', function() {
                        notificationCenter.classList.remove('active');
                        notificationOverlay.classList.remove('active');
                    });
                }
                
                if (notificationOverlay) {
                    notificationOverlay.addEventListener('click', function() {
                        notificationCenter.classList.remove('active');
                        notificationOverlay.classList.remove('active');
                    });
                }
                
                // Handle notification tabs
                if (notificationTabs && notificationTabs.length) {
                    notificationTabs.forEach(tab => {
                        tab.addEventListener('click', function() {
                            // Remove active class from all tabs
                            notificationTabs.forEach(t => t.classList.remove('active'));
                            // Add active class to clicked tab
                            this.classList.add('active');
                            // Filter notifications based on tab
                            renderNotifications(this.getAttribute('data-tab'));
                        });
                    });
                }
                
                // Mark all as read
                if (markAllRead) {
                    markAllRead.addEventListener('click', function() {
                        markAllNotificationsAsRead();
                    });
                }
                
                // Clear all notifications
                if (clearAllNotifications) {
                    clearAllNotifications.addEventListener('click', function() {
                        if (confirm('Are you sure you want to clear all notifications?')) {
                            clearNotifications();
                        }
                    });
                }
                
                // Open settings when notification settings button clicked
                if (notificationSettings) {
                    notificationSettings.addEventListener('click', function() {
                        // Close notification center
                        notificationCenter.classList.remove('active');
                        notificationOverlay.classList.remove('active');
                        
                        // Open settings panel to notification section
                        const settingsPanel = document.getElementById('settingsPanel');
                        const settingsOverlay = document.getElementById('settingsOverlay');
                        if (settingsPanel && settingsOverlay) {
                            settingsPanel.classList.add('active');
                            settingsOverlay.classList.add('active');
                            
                            // Scroll to notifications section
                            const notificationsSection = document.querySelector('.settings-section:nth-child(4)');
                            if (notificationsSection) {
                                notificationsSection.scrollIntoView({ behavior: 'smooth' });
                            }
                        }
                    });
                }
                
                // Load notifications from local storage
                loadNotifications();
                updateNotificationCount();
            }
        }
        
        // Show notification toast
        function showNotification(type, message, title = '') {
            if (!title) {
                switch (type) {
                    case 'success': title = 'Success'; break;
                    case 'error': title = 'Error'; break;
                    case 'warning': title = 'Warning'; break;
                    case 'info': title = 'Information'; break;
                    default: title = 'Notification';
                }
            }
            
            // Add notification to list with current timestamp
            addNotification({
                id: ++notificationCounter,
                type: type,
                title: title,
                message: message,
                timestamp: new Date().toISOString(),
                read: false,
                category: type === 'error' ? 'system' : 
                         type === 'success' ? 'trading' : 'alerts'
            });
            
            // Show toast notification
            if (notificationToast) {
                // Clear any existing classes
                notificationToast.className = 'notification-toast';
                // Add type class
                notificationToast.classList.add(type);
                
                // Set content
                const iconElement = notificationToast.querySelector('.notification-toast-icon i');
                const titleElement = notificationToast.querySelector('.notification-toast-title');
                const messageElement = notificationToast.querySelector('.notification-toast-message');
                
                if (iconElement) {
                    // Set appropriate icon based on type
                    iconElement.setAttribute('data-feather', 
                        type === 'success' ? 'check-circle' :
                        type === 'error' ? 'alert-circle' :
                        type === 'warning' ? 'alert-triangle' : 'info'
                    );
                }
                
                if (titleElement) {
                    titleElement.textContent = title;
                }
                
                if (messageElement) {
                    messageElement.textContent = message;
                }
                
                // Update Feather icons
                feather.replace();
                
                // Show toast
                notificationToast.classList.add('active');
                
                // Hide after 5 seconds
                setTimeout(() => {
                    notificationToast.classList.remove('active');
                }, 5000);
                
                // Add click event to close button
                const closeButton = notificationToast.querySelector('.notification-toast-close');
                if (closeButton) {
                    closeButton.addEventListener('click', function() {
                        notificationToast.classList.remove('active');
                    });
                }
            }
        }
        
        // Add notification to the list
        function addNotification(notification) {
            notifications.unshift(notification);
            
            // Save to localStorage
            saveNotifications();
            
            // Update badge count
            updateNotificationCount();
            
            // If notification center is open, refresh the list
            if (notificationCenter.classList.contains('active')) {
                renderNotifications();
            }
        }
        
        // Render notifications in the list
        function renderNotifications(filter = 'all') {
            if (!notificationList) return;
            
            // Clear existing notifications
            notificationList.innerHTML = '';
            
            // Filter notifications based on the selected tab
            const filteredNotifications = filter === 'all' ? 
                notifications : 
                notifications.filter(n => n.category === filter);
            
            // Show empty state if no notifications
            if (filteredNotifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="notification-empty">
                        <i data-feather="bell-off"></i>
                        <p>No notifications yet</p>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            // Add each notification to the list
            filteredNotifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
                notificationItem.setAttribute('data-id', notification.id);
                
                // Set icon based on type
                let icon = 'info';
                if (notification.type === 'success') icon = 'check-circle';
                if (notification.type === 'error') icon = 'alert-circle';
                if (notification.type === 'warning') icon = 'alert-triangle';
                
                // Format timestamp
                const timestamp = new Date(notification.timestamp);
                const timeAgo = getTimeAgo(timestamp);
                
                notificationItem.innerHTML = `
                    <div class="notification-icon ${notification.type}">
                        <i data-feather="${icon}"></i>
                    </div>
                    <div class="notification-details">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${timeAgo}</div>
                    </div>
                `;
                
                // Mark as read when clicked
                notificationItem.addEventListener('click', function() {
                    markNotificationAsRead(notification.id);
                    this.classList.remove('unread');
                });
                
                notificationList.appendChild(notificationItem);
            });
            
            // Update Feather icons
            feather.replace();
        }
        
        // Update notification count badge
        function updateNotificationCount() {
            if (alertCountElement) {
                const unreadCount = notifications.filter(n => !n.read).length;
                alertCountElement.textContent = unreadCount;
                
                // Hide badge if no unread notifications
                if (unreadCount === 0) {
                    alertCountElement.style.display = 'none';
                } else {
                    alertCountElement.style.display = '';
                }
            }
        }
        
        // Mark a notification as read
        function markNotificationAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                
                // Save to localStorage
                saveNotifications();
                
                // Update badge count
                updateNotificationCount();
            }
        }
        
        // Mark all notifications as read
        function markAllNotificationsAsRead() {
            notifications.forEach(notification => {
                notification.read = true;
            });
            
            // Save to localStorage
            saveNotifications();
            
            // Update UI
            document.querySelectorAll('.notification-item').forEach(item => {
                item.classList.remove('unread');
            });
            
            // Update badge count
            updateNotificationCount();
        }
        
        // Clear all notifications
        function clearNotifications() {
            notifications.length = 0;
            
            // Save to localStorage
            saveNotifications();
            
            // Update UI
            renderNotifications();
            updateNotificationCount();
        }
        
        // Save notifications to localStorage
        function saveNotifications() {
            localStorage.setItem('dashboardNotifications', JSON.stringify(notifications));
        }
        
        // Load notifications from localStorage
        function loadNotifications() {
            const saved = localStorage.getItem('dashboardNotifications');
            if (saved) {
                const parsed = JSON.parse(saved);
                notifications.push(...parsed);
                notificationCounter = notifications.length > 0 ? 
                    Math.max(...notifications.map(n => n.id)) : 0;
            }
        }
        
        // Format timestamp as time ago
        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = Math.floor((now - timestamp) / 1000); // difference in seconds
            
            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)} min ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)} days ago`;
            
            // For older notifications, show actual date
            return timestamp.toLocaleDateString();
        }
        
        // Increment alert count
        function incrementAlertCount() {
            const alertCount = document.getElementById('alertCount');
            if (alertCount) {
                alertCount.textContent = (parseInt(alertCount.textContent) || 0) + 1;
            }
        }
        
        // Initialize Feather icons
        // Theme management
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }
        
        function getTheme() {
            return localStorage.getItem('theme') || 'light';
        }
        
        function toggleTheme() {
            const currentTheme = getTheme();
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }
        
        // Performance optimization: Lazy loading for dashboard tabs
        function lazyLoadTabContent(tabId) {
            // Don't reload already loaded tabs
            if (tabId && document.querySelector(`[data-tab="${tabId}"]`).getAttribute('data-loaded') === 'true') {
                return;
            }
            
            // Placeholder data for different tabs
            const tabData = {
                'overview': () => {
                    // Fetch overview data and render it
                    console.log("Lazy loading Overview tab");
                    fetchDashboardSummary();
                },
                'market-regime': () => {
                    // Fetch market regime data and render it
                    console.log("Lazy loading Market Regime tab");
                    fetchMarketRegimeData();
                },
                'sentiment': () => {
                    // Fetch sentiment data and render it
                    console.log("Lazy loading Sentiment Analysis tab");
                    fetchSentimentData();
                },
                'risk': () => {
                    // Fetch risk data and render it
                    console.log("Lazy loading Risk Management tab");
                    fetchRiskManagementData();
                },
                'performance': () => {
                    // Fetch performance data and render it
                    console.log("Lazy loading Performance Analytics tab");
                    fetchPerformanceAnalyticsData();
                },
                'logs': () => {
                    // Fetch logs data and render it
                    console.log("Lazy loading Logs & Monitoring tab");
                    fetchLogsMonitoringData();
                }
            };
            
            // Load the data for the selected tab
            if (tabId && tabData[tabId]) {
                tabData[tabId]();
                document.querySelector(`[data-tab="${tabId}"]`).setAttribute('data-loaded', 'true');
            }
        }
        
        // Data pagination for large datasets
        function paginateData(data, page = 1, pageSize = 10) {
            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            return data.slice(startIndex, endIndex);
        }
        
        // Chunked rendering for large tables
        function renderTableChunked(tableBody, data, rowRenderer, chunkSize = 50) {
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // If data is empty, show a message
            if (!data || data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="100%" class="empty-data">No data available</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            // Render data in chunks to prevent UI freezing
            let index = 0;
            
            function renderChunk() {
                const chunk = data.slice(index, index + chunkSize);
                
                if (chunk.length === 0) {
                    return; // Done rendering
                }
                
                // Create document fragment to minimize DOM operations
                const fragment = document.createDocumentFragment();
                
                // Add rows to fragment
                chunk.forEach(item => {
                    const row = rowRenderer(item);
                    if (row) {
                        fragment.appendChild(row);
                    }
                });
                
                // Append fragment to table
                tableBody.appendChild(fragment);
                
                // Update index for next chunk
                index += chunkSize;
                
                // Schedule next chunk
                if (index < data.length) {
                    setTimeout(renderChunk, 0);
                }
            }
            
            // Start rendering
            renderChunk();
        }
        
        // Debounce function to limit how often a function can be called
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        // Throttle function to limit function calls to once per specified period
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            startClock();
            
            // Initialize WebSocket connection
            initializeWebSocket();
            
            // Apply saved theme
            const savedTheme = getTheme();
            setTheme(savedTheme);
            
            // Theme toggle button
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', toggleTheme);
            }
            
            // Initialize notification system
            initializeNotificationSystem();
            
            // Tab navigation with lazy loading
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            if (tabButtons && tabButtons.length) {
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const tabId = this.getAttribute('data-tab');
                        
                        // Hide all tabs
                        tabContents.forEach(tab => {
                            tab.style.display = 'none';
                        });
                        
                        // Remove active class from all buttons
                        tabButtons.forEach(btn => {
                            btn.classList.remove('active');
                        });
                        
                        // Show the selected tab
                        const selectedTab = document.getElementById(`${tabId}Tab`);
                        if (selectedTab) {
                            selectedTab.style.display = 'block';
                        }
                        
                        // Add active class to clicked button
                        this.classList.add('active');
                        
                        // Lazy load the tab content
                        lazyLoadTabContent(tabId);
                    });
                });
                
                // Load the initial tab (first one or based on saved preference)
                const defaultTab = loadSettings().defaultTab || 'overview';
                const initialTab = document.querySelector(`.tab-button[data-tab="${defaultTab}"]`);
                if (initialTab) {
                    initialTab.click();
                } else if (tabButtons.length > 0) {
                    tabButtons[0].click();
                }
            }
            
            // Mobile sidebar toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    
                    // Create overlay if it doesn't exist
                    let overlay = document.querySelector('.sidebar-overlay');
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.className = 'sidebar-overlay';
                        document.body.appendChild(overlay);
                        
                        // Close sidebar when clicking outside
                        overlay.addEventListener('click', function() {
                            sidebar.classList.remove('active');
                            overlay.classList.remove('active');
                        });
                    }
                    
                    // Toggle overlay
                    overlay.classList.toggle('active');
                });
            }
            
            // Export data panel handling
            const exportDataBtn = document.getElementById('exportDataBtn');
            const closeExport = document.getElementById('closeExport');
            const cancelExport = document.getElementById('cancelExport');
            const exportPanel = document.getElementById('exportPanel');
            const exportOverlay = document.getElementById('exportOverlay');
            const downloadExport = document.getElementById('downloadExport');
            const exportTypeSelect = document.getElementById('exportTypeSelect');
            const customExportOptions = document.getElementById('customExportOptions');
            const dateRangeSelect = document.getElementById('dateRangeSelect');
            const customDateRange = document.getElementById('customDateRange');
            const scheduleExportToggle = document.getElementById('scheduleExportToggle');
            const scheduleOptions = document.getElementById('scheduleOptions');
            
            if (exportDataBtn && exportPanel && exportOverlay) {
                // Open export panel
                exportDataBtn.addEventListener('click', function() {
                    exportPanel.classList.add('active');
                    exportOverlay.classList.add('active');
                    
                    // Set today's date as default for date inputs
                    const today = new Date().toISOString().split('T')[0];
                    const startDateInput = document.getElementById('startDate');
                    const endDateInput = document.getElementById('endDate');
                    
                    if (startDateInput && endDateInput) {
                        startDateInput.value = today;
                        endDateInput.value = today;
                    }
                });
                
                // Close export panel
                if (closeExport) {
                    closeExport.addEventListener('click', function() {
                        exportPanel.classList.remove('active');
                        exportOverlay.classList.remove('active');
                    });
                }
                
                if (cancelExport) {
                    cancelExport.addEventListener('click', function() {
                        exportPanel.classList.remove('active');
                        exportOverlay.classList.remove('active');
                    });
                }
                
                if (exportOverlay) {
                    exportOverlay.addEventListener('click', function() {
                        exportPanel.classList.remove('active');
                        exportOverlay.classList.remove('active');
                    });
                }
                
                // Show/hide custom export options based on export type
                if (exportTypeSelect) {
                    exportTypeSelect.addEventListener('change', function() {
                        if (this.value === 'custom') {
                            customExportOptions.style.display = 'block';
                        } else {
                            customExportOptions.style.display = 'none';
                        }
                    });
                }
                
                // Show/hide custom date range based on date range selection
                if (dateRangeSelect) {
                    dateRangeSelect.addEventListener('change', function() {
                        if (this.value === 'custom') {
                            customDateRange.style.display = 'block';
                        } else {
                            customDateRange.style.display = 'none';
                        }
                    });
                }
                
                // Show/hide schedule options based on schedule toggle
                if (scheduleExportToggle) {
                    scheduleExportToggle.addEventListener('change', function() {
                        if (this.checked) {
                            scheduleOptions.style.display = 'block';
                        } else {
                            scheduleOptions.style.display = 'none';
                        }
                    });
                }
                
                // Handle export download
                if (downloadExport) {
                    downloadExport.addEventListener('click', function() {
                        const exportType = exportTypeSelect.value;
                        const exportFormat = document.getElementById('exportFormatSelect').value;
                        const dateRange = dateRangeSelect.value;
                        
                        // Get data to export based on current selections
                        let exportData = {};
                        
                        switch (exportType) {
                            case 'current':
                                // Get data from the current tab
                                const activeTab = document.querySelector('.tab-button.active');
                                if (activeTab) {
                                    const tabId = activeTab.getAttribute('data-tab');
                                    exportData = getExportDataForTab(tabId);
                                }
                                break;
                                
                            case 'custom':
                                // Get data from selected checkboxes
                                exportData = getCustomExportData();
                                break;
                                
                            case 'full':
                                // Get all dashboard data
                                exportData = getAllDashboardData();
                                break;
                        }
                        
                        // Process date range
                        const dateRangeInfo = getDateRangeData(dateRange);
                        
                        // Prepare final export data
                        const finalExportData = {
                            data: exportData,
                            metadata: {
                                exportDate: new Date().toISOString(),
                                dateRange: dateRangeInfo,
                                format: exportFormat
                            }
                        };
                        
                        // Schedule export if enabled
                        if (scheduleExportToggle.checked) {
                            scheduleExport(finalExportData);
                        }
                        
                        // Download the data
                        downloadData(finalExportData, exportFormat);
                        
                        // Close the panel
                        exportPanel.classList.remove('active');
                        exportOverlay.classList.remove('active');
                        
                        showNotification('success', 'Data exported successfully');
                    });
                }
            }
            
            // Helper function to get export data for a specific tab
            function getExportDataForTab(tabId) {
                // In a real implementation, this would get the data from the backend
                // For now, we'll use some placeholder data
                const data = {};
                
                switch (tabId) {
                    case 'overview':
                        data.systemHealth = { /* get system health data */ };
                        data.tradingPerformance = { /* get trading performance data */ };
                        break;
                        
                    case 'market-regime':
                        data.marketRegime = { /* get market regime data */ };
                        break;
                        
                    case 'sentiment':
                        data.sentiment = { /* get sentiment data */ };
                        break;
                        
                    case 'risk':
                        data.riskManagement = { /* get risk management data */ };
                        break;
                        
                    case 'performance':
                        data.performanceAnalytics = { /* get performance analytics data */ };
                        break;
                        
                    case 'logs':
                        data.logsMonitoring = { /* get logs monitoring data */ };
                        break;
                }
                
                return data;
            }
            
            // Helper function to get custom export data based on selected checkboxes
            function getCustomExportData() {
                const data = {};
                
                if (document.getElementById('exportSystemHealth').checked) {
                    data.systemHealth = { /* get system health data */ };
                }
                
                if (document.getElementById('exportTradingPerformance').checked) {
                    data.tradingPerformance = { /* get trading performance data */ };
                }
                
                if (document.getElementById('exportMarketRegime').checked) {
                    data.marketRegime = { /* get market regime data */ };
                }
                
                if (document.getElementById('exportSentiment').checked) {
                    data.sentiment = { /* get sentiment data */ };
                }
                
                if (document.getElementById('exportPositions').checked) {
                    data.positions = { /* get positions data */ };
                }
                
                if (document.getElementById('exportRecentTrades').checked) {
                    data.recentTrades = { /* get recent trades data */ };
                }
                
                if (document.getElementById('exportLogs').checked) {
                    data.logs = { /* get logs data */ };
                }
                
                if (document.getElementById('exportPerformanceMetrics').checked) {
                    data.performanceMetrics = { /* get performance metrics data */ };
                }
                
                return data;
            }
            
            // Helper function to get all dashboard data
            function getAllDashboardData() {
                // In a real implementation, this would get all data from the backend
                return {
                    systemHealth: { /* get system health data */ },
                    tradingPerformance: { /* get trading performance data */ },
                    marketRegime: { /* get market regime data */ },
                    sentiment: { /* get sentiment data */ },
                    positions: { /* get positions data */ },
                    recentTrades: { /* get recent trades data */ },
                    logs: { /* get logs data */ },
                    performanceMetrics: { /* get performance metrics data */ }
                };
            }
            
            // Helper function to get date range data
            function getDateRangeData(rangeType) {
                const now = new Date();
                let startDate, endDate;
                
                switch (rangeType) {
                    case 'today':
                        startDate = new Date(now);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = now;
                        break;
                        
                    case 'yesterday':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 1);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = new Date(now);
                        endDate.setDate(endDate.getDate() - 1);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    case 'last7days':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 7);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = now;
                        break;
                        
                    case 'last30days':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 30);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = now;
                        break;
                        
                    case 'custom':
                        startDate = new Date(document.getElementById('startDate').value);
                        endDate = new Date(document.getElementById('endDate').value);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                        
                    default:
                        startDate = new Date(now);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = now;
                }
                
                return {
                    start: startDate.toISOString(),
                    end: endDate.toISOString()
                };
            }
            
            // Helper function to download data
            function downloadData(data, format) {
                let content, filename, contentType;
                
                // Format data based on selected format
                switch (format) {
                    case 'json':
                        content = JSON.stringify(data, null, 2);
                        filename = `dashboard_export_${formatDateForFilename(new Date())}.json`;
                        contentType = 'application/json';
                        break;
                        
                    case 'csv':
                        content = convertToCSV(data);
                        filename = `dashboard_export_${formatDateForFilename(new Date())}.csv`;
                        contentType = 'text/csv';
                        break;
                        
                    case 'excel':
                        // In a real implementation, you would use a library to create Excel files
                        // For now, we'll just use CSV as a placeholder
                        content = convertToCSV(data);
                        filename = `dashboard_export_${formatDateForFilename(new Date())}.csv`;
                        contentType = 'text/csv';
                        break;
                        
                    case 'pdf':
                        // In a real implementation, you would use a library to create PDF files
                        // For now, we'll show a notification instead
                        showNotification('info', 'PDF export would be generated here');
                        return;
                        
                    default:
                        content = JSON.stringify(data, null, 2);
                        filename = `dashboard_export_${formatDateForFilename(new Date())}.json`;
                        contentType = 'application/json';
                }
                
                // Create download link
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            
            // Helper function to format date for filenames
            function formatDateForFilename(date) {
                return date.toISOString().replace(/[:.]/g, '-').replace('T', '_').split('Z')[0];
            }
            
            // Helper function to convert data to CSV
            function convertToCSV(data) {
                // Simplified implementation for demo
                // In a real implementation, you would use a library or more robust solution
                const headers = Object.keys(data).join(',');
                const values = Object.values(data).map(v => JSON.stringify(v)).join(',');
                return `${headers}\n${values}`;
            }
            
            // Helper function to schedule an export
            function scheduleExport(exportConfig) {
                const frequency = document.getElementById('scheduleFrequencySelect').value;
                const email = document.getElementById('emailRecipients').value;
                
                // In a real implementation, this would send a request to the server to schedule the export
                console.log('Scheduling export:', { frequency, email, exportConfig });
                
                showNotification('info', `Export scheduled: ${frequency} to ${email}`);
            }
            
            // Settings panel handling
            const openSettingsBtn = document.getElementById('openSettingsBtn');
            const closeSettings = document.getElementById('closeSettings');
            const settingsPanel = document.getElementById('settingsPanel');
            const settingsOverlay = document.getElementById('settingsOverlay');
            const saveSettings = document.getElementById('saveSettings');
            const resetSettings = document.getElementById('resetSettings');
            
            // Default settings
            const defaultSettings = {
                theme: 'light',
                density: 'comfortable',
                animations: true,
                defaultTab: 'overview',
                layout: 'grid',
                visibleCards: {
                    systemHealth: true,
                    tradingPerformance: true,
                    marketRegime: true,
                    sentiment: true,
                    positions: true,
                    recentTrades: true
                },
                refreshRate: 30000,
                dataSource: 'mock',
                timeFormat: '24h',
                notifications: {
                    enabled: true,
                    sounds: true,
                    types: {
                        system: true,
                        trades: true,
                        market: true,
                        alerts: true
                    }
                }
            };
            
            // Load settings from localStorage
            function loadSettings() {
                const savedSettings = localStorage.getItem('dashboardSettings');
                if (savedSettings) {
                    return JSON.parse(savedSettings);
                }
                return defaultSettings;
            }
            
            // Save settings to localStorage
            function saveSettingsToStorage(settings) {
                localStorage.setItem('dashboardSettings', JSON.stringify(settings));
            }
            
            // Apply settings to UI
            function applySettings(settings) {
                // Theme
                setTheme(settings.theme);
                
                // Density
                document.body.classList.toggle('density-compact', settings.density === 'compact');
                
                // Animations
                document.body.classList.toggle('no-animations', !settings.animations);
                
                // Update form values
                document.getElementById('themeSelect').value = settings.theme;
                document.getElementById('densitySelect').value = settings.density;
                document.getElementById('animationsToggle').checked = settings.animations;
                document.getElementById('defaultTab').value = settings.defaultTab;
                document.getElementById('layoutSelect').value = settings.layout;
                document.getElementById('refreshRateSelect').value = settings.refreshRate.toString();
                document.getElementById('dataSourceSelect').value = settings.dataSource;
                document.getElementById('timeFormatSelect').value = settings.timeFormat;
                
                // Checkboxes
                document.getElementById('showSystemHealth').checked = settings.visibleCards.systemHealth;
                document.getElementById('showTradingPerformance').checked = settings.visibleCards.tradingPerformance;
                document.getElementById('showMarketRegime').checked = settings.visibleCards.marketRegime;
                document.getElementById('showSentiment').checked = settings.visibleCards.sentiment;
                document.getElementById('showPositions').checked = settings.visibleCards.positions;
                document.getElementById('showRecentTrades').checked = settings.visibleCards.recentTrades;
                
                document.getElementById('notificationsToggle').checked = settings.notifications.enabled;
                document.getElementById('alertSoundToggle').checked = settings.notifications.sounds;
                document.getElementById('notifySystem').checked = settings.notifications.types.system;
                document.getElementById('notifyTrades').checked = settings.notifications.types.trades;
                document.getElementById('notifyMarket').checked = settings.notifications.types.market;
                document.getElementById('notifyAlerts').checked = settings.notifications.types.alerts;
                
                // Apply visible cards
                Object.keys(settings.visibleCards).forEach(card => {
                    const visible = settings.visibleCards[card];
                    const cardElements = document.querySelectorAll(`.card[data-card="${card}"]`);
                    cardElements.forEach(el => {
                        el.style.display = visible ? '' : 'none';
                    });
                });
                
                // Apply layout type
                const dashboardGrids = document.querySelectorAll('.dashboard-grid');
                dashboardGrids.forEach(grid => {
                    grid.classList.toggle('layout-list', settings.layout === 'list');
                });
            }
            
            // Get current settings from form
            function getFormSettings() {
                return {
                    theme: document.getElementById('themeSelect').value,
                    density: document.getElementById('densitySelect').value,
                    animations: document.getElementById('animationsToggle').checked,
                    defaultTab: document.getElementById('defaultTab').value,
                    layout: document.getElementById('layoutSelect').value,
                    visibleCards: {
                        systemHealth: document.getElementById('showSystemHealth').checked,
                        tradingPerformance: document.getElementById('showTradingPerformance').checked,
                        marketRegime: document.getElementById('showMarketRegime').checked,
                        sentiment: document.getElementById('showSentiment').checked,
                        positions: document.getElementById('showPositions').checked,
                        recentTrades: document.getElementById('showRecentTrades').checked
                    },
                    refreshRate: parseInt(document.getElementById('refreshRateSelect').value),
                    dataSource: document.getElementById('dataSourceSelect').value,
                    timeFormat: document.getElementById('timeFormatSelect').value,
                    notifications: {
                        enabled: document.getElementById('notificationsToggle').checked,
                        sounds: document.getElementById('alertSoundToggle').checked,
                        types: {
                            system: document.getElementById('notifySystem').checked,
                            trades: document.getElementById('notifyTrades').checked,
                            market: document.getElementById('notifyMarket').checked,
                            alerts: document.getElementById('notifyAlerts').checked
                        }
                    }
                };
            }
            
            if (openSettingsBtn && settingsPanel && settingsOverlay) {
                // Load and apply saved settings
                const currentSettings = loadSettings();
                applySettings(currentSettings);
                
                // Open settings panel
                openSettingsBtn.addEventListener('click', function() {
                    settingsPanel.classList.add('active');
                    settingsOverlay.classList.add('active');
                });
                
                // Close settings panel
                closeSettings.addEventListener('click', function() {
                    settingsPanel.classList.remove('active');
                    settingsOverlay.classList.remove('active');
                });
                
                settingsOverlay.addEventListener('click', function() {
                    settingsPanel.classList.remove('active');
                    settingsOverlay.classList.remove('active');
                });
                
                // Save settings
                saveSettings.addEventListener('click', function() {
                    const newSettings = getFormSettings();
                    saveSettingsToStorage(newSettings);
                    applySettings(newSettings);
                    
                    settingsPanel.classList.remove('active');
                    settingsOverlay.classList.remove('active');
                    
                    showNotification('success', 'Settings saved successfully');
                });
                
                // Reset settings
                resetSettings.addEventListener('click', function() {
                    if (confirm('Are you sure you want to reset all settings to defaults?')) {
                        saveSettingsToStorage(defaultSettings);
                        applySettings(defaultSettings);
                        
                        settingsPanel.classList.remove('active');
                        settingsOverlay.classList.remove('active');
                        
                        showNotification('info', 'Settings reset to defaults');
                    }
                });
            }
            
            // Initialize guided tour if it's the user's first visit
            const hasSeenTour = localStorage.getItem('hasSeenTour');
            if (!hasSeenTour) {
                // Show the tour button
                showTourButton();
            }
            
            // Initialize the dashboard if we're on the overview tab
            if (document.getElementById('overviewDashboard')) {
                initializeDashboard();
            }
            
            // Initialize market regime dashboard if we're on that tab
            if (document.getElementById('marketRegimeDashboard')) {
                initializeMarketRegimeDashboard();
            }
            
            // Initialize sentiment dashboard if we're on that tab
            if (document.getElementById('sentimentDashboard')) {
                initializeSentimentDashboard();
            }
            
            // Initialize risk management dashboard if we're on that tab
            if (document.getElementById('riskManagementDashboard')) {
                initializeRiskManagementDashboard();
            }
            
            // Initialize performance analytics dashboard if we're on that tab
            if (document.getElementById('performanceAnalyticsDashboard')) {
                console.log("Initializing Performance Analytics Dashboard");
                initializePerformanceAnalyticsDashboard();
            }
            
            // Initialize logs & monitoring dashboard if we're on that tab
            if (document.getElementById('logsMonitoringDashboard')) {
                console.log("Initializing Logs & Monitoring Dashboard");
                initializeLogsMonitoringDashboard();
            }
            
            // System control button handlers
            setupSystemControls();
        });
        
        // Clock display
        function startClock() {
            const timeDisplay = document.getElementById('currentTime');
            
            function updateTime() {
                const now = new Date();
                timeDisplay.textContent = now.toLocaleTimeString();
            }
            
            updateTime();
            setInterval(updateTime, 1000);
        }
        
        // Dashboard initialization
        function initializeDashboard() {
            // Fetch initial data
            fetchSystemHealth();
            fetchComponentStatus();
            fetchTradingPerformance();
            fetchCurrentPositions();
            fetchRecentTrades();
            fetchSystemAlerts();
            fetchEquityCurve();
            
            // Setup refresh buttons
            document.querySelectorAll('.refresh-button').forEach(button => {
                button.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    
                    switch(target) {
                        case 'systemOverview':
                            fetchSystemHealth();
                            fetchComponentStatus();
                            break;
                        case 'pnlSummary':
                            fetchTradingPerformance();
                            fetchEquityCurve();
                            break;
                        case 'currentPositions':
                            fetchCurrentPositions();
                            break;
                        case 'recentTrades':
                            fetchRecentTrades();
                            break;
                        case 'systemAlerts':
                            fetchSystemAlerts();
                            break;
                    }
                    
                    // Show loading animation
                    this.classList.add('refreshing');
                    setTimeout(() => {
                        this.classList.remove('refreshing');
                    }, 500);
                });
            });
        }
        
        // Setup system control buttons
        function setupSystemControls() {
            // Start system button
            const startButton = document.getElementById('startSystem');
            if (startButton) {
                startButton.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    
                    fetch('/api/system/start', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateSystemStatus('running');
                        } else {
                            console.error('Failed to start system:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error starting system:', error);
                    });
                });
            }
            
            // Stop system button
            const stopButton = document.getElementById('stopSystem');
            if (stopButton) {
                stopButton.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    
                    fetch('/api/system/stop', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateSystemStatus('stopped');
                            updateTradingStatus('disabled');
                        } else {
                            console.error('Failed to stop system:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error stopping system:', error);
                    });
                });
            }
            
            // Enable trading button
            const enableTradingButton = document.getElementById('enableTrading');
            if (enableTradingButton) {
                enableTradingButton.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    
                    fetch('/api/trading/enable', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateTradingStatus('enabled');
                        } else {
                            console.error('Failed to enable trading:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error enabling trading:', error);
                    });
                });
            }
            
            // Disable trading button
            const disableTradingButton = document.getElementById('disableTrading');
            if (disableTradingButton) {
                disableTradingButton.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    
                    fetch('/api/trading/disable', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateTradingStatus('disabled');
                        } else {
                            console.error('Failed to disable trading:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error disabling trading:', error);
                    });
                });
            }
            
            // Mode buttons
            const modeButtons = document.querySelectorAll('.mode-button');
            if (modeButtons.length) {
                modeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const mode = this.getAttribute('data-mode');
                        
                        fetch('/api/system/mode', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ mode: mode })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Update active mode button
                                modeButtons.forEach(btn => btn.classList.remove('active'));
                                this.classList.add('active');
                            } else {
                                console.error('Failed to set mode:', data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error setting mode:', error);
                        });
                    });
                });
            }
            
            // Data source switching
            const dataSourceButtons = document.querySelectorAll('.data-source-button');
            if (dataSourceButtons.length) {
                dataSourceButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const source = this.getAttribute('data-source');
                        
                        fetch('/api/system/data-source', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ source: source })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Update active data source button
                                dataSourceButtons.forEach(btn => btn.classList.remove('active'));
                                this.classList.add('active');
                                
                                // Update data source status indicator
                                updateDataSourceStatus(source);
                                
                                // Refresh all dashboard data
                                refreshAllDashboardData();
                            } else {
                                console.error('Failed to set data source:', data.message);
                                showNotification('error', `Failed to switch data source: ${data.message}`);
                            }
                        })
                        .catch(error => {
                            console.error('Error setting data source:', error);
                            showNotification('error', 'Error switching data source');
                        });
                    });
                });
            }
        }
        
        // Update data source status UI
        function updateDataSourceStatus(source) {
            const statusIndicator = document.querySelector('.data-source-status .status-indicator');
            const statusText = document.querySelector('.data-source-status .status-text');
            
            if (statusIndicator && statusText) {
                // Remove all source classes
                statusIndicator.classList.remove('mock', 'real');
                // Add the current source class
                statusIndicator.classList.add(source);
                // Update text
                statusText.textContent = source.charAt(0).toUpperCase() + source.slice(1);
            }
        }
        
        // Refresh all dashboard data
        function refreshAllDashboardData() {
            // Depending on the active tab, refresh the relevant data
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab) {
                const tabId = activeTab.getAttribute('data-tab');
                
                if (tabId === 'overview') {
                    fetchDashboardSummary();
                } else if (tabId === 'market-regime') {
                    fetchMarketRegimeData();
                } else if (tabId === 'sentiment') {
                    fetchSentimentData();
                } else if (tabId === 'risk') {
                    fetchRiskManagementData();
                } else if (tabId === 'performance') {
                    fetchPerformanceAnalyticsData();
                } else if (tabId === 'logs') {
                    fetchLogsMonitoringData();
                }
            }
        }
        
        // Update system status UI
        function updateSystemStatus(state) {
            const statusIndicator = document.querySelector('.system-status .status-indicator');
            const statusText = document.querySelector('.system-status .status-text');
            const startButton = document.getElementById('startSystem');
            const stopButton = document.getElementById('stopSystem');
            const enableTradingButton = document.getElementById('enableTrading');
            
            if (statusIndicator && statusText) {
                // Remove all state classes
                statusIndicator.classList.remove('stopped', 'starting', 'running', 'stopping', 'error');
                // Add the current state class
                statusIndicator.classList.add(state);
                // Update text
                statusText.textContent = state.charAt(0).toUpperCase() + state.slice(1);
            }
            
            if (startButton && stopButton) {
                if (state === 'running') {
                    startButton.classList.add('disabled');
                    stopButton.classList.remove('disabled');
                    if (enableTradingButton) {
                        enableTradingButton.classList.remove('disabled');
                    }
                } else if (state === 'stopped') {
                    startButton.classList.remove('disabled');
                    stopButton.classList.add('disabled');
                    if (enableTradingButton) {
                        enableTradingButton.classList.add('disabled');
                    }
                } else {
                    // For transitional states
                    startButton.classList.add('disabled');
                    stopButton.classList.add('disabled');
                    if (enableTradingButton) {
                        enableTradingButton.classList.add('disabled');
                    }
                }
            }
        }
        
        // Update trading status UI
        function updateTradingStatus(state) {
            const statusIndicator = document.querySelector('.trading-status .status-indicator');
            const statusText = document.querySelector('.trading-status .status-text');
            const enableButton = document.getElementById('enableTrading');
            const disableButton = document.getElementById('disableTrading');
            
            if (statusIndicator && statusText) {
                // Remove all state classes
                statusIndicator.classList.remove('enabled', 'disabled', 'paused');
                // Add the current state class
                statusIndicator.classList.add(state);
                // Update text
                statusText.textContent = state.charAt(0).toUpperCase() + state.slice(1);
            }
            
            if (enableButton && disableButton) {
                if (state === 'enabled') {
                    enableButton.classList.add('disabled');
                    disableButton.classList.remove('disabled');
                } else {
                    enableButton.classList.remove('disabled');
                    disableButton.classList.add('disabled');
                }
            }
        }
        
        // Fetch system health data
        function fetchSystemHealth() {
            fetch('/api/dashboard/health')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('cpuUsage').textContent = data.cpu_usage + '%';
                    document.getElementById('memoryUsage').textContent = data.memory_usage + '%';
                    document.getElementById('diskUsage').textContent = data.disk_usage + '%';
                    document.getElementById('networkLatency').textContent = data.network_latency + 'ms';
                })
                .catch(error => {
                    console.error('Error fetching system health:', error);
                });
        }
        
        // Fetch component status data
        function fetchComponentStatus() {
            fetch('/api/dashboard/components')
                .then(response => response.json())
                .then(components => {
                    const componentList = document.getElementById('componentList');
                    componentList.innerHTML = '';
                    
                    components.forEach(component => {
                        const componentItem = document.createElement('div');
                        componentItem.className = `component-item ${component.status}`;
                        componentItem.innerHTML = `
                            <div class="component-name">${component.name}</div>
                            <div class="component-status-indicator"></div>
                            <div class="component-message">${component.message}</div>
                        `;
                        componentList.appendChild(componentItem);
                    });
                })
                .catch(error => {
                    console.error('Error fetching component status:', error);
                });
        }
        
        // Fetch trading performance data
        function fetchTradingPerformance() {
            fetch('/api/dashboard/performance')
                .then(response => response.json())
                .then(data => {
                    // Update P&L values
                    document.getElementById('dailyPnl').textContent = formatCurrency(data.daily_pnl);
                    document.getElementById('weeklyPnl').textContent = formatCurrency(data.weekly_pnl);
                    document.getElementById('monthlyPnl').textContent = formatCurrency(data.monthly_pnl);
                    document.getElementById('ytdPnl').textContent = formatCurrency(data.ytd_pnl);
                    document.getElementById('realizedPnl').textContent = formatCurrency(data.realized_pnl);
                    document.getElementById('unrealizedPnl').textContent = formatCurrency(data.unrealized_pnl);
                    document.getElementById('winRate').textContent = data.win_rate.toFixed(1) + '%';
                    document.getElementById('bestTrade').textContent = formatCurrency(data.best_trade);
                    
                    // Apply color styling based on value
                    applyPnlColor('dailyPnl', data.daily_pnl);
                    applyPnlColor('weeklyPnl', data.weekly_pnl);
                    applyPnlColor('monthlyPnl', data.monthly_pnl);
                    applyPnlColor('ytdPnl', data.ytd_pnl);
                    applyPnlColor('realizedPnl', data.realized_pnl);
                    applyPnlColor('unrealizedPnl', data.unrealized_pnl);
                })
                .catch(error => {
                    console.error('Error fetching trading performance:', error);
                });
        }
        
        // Apply PnL coloring
        function applyPnlColor(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.remove('positive', 'negative', 'neutral');
                if (value > 0) {
                    element.classList.add('positive');
                } else if (value < 0) {
                    element.classList.add('negative');
                } else {
                    element.classList.add('neutral');
                }
            }
        }
        
        // Fetch current positions data
        function fetchCurrentPositions() {
            fetch('/api/dashboard/positions')
                .then(response => response.json())
                .then(positions => {
                    const tableBody = document.getElementById('positionsTableBody');
                    tableBody.innerHTML = '';
                    
                    if (positions.length === 0) {
                        const emptyRow = document.createElement('tr');
                        emptyRow.innerHTML = `<td colspan="7" class="empty-message">No positions currently open</td>`;
                        tableBody.appendChild(emptyRow);
                        return;
                    }
                    
                    positions.forEach(position => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${position.asset}</td>
                            <td>${position.quantity}</td>
                            <td>${formatCurrency(position.entry_price)}</td>
                            <td>${formatCurrency(position.current_price)}</td>
                            <td>${formatCurrency(position.current_value)}</td>
                            <td class="${position.profit_loss > 0 ? 'positive' : position.profit_loss < 0 ? 'negative' : 'neutral'}">
                                ${formatCurrency(position.profit_loss)}
                            </td>
                            <td class="${position.profit_loss_pct > 0 ? 'positive' : position.profit_loss_pct < 0 ? 'negative' : 'neutral'}">
                                ${formatPercentage(position.profit_loss_pct)}
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching current positions:', error);
                });
        }
        
        // Fetch recent trades data
        function fetchRecentTrades() {
            fetch('/api/dashboard/trades')
                .then(response => response.json())
                .then(trades => {
                    const tableBody = document.getElementById('tradesTableBody');
                    tableBody.innerHTML = '';
                    
                    if (trades.length === 0) {
                        const emptyRow = document.createElement('tr');
                        emptyRow.innerHTML = `<td colspan="7" class="empty-message">No recent trades</td>`;
                        tableBody.appendChild(emptyRow);
                        return;
                    }
                    
                    trades.forEach(trade => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${trade.timestamp}</td>
                            <td>${trade.asset}</td>
                            <td class="${trade.side}">
                                <span class="trade-side">${trade.side.toUpperCase()}</span>
                            </td>
                            <td>${formatCurrency(trade.price)}</td>
                            <td>${trade.quantity}</td>
                            <td>${formatCurrency(trade.value)}</td>
                            <td class="${trade.profit_loss > 0 ? 'positive' : trade.profit_loss < 0 ? 'negative' : 'neutral'}">
                                ${trade.profit_loss ? formatCurrency(trade.profit_loss) : '-'}
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching recent trades:', error);
                });
        }
        
        // Fetch system alerts data
        function fetchSystemAlerts() {
            fetch('/api/dashboard/alerts')
                .then(response => response.json())
                .then(alerts => {
                    const alertsList = document.getElementById('alertsList');
                    alertsList.innerHTML = '';
                    
                    if (alerts.length === 0) {
                        alertsList.innerHTML = '<div class="empty-message">No alerts</div>';
                        return;
                    }
                    
                    alerts.forEach(alert => {
                        const alertItem = document.createElement('div');
                        alertItem.className = `alert-item ${alert.type}`;
                        alertItem.innerHTML = `
                            <div class="alert-time">${alert.timestamp}</div>
                            <div class="alert-message">${alert.message}</div>
                            <div class="alert-actions">
                                <button class="alert-action acknowledge" title="Acknowledge">
                                    <i data-feather="check"></i>
                                </button>
                            </div>
                        `;
                        alertsList.appendChild(alertItem);
                    });
                    
                    // Re-initialize feather icons for the new elements
                    feather.replace();
                    
                    // Update alert count
                    document.getElementById('alertCount').textContent = alerts.length;
                })
                .catch(error => {
                    console.error('Error fetching system alerts:', error);
                });
        }
        
        // Fetch equity curve data and render chart
        function fetchEquityCurve() {
            fetch('/api/dashboard/equity-curve')
                .then(response => response.json())
                .then(data => {
                    const chartContainer = document.getElementById('equityCurveChart');
                    if (!chartContainer) return;
                    
                    const trace = {
                        x: data.dates,
                        y: data.equity,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Equity',
                        line: {
                            color: '#3B82F6',
                            width: 2
                        }
                    };
                    
                    const layout = {
                        title: 'Equity Curve',
                        height: 200,
                        margin: {
                            l: 40,
                            r: 10,
                            t: 30,
                            b: 30
                        },
                        xaxis: {
                            showgrid: false
                        },
                        yaxis: {
                            title: 'Equity',
                            tickformat: '$,.0f'
                        }
                    };
                    
                    Plotly.newPlot('equityCurveChart', [trace], layout, {responsive: true});
                })
                .catch(error => {
                    console.error('Error fetching equity curve data:', error);
                });
        }
        
        // Format currency with $ sign and commas
        function formatCurrency(value) {
            const sign = value < 0 ? '-' : '';
            const absValue = Math.abs(value);
            return sign + '$' + absValue.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        // Format percentage with % sign
        function formatPercentage(value) {
            const sign = value > 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }
        
        // Market Regime Dashboard Initialization
        function initializeMarketRegimeDashboard() {
            fetchMarketRegimeData();
            
            // Setup refresh button
            const refreshButton = document.querySelector('.refresh-button[data-target="marketRegime"]');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    fetchMarketRegimeData();
                    
                    // Show loading animation
                    this.classList.add('refreshing');
                    setTimeout(() => {
                        this.classList.remove('refreshing');
                    }, 500);
                });
            }
        }
        
        // Fetch market regime data
        function fetchMarketRegimeData() {
            fetch('/api/dashboard/market-regime')
                .then(response => response.json())
                .then(data => {
                    updateDominantRegime(data);
                    updateRegimeProbabilities(data.regimes);
                    updateRegimeDescription(data);
                    updateMarketIndicators(data.market_indicators);
                    updateStrategyRecommendations(data);
                    updateTransitionMatrix(data.transition_matrix, data.dominant_regime);
                    renderRegimeHistoryChart(data.regime_time_series);
                })
                .catch(error => {
                    console.error('Error fetching market regime data:', error);
                });
        }
        
        // Update dominant regime display
        function updateDominantRegime(data) {
            const dominantRegimeElement = document.getElementById('dominantRegime');
            if (dominantRegimeElement) {
                dominantRegimeElement.textContent = data.dominant_regime;
                dominantRegimeElement.className = 'regime-name ' + data.dominant_regime.toLowerCase().replace(/\s+/g, '-');
            }
            
            // Update confidence gauge
            const confidenceValue = document.getElementById('regimeConfidenceValue');
            if (confidenceValue) {
                const topRegime = data.regimes[0];
                const confidence = topRegime.probability.toFixed(1);
                confidenceValue.textContent = confidence + '%';
                
                // Set gauge style based on confidence level
                const gauge = document.getElementById('regimeConfidenceGauge');
                if (gauge) {
                    gauge.style.setProperty('--confidence-value', confidence + '%');
                    
                    // Set color based on confidence level
                    if (confidence >= 70) {
                        gauge.className = 'confidence-gauge high-confidence';
                    } else if (confidence >= 50) {
                        gauge.className = 'confidence-gauge medium-confidence';
                    } else {
                        gauge.className = 'confidence-gauge low-confidence';
                    }
                }
            }
            
            // Update strategy intro text
            const strategyRegimeName = document.getElementById('strategyRegimeName');
            if (strategyRegimeName) {
                strategyRegimeName.textContent = data.dominant_regime;
                strategyRegimeName.className = 'regime-name-inline ' + data.dominant_regime.toLowerCase().replace(/\s+/g, '-');
            }
        }
        
        // Update regime probabilities
        function updateRegimeProbabilities(regimes) {
            const probabilitiesContainer = document.getElementById('regimeProbabilities');
            if (!probabilitiesContainer) return;
            
            probabilitiesContainer.innerHTML = '';
            
            regimes.forEach(regime => {
                const regimeItem = document.createElement('div');
                regimeItem.className = 'probability-item';
                
                const regimeClass = regime.name.toLowerCase().replace(/\s+/g, '-');
                
                regimeItem.innerHTML = `
                    <div class="regime-info">
                        <div class="regime-name ${regimeClass}">${regime.name}</div>
                    </div>
                    <div class="probability-bar-container">
                        <div class="probability-bar ${regimeClass}" style="width: ${regime.probability}%"></div>
                        <div class="probability-value">${regime.probability.toFixed(1)}%</div>
                    </div>
                `;
                
                probabilitiesContainer.appendChild(regimeItem);
            });
        }
        
        // Update regime description
        function updateRegimeDescription(data) {
            const descriptionContainer = document.getElementById('regimeDescriptionContent');
            if (!descriptionContainer) return;
            
            // Find the dominant regime details
            const dominantRegimeDetails = data.regimes.find(r => r.name === data.dominant_regime);
            if (!dominantRegimeDetails) return;
            
            descriptionContainer.innerHTML = `
                <div class="regime-description-text">
                    <p>${dominantRegimeDetails.description}</p>
                </div>
                <div class="regime-indicators">
                    <h3>Key Indicators</h3>
                    <ul class="indicator-list">
                        <li><strong>Price Action:</strong> ${dominantRegimeDetails.indicators.price_action}</li>
                        <li><strong>Volatility:</strong> ${dominantRegimeDetails.indicators.volatility}</li>
                        <li><strong>Volume:</strong> ${dominantRegimeDetails.indicators.volume}</li>
                    </ul>
                </div>
            `;
        }
        
        // Update market indicators
        function updateMarketIndicators(indicators) {
            const indicatorsContainer = document.getElementById('marketIndicators');
            if (!indicatorsContainer) return;
            
            // Clear existing content
            indicatorsContainer.innerHTML = '<h3>Market Indicators</h3>';
            
            const indicatorGrid = document.createElement('div');
            indicatorGrid.className = 'indicator-grid';
            
            // Create indicators
            const volatilityIndicator = createGaugeIndicator('Volatility', indicators.volatility, 100, '%');
            const volumeIndicator = createGaugeIndicator('Volume', indicators.volume, 200, '%');
            const sentimentIndicator = createRangeIndicator('Sentiment', indicators.sentiment, -1, 1);
            const momentumIndicator = createRangeIndicator('Momentum', indicators.momentum, -1, 1);
            const trendStrengthIndicator = createGaugeIndicator('Trend Strength', indicators.trend_strength, 100, '%');
            
            // Add indicators to grid
            indicatorGrid.appendChild(volatilityIndicator);
            indicatorGrid.appendChild(volumeIndicator);
            indicatorGrid.appendChild(sentimentIndicator);
            indicatorGrid.appendChild(momentumIndicator);
            indicatorGrid.appendChild(trendStrengthIndicator);
            
            indicatorsContainer.appendChild(indicatorGrid);
        }
        
        // Create gauge indicator
        function createGaugeIndicator(name, value, max, unit) {
            const container = document.createElement('div');
            container.className = 'indicator-item';
            
            const percentage = (value / max) * 100;
            
            // Determine color based on value
            let colorClass = 'neutral';
            if (name === 'Volatility' || name === 'Volume') {
                if (value > max * 0.7) colorClass = 'high';
                else if (value > max * 0.3) colorClass = 'medium';
                else colorClass = 'low';
            } else if (name === 'Trend Strength') {
                if (value > max * 0.7) colorClass = 'high';
                else if (value > max * 0.3) colorClass = 'medium';
                else colorClass = 'low';
            }
            
            container.innerHTML = `
                <div class="indicator-name">${name}</div>
                <div class="gauge-container">
                    <div class="gauge-bar ${colorClass}" style="width: ${percentage}%"></div>
                </div>
                <div class="indicator-value ${colorClass}">${value}${unit}</div>
            `;
            
            return container;
        }
        
        // Create range indicator (for values between -1 and 1)
        function createRangeIndicator(name, value, min, max) {
            const container = document.createElement('div');
            container.className = 'indicator-item range-indicator';
            
            const range = max - min;
            const percentage = ((value - min) / range) * 100;
            
            // Determine color based on value
            let colorClass = 'neutral';
            if (value > 0.33) colorClass = 'positive';
            else if (value < -0.33) colorClass = 'negative';
            
            container.innerHTML = `
                <div class="indicator-name">${name}</div>
                <div class="range-container">
                    <div class="range-negative"></div>
                    <div class="range-neutral"></div>
                    <div class="range-positive"></div>
                    <div class="range-marker ${colorClass}" style="left: ${percentage}%"></div>
                </div>
                <div class="indicator-value ${colorClass}">${value > 0 ? '+' : ''}${value.toFixed(2)}</div>
            `;
            
            return container;
        }
        
        // Update strategy recommendations
        function updateStrategyRecommendations(data) {
            const strategyList = document.getElementById('strategyList');
            if (!strategyList) return;
            
            strategyList.innerHTML = '';
            
            data.strategy_recommendations.forEach(strategy => {
                const strategyItem = document.createElement('div');
                strategyItem.className = 'strategy-item';
                
                // Determine performance color
                let performanceClass = 'neutral';
                if (strategy.performance > 10) performanceClass = 'very-positive';
                else if (strategy.performance > 0) performanceClass = 'positive';
                else if (strategy.performance < -10) performanceClass = 'very-negative';
                else if (strategy.performance < 0) performanceClass = 'negative';
                
                strategyItem.innerHTML = `
                    <div class="strategy-header">
                        <div class="strategy-name">${strategy.name}</div>
                        <div class="strategy-allocation">Allocation: ${strategy.allocation}%</div>
                    </div>
                    <div class="strategy-description">${strategy.description}</div>
                    <div class="strategy-metrics">
                        <div class="strategy-performance ${performanceClass}">
                            <span class="metric-label">Performance</span>
                            <span class="metric-value">${strategy.performance > 0 ? '+' : ''}${strategy.performance}%</span>
                        </div>
                        <div class="strategy-sharpe">
                            <span class="metric-label">Sharpe</span>
                            <span class="metric-value">${strategy.sharpe}</span>
                        </div>
                    </div>
                `;
                
                strategyList.appendChild(strategyItem);
            });
        }
        
        // Update transition matrix
        function updateTransitionMatrix(matrix, dominantRegime) {
            const matrixContainer = document.getElementById('transitionMatrix');
            if (!matrixContainer) return;
            
            matrixContainer.innerHTML = '';
            
            // Determine which matrix to use based on dominant regime
            let transitionProbs;
            switch (dominantRegime) {
                case 'Bull Market':
                    transitionProbs = matrix.from_bull;
                    break;
                case 'Bear Market':
                    transitionProbs = matrix.from_bear;
                    break;
                case 'Sideways Market':
                    transitionProbs = matrix.from_sideways;
                    break;
                case 'Volatile Market':
                    transitionProbs = matrix.from_volatile;
                    break;
                default:
                    return;
            }
            
            // Create transition items
            const createTransitionItem = (toRegime, probability) => {
                const item = document.createElement('div');
                item.className = 'transition-item';
                
                const toClass = toRegime.toLowerCase().replace(/\s+/g, '-').replace('to-', '');
                
                // Determine probability class
                let probClass = 'low-prob';
                if (probability >= 0.5) probClass = 'high-prob';
                else if (probability >= 0.2) probClass = 'medium-prob';
                
                item.innerHTML = `
                    <div class="transition-regime ${toClass}">${toRegime.replace('to_', 'To ')}</div>
                    <div class="transition-probability ${probClass}">${(probability * 100).toFixed(1)}%</div>
                    <div class="probability-bar-container">
                        <div class="probability-bar ${toClass} ${probClass}" style="width: ${probability * 100}%"></div>
                    </div>
                `;
                
                return item;
            };
            
            // Add transition items to container
            Object.entries(transitionProbs).forEach(([toRegime, probability]) => {
                const transitionItem = createTransitionItem(toRegime, probability);
                matrixContainer.appendChild(transitionItem);
            });
        }
        
        // Render regime history chart
        function renderRegimeHistoryChart(timeSeriesData) {
            const chartContainer = document.getElementById('regimeHistoryChart');
            if (!chartContainer) return;
            
            const traces = [
                {
                    x: timeSeriesData.dates,
                    y: timeSeriesData.bull_probs,
                    name: 'Bull Market',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tozeroy',
                    stackgroup: 'regime',
                    line: {
                        color: 'rgba(16, 185, 129, 0.8)',  // Green
                        width: 2
                    },
                    fillcolor: 'rgba(16, 185, 129, 0.2)'
                },
                {
                    x: timeSeriesData.dates,
                    y: timeSeriesData.bear_probs,
                    name: 'Bear Market',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tozeroy',
                    stackgroup: 'regime',
                    line: {
                        color: 'rgba(239, 68, 68, 0.8)',  // Red
                        width: 2
                    },
                    fillcolor: 'rgba(239, 68, 68, 0.2)'
                },
                {
                    x: timeSeriesData.dates,
                    y: timeSeriesData.sideways_probs,
                    name: 'Sideways Market',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tozeroy',
                    stackgroup: 'regime',
                    line: {
                        color: 'rgba(59, 130, 246, 0.8)',  // Blue
                        width: 2
                    },
                    fillcolor: 'rgba(59, 130, 246, 0.2)'
                },
                {
                    x: timeSeriesData.dates,
                    y: timeSeriesData.volatile_probs,
                    name: 'Volatile Market',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tozeroy',
                    stackgroup: 'regime',
                    line: {
                        color: 'rgba(245, 158, 11, 0.8)',  // Amber
                        width: 2
                    },
                    fillcolor: 'rgba(245, 158, 11, 0.2)'
                }
            ];
            
            const layout = {
                title: 'Market Regime Probabilities Over Time',
                height: 400,
                margin: {
                    l: 40,
                    r: 10,
                    t: 40,
                    b: 40
                },
                legend: {
                    orientation: 'h',
                    y: -0.2
                },
                yaxis: {
                    title: 'Probability',
                    range: [0, 1]
                },
                xaxis: {
                    title: 'Date'
                },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('regimeHistoryChart', traces, layout, {responsive: true});
        }
        
        // Sentiment Dashboard Initialization
        function initializeSentimentDashboard() {
            fetchSentimentData();
            
            // Setup refresh button
            const refreshButton = document.querySelector('.refresh-button[data-target="sentimentOverview"]');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    fetchSentimentData();
                    
                    // Show loading animation
                    this.classList.add('refreshing');
                    setTimeout(() => {
                        this.classList.remove('refreshing');
                    }, 500);
                });
            }
        }
        
        // Fetch sentiment data
        function fetchSentimentData() {
            fetch('/api/dashboard/sentiment')
                .then(response => response.json())
                .then(data => {
                    updateOverallSentiment(data);
                    updateSentimentSources(data.sources);
                    updateTradingSignals(data.signals);
                    updateNewsItems(data.news_items);
                    updateSocialTopics(data.topics);
                    updateSentimentCorrelation(data.correlation, data.lead_lag);
                    renderSentimentTrendChart(data.time_series);
                })
                .catch(error => {
                    console.error('Error fetching sentiment data:', error);
                });
        }
        
        // Update overall sentiment display
        function updateOverallSentiment(data) {
            const scoreElement = document.getElementById('overallSentimentScore');
            if (scoreElement) {
                // Format sentiment score as percentage
                const sentimentPercent = Math.round((data.overall_score + 1) * 50);
                scoreElement.textContent = sentimentPercent + '%';
                
                // Apply class based on sentiment
                scoreElement.className = 'sentiment-score ' + data.sentiment_class;
            }
            
            // Update gauge marker position
            const marker = document.getElementById('sentimentGaugeMarker');
            if (marker) {
                // Convert sentiment score (-1 to 1) to percentage (0 to 100)
                const markerPosition = ((data.overall_score + 1) / 2) * 100;
                marker.style.left = markerPosition + '%';
                
                // Apply class based on sentiment
                marker.className = 'gauge-marker ' + data.sentiment_class;
            }
        }
        
        // Update sentiment sources breakdown
        function updateSentimentSources(sources) {
            const sourcesContainer = document.getElementById('sentimentSources');
            if (!sourcesContainer) return;
            
            sourcesContainer.innerHTML = '';
            
            sources.forEach(source => {
                const sourceItem = document.createElement('div');
                sourceItem.className = 'source-item';
                
                // Determine sentiment class
                let sentimentClass = 'neutral';
                if (source.score > 0.1) sentimentClass = 'positive';
                else if (source.score < -0.1) sentimentClass = 'negative';
                
                // Format sentiment score as percentage
                const sentimentPercent = Math.round((source.score + 1) * 50);
                
                sourceItem.innerHTML = `
                    <div class="source-header">
                        <div class="source-name">${source.name}</div>
                        <div class="source-weight">${Math.round(source.weight * 100)}%</div>
                    </div>
                    <div class="sentiment-bar-container">
                        <div class="sentiment-bar-center"></div>
                        <div class="sentiment-bar ${sentimentClass}" style="width: ${Math.abs(source.score) * 50}%; ${source.score < 0 ? 'right: 50%; left: auto;' : 'left: 50%;'}"></div>
                    </div>
                    <div class="source-score ${sentimentClass}">${sentimentPercent}%</div>
                `;
                
                // Add item to container
                sourcesContainer.appendChild(sourceItem);
                
                // Add dropdown with components for each source
                if (source.components && source.components.length > 0) {
                    const componentsContainer = document.createElement('div');
                    componentsContainer.className = 'source-components';
                    
                    source.components.forEach(component => {
                        const componentItem = document.createElement('div');
                        componentItem.className = 'component-item';
                        
                        // Determine sentiment class for component
                        let componentClass = 'neutral';
                        if (component.score > 0.1) componentClass = 'positive';
                        else if (component.score < -0.1) componentClass = 'negative';
                        
                        // Format component score as percentage
                        const componentPercent = Math.round((component.score + 1) * 50);
                        
                        componentItem.innerHTML = `
                            <div class="component-name">${component.name}</div>
                            <div class="component-score ${componentClass}">${componentPercent}%</div>
                        `;
                        
                        componentsContainer.appendChild(componentItem);
                    });
                    
                    // Add components to source item
                    sourceItem.appendChild(componentsContainer);
                }
            });
        }
        
        // Update trading signals
        function updateTradingSignals(signals) {
            const signalsTable = document.getElementById('tradingSignalsBody');
            if (!signalsTable) return;
            
            signalsTable.innerHTML = '';
            
            signals.forEach(signal => {
                const row = document.createElement('tr');
                
                // Determine signal class
                let signalClass = 'neutral';
                if (signal.signal === 'BUY') signalClass = 'buy';
                else if (signal.signal === 'SELL') signalClass = 'sell';
                
                // Create stars for strength
                const stars = '★'.repeat(signal.strength) + '☆'.repeat(5 - signal.strength);
                
                row.innerHTML = `
                    <td>${signal.asset}</td>
                    <td class="${signalClass}">${signal.signal}</td>
                    <td class="signal-strength">${stars}</td>
                    <td>${signal.confidence}%</td>
                    <td>${signal.timeframe}</td>
                `;
                
                signalsTable.appendChild(row);
            });
        }
        
        // Update news items
        function updateNewsItems(newsItems) {
            const newsContainer = document.getElementById('newsList');
            if (!newsContainer) return;
            
            newsContainer.innerHTML = '';
            
            newsItems.forEach(item => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                
                newsItem.innerHTML = `
                    <div class="news-header">
                        <div class="news-source">${item.source}</div>
                        <div class="news-time">${item.timestamp}</div>
                    </div>
                    <div class="news-headline">${item.headline}</div>
                    <div class="news-sentiment ${item.sentiment_class}">
                        <span class="sentiment-label">${item.sentiment_label}</span>
                        <span class="sentiment-value">${Math.round((item.sentiment + 1) * 50)}%</span>
                    </div>
                `;
                
                newsContainer.appendChild(newsItem);
            });
        }
        
        // Update social media topics
        function updateSocialTopics(topics) {
            const topicsContainer = document.getElementById('topicsList');
            if (!topicsContainer) return;
            
            topicsContainer.innerHTML = '';
            
            topics.forEach(topic => {
                const topicItem = document.createElement('div');
                topicItem.className = 'topic-item';
                
                // Determine sentiment class
                let sentimentClass = 'neutral';
                if (topic.sentiment > 0.1) sentimentClass = 'positive';
                else if (topic.sentiment < -0.1) sentimentClass = 'negative';
                
                // Format sentiment score as percentage
                const sentimentPercent = Math.round((topic.sentiment + 1) * 50);
                
                // Calculate relative size of bubble based on volume
                const bubbleSize = 40 + Math.round(topic.volume / 2);
                
                topicItem.innerHTML = `
                    <div class="topic-bubble ${sentimentClass}" style="width: ${bubbleSize}px; height: ${bubbleSize}px;">
                        <span class="topic-volume">${topic.volume}</span>
                    </div>
                    <div class="topic-details">
                        <div class="topic-name">${topic.name}</div>
                        <div class="topic-sentiment ${sentimentClass}">${sentimentPercent}%</div>
                    </div>
                `;
                
                topicsContainer.appendChild(topicItem);
            });
        }
        
        // Update sentiment correlation data
        function updateSentimentCorrelation(correlation, leadLag) {
            // Update correlation values
            document.getElementById('correlation7d').textContent = correlation['7d'];
            document.getElementById('correlation30d').textContent = correlation['30d'];
            document.getElementById('correlation90d').textContent = correlation['90d'];
            
            // Apply color classes based on correlation strength
            applyCorrelationClass('correlation7d', correlation['7d']);
            applyCorrelationClass('correlation30d', correlation['30d']);
            applyCorrelationClass('correlation90d', correlation['90d']);
            
            // Update lead/lag relationship
            document.getElementById('leadLagValue').textContent = leadLag;
        }
        
        // Apply correlation color class
        function applyCorrelationClass(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.classList.remove('strong-positive', 'positive', 'neutral', 'negative', 'strong-negative');
            
            if (value >= 0.7) element.classList.add('strong-positive');
            else if (value >= 0.3) element.classList.add('positive');
            else if (value <= -0.7) element.classList.add('strong-negative');
            else if (value <= -0.3) element.classList.add('negative');
            else element.classList.add('neutral');
        }
        
        // Render sentiment trend chart
        function renderSentimentTrendChart(timeSeriesData) {
            const chartContainer = document.getElementById('sentimentTrendChart');
            if (!chartContainer) return;
            
            const traces = [
                {
                    x: timeSeriesData.dates,
                    y: timeSeriesData.overall,
                    name: 'Overall',
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'rgba(59, 130, 246, 1)',  // Blue
                        width: 3
                    }
                },
                {
                    x: timeSeriesData.dates,
                    y: timeSeriesData.social,
                    name: 'Social Media',
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'rgba(245, 158, 11, 1)',  // Amber
                        width: 2,
                        dash: 'dot'
                    }
                },
                {
                    x: timeSeriesData.dates,
                    y: timeSeriesData.news,
                    name: 'News',
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'rgba(16, 185, 129, 1)',  // Green
                        width: 2,
                        dash: 'dash'
                    }
                },
                {
                    x: timeSeriesData.dates,
                    y: timeSeriesData.onchain,
                    name: 'On-Chain',
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'rgba(139, 92, 246, 1)',  // Purple
                        width: 2,
                        dash: 'dashdot'
                    }
                }
            ];
            
            const layout = {
                title: 'Sentiment Analysis Over Time',
                height: 400,
                margin: {
                    l: 40,
                    r: 10,
                    t: 40,
                    b: 40
                },
                legend: {
                    orientation: 'h',
                    y: -0.2
                },
                yaxis: {
                    title: 'Sentiment (-1 to 1)',
                    range: [-1, 1],
                    zeroline: true,
                    zerolinecolor: '#6B7280',
                    zerolinewidth: 1
                },
                xaxis: {
                    title: 'Date'
                },
                hovermode: 'x unified',
                shapes: [
                    {
                        type: 'line',
                        x0: timeSeriesData.dates[0],
                        y0: 0,
                        x1: timeSeriesData.dates[timeSeriesData.dates.length - 1],
                        y1: 0,
                        line: {
                            color: '#6B7280',
                            width: 1,
                            dash: 'dot'
                        }
                    }
                ]
            };
            
            Plotly.newPlot('sentimentTrendChart', traces, layout, {responsive: true});
        }
        
        // Risk Management Dashboard Initialization
        function initializeRiskManagementDashboard() {
            fetchRiskManagementData();
            
            // Setup refresh button
            const refreshButton = document.querySelector('.refresh-button[data-target="riskOverview"]');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    fetchRiskManagementData();
                    
                    // Show loading animation
                    this.classList.add('refreshing');
                    setTimeout(() => {
                        this.classList.remove('refreshing');
                    }, 500);
                });
            }
        }
        
        // Fetch risk management data
        function fetchRiskManagementData() {
            fetch('/api/dashboard/risk')
                .then(response => response.json())
                .then(data => {
                    updateRiskMeters(data.portfolio_risk);
                    updateKeyRiskMetrics(data.portfolio_risk);
                    updateAssetRiskTable(data.asset_risk);
                    updateStrategyRiskTable(data.strategy_risk);
                    updateCircuitBreakers(data.circuit_breakers);
                    updateStressTests(data.stress_tests);
                    renderRiskHistoryChart(data.risk_time_series);
                    renderAssetExposureChart(data.asset_risk);
                    renderStrategyAllocationChart(data.strategy_risk);
                    renderCorrelationMatrixHeatmap(data.correlation_matrix);
                })
                .catch(error => {
                    console.error('Error fetching risk management data:', error);
                });
        }
        
        // Update risk capacity and tolerance meters
        function updateRiskMeters(portfolioRisk) {
            // Update risk capacity
            const capacityValue = document.getElementById('riskCapacityValue');
            const capacityBar = document.getElementById('riskCapacityBar');
            
            if (capacityValue && capacityBar) {
                capacityValue.textContent = portfolioRisk.risk_capacity.toFixed(1) + '%';
                capacityBar.style.width = portfolioRisk.risk_capacity + '%';
                
                // Set color based on capacity level
                if (portfolioRisk.risk_capacity > 85) {
                    capacityBar.style.backgroundColor = 'var(--error)';
                } else if (portfolioRisk.risk_capacity > 70) {
                    capacityBar.style.backgroundColor = 'var(--warning)';
                } else {
                    capacityBar.style.backgroundColor = 'var(--secondary)';
                }
            }
            
            // Update risk tolerance
            const toleranceValue = document.getElementById('riskToleranceValue');
            const toleranceBar = document.getElementById('riskToleranceBar');
            
            if (toleranceValue && toleranceBar) {
                toleranceValue.textContent = portfolioRisk.risk_tolerance.toFixed(1) + '%';
                toleranceBar.style.width = portfolioRisk.risk_tolerance + '%';
                
                // Set color based on tolerance level
                if (portfolioRisk.risk_tolerance > 85) {
                    toleranceBar.style.backgroundColor = 'var(--error)';
                } else if (portfolioRisk.risk_tolerance > 70) {
                    toleranceBar.style.backgroundColor = 'var(--warning)';
                } else {
                    toleranceBar.style.backgroundColor = 'var(--secondary)';
                }
            }
        }
        
        // Update key risk metrics
        function updateKeyRiskMetrics(portfolioRisk) {
            document.getElementById('dailyVaR').textContent = portfolioRisk.var_daily.toFixed(2) + '%';
            document.getElementById('weeklyVaR').textContent = portfolioRisk.var_weekly.toFixed(2) + '%';
            document.getElementById('maxDrawdown').textContent = portfolioRisk.max_drawdown.toFixed(2) + '%';
            document.getElementById('currentDrawdown').textContent = portfolioRisk.current_drawdown.toFixed(2) + '%';
            document.getElementById('sharpeRatio').textContent = portfolioRisk.sharpe_ratio.toFixed(2);
            document.getElementById('sortinoRatio').textContent = portfolioRisk.sortino_ratio.toFixed(2);
            document.getElementById('portfolioBeta').textContent = portfolioRisk.beta.toFixed(2);
            
            const riskAdjustedReturn = document.getElementById('riskAdjustedReturn');
            riskAdjustedReturn.textContent = (portfolioRisk.risk_adjusted_return > 0 ? '+' : '') + 
                                             portfolioRisk.risk_adjusted_return.toFixed(2) + '%';
            
            // Set color based on value
            riskAdjustedReturn.className = 'metric-value';
            if (portfolioRisk.risk_adjusted_return > 0) {
                riskAdjustedReturn.classList.add('positive');
            } else if (portfolioRisk.risk_adjusted_return < 0) {
                riskAdjustedReturn.classList.add('negative');
            }
        }
        
        // Update asset risk table
        function updateAssetRiskTable(assetRisk) {
            const tableBody = document.getElementById('assetRiskTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            assetRisk.forEach(asset => {
                const row = document.createElement('tr');
                
                // Determine exposure level class
                let exposureClass = 'low';
                if (asset.exposure > 30) {
                    exposureClass = 'high';
                } else if (asset.exposure > 15) {
                    exposureClass = 'medium';
                }
                
                row.innerHTML = `
                    <td><strong>${asset.asset}</strong></td>
                    <td>${asset.weight.toFixed(1)}%</td>
                    <td class="exposure-cell">
                        <div class="exposure-bar ${exposureClass}" style="width: ${Math.min(100, asset.exposure * 2)}%"></div>
                        <div class="exposure-value">${asset.exposure.toFixed(1)}%</div>
                    </td>
                    <td>${asset.var_contrib.toFixed(2)}%</td>
                    <td>${asset.risk_contrib.toFixed(1)}%</td>
                    <td>${asset.beta.toFixed(2)}</td>
                    <td>${asset.max_drawdown.toFixed(1)}%</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Update strategy risk table
        function updateStrategyRiskTable(strategyRisk) {
            const tableBody = document.getElementById('strategyRiskTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            strategyRisk.forEach(strategy => {
                const row = document.createElement('tr');
                
                // Determine usage level class
                let usageClass = 'normal';
                if (strategy.current_usage > 100) {
                    usageClass = 'over';
                } else if (strategy.current_usage > 85) {
                    usageClass = 'high';
                }
                
                row.innerHTML = `
                    <td><strong>${strategy.strategy}</strong></td>
                    <td>${strategy.allocation.toFixed(1)}%</td>
                    <td class="usage-cell">
                        <div class="usage-bar ${usageClass}" style="width: ${Math.min(100, strategy.current_usage)}%"></div>
                        <div class="usage-value">${strategy.current_usage.toFixed(1)}%</div>
                    </td>
                    <td>${strategy.var_contrib.toFixed(2)}%</td>
                    <td>${strategy.sharpe.toFixed(2)}</td>
                    <td>${strategy.max_drawdown.toFixed(1)}%</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Update circuit breakers
        function updateCircuitBreakers(circuitBreakers) {
            const container = document.getElementById('circuitBreakersContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            circuitBreakers.forEach(breaker => {
                const breakerElement = document.createElement('div');
                breakerElement.className = `circuit-breaker ${breaker.status}`;
                
                breakerElement.innerHTML = `
                    <div class="circuit-breaker-header">
                        <div class="circuit-breaker-name">${breaker.name}</div>
                        <div class="circuit-breaker-status">${breaker.status.toUpperCase()}</div>
                    </div>
                    <div class="circuit-breaker-details">
                        <div class="circuit-breaker-threshold">
                            <span class="circuit-breaker-threshold-label">Threshold:</span>
                            <span class="circuit-breaker-threshold-value">${breaker.threshold}</span>
                        </div>
                        <div class="circuit-breaker-current">
                            <span class="circuit-breaker-current-label">Current:</span>
                            <span class="circuit-breaker-current-value">${breaker.current}</span>
                        </div>
                    </div>
                    <div class="circuit-breaker-action">
                        <span class="action-label">Action: </span>
                        <span class="action-text">${breaker.action}</span>
                    </div>
                `;
                
                container.appendChild(breakerElement);
            });
        }
        
        // Update stress tests
        function updateStressTests(stressTests) {
            const tableBody = document.getElementById('stressTestTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            stressTests.forEach(test => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td><strong>${test.scenario}</strong></td>
                    <td class="impact-negative">${test.portfolio_impact.toFixed(1)}%</td>
                    <td>${test.max_drawdown.toFixed(1)}%</td>
                    <td>${test.var_change.toFixed(1)}%</td>
                    <td>${test.recovery_time}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Render risk history chart
        function renderRiskHistoryChart(timeSeriesData) {
            const chartContainer = document.getElementById('riskHistoryChart');
            if (!chartContainer) return;
            
            const traces = [
                {
                    x: timeSeriesData.dates,
                    y: timeSeriesData.var,
                    name: 'Daily VaR',
                    type: 'scatter',
                    mode: 'lines',
                    yaxis: 'y',
                    line: {
                        color: 'rgba(239, 68, 68, 0.8)',  // Red
                        width: 2
                    }
                },
                {
                    x: timeSeriesData.dates,
                    y: timeSeriesData.drawdown,
                    name: 'Drawdown',
                    type: 'scatter',
                    mode: 'lines',
                    yaxis: 'y',
                    line: {
                        color: 'rgba(245, 158, 11, 0.8)',  // Amber
                        width: 2
                    }
                },
                {
                    x: timeSeriesData.dates,
                    y: timeSeriesData.exposure,
                    name: 'Exposure',
                    type: 'scatter',
                    mode: 'lines',
                    yaxis: 'y2',
                    line: {
                        color: 'rgba(59, 130, 246, 0.8)',  // Blue
                        width: 2
                    }
                }
            ];
            
            const layout = {
                title: 'Risk Metrics History',
                height: 400,
                margin: {
                    l: 50,
                    r: 50,
                    t: 40,
                    b: 40
                },
                legend: {
                    orientation: 'h',
                    y: -0.2
                },
                yaxis: {
                    title: 'VaR & Drawdown (%)',
                    titlefont: {color: 'rgba(239, 68, 68, 0.8)'},
                    tickfont: {color: 'rgba(239, 68, 68, 0.8)'},
                    side: 'left',
                    range: [0, Math.max(...timeSeriesData.drawdown) * 1.2]
                },
                yaxis2: {
                    title: 'Exposure (%)',
                    titlefont: {color: 'rgba(59, 130, 246, 0.8)'},
                    tickfont: {color: 'rgba(59, 130, 246, 0.8)'},
                    side: 'right',
                    overlaying: 'y',
                    range: [0, 100]
                },
                xaxis: {
                    title: 'Date'
                },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('riskHistoryChart', traces, layout, {responsive: true});
        }
        
        // Render asset exposure chart
        function renderAssetExposureChart(assetRisk) {
            const chartContainer = document.getElementById('assetExposureChart');
            if (!chartContainer) return;
            
            // Sort assets by exposure
            const sortedAssets = [...assetRisk].sort((a, b) => b.exposure - a.exposure);
            
            // Get top 6 assets for visibility
            const assets = sortedAssets.slice(0, 6);
            
            const data = [{
                type: 'bar',
                x: assets.map(a => a.asset),
                y: assets.map(a => a.exposure),
                marker: {
                    color: assets.map(a => {
                        if (a.exposure > 30) return 'rgba(239, 68, 68, 0.7)';  // Red
                        if (a.exposure > 15) return 'rgba(245, 158, 11, 0.7)';  // Amber
                        return 'rgba(16, 185, 129, 0.7)';  // Green
                    })
                }
            }];
            
            const layout = {
                title: 'Asset Exposure',
                height: 250,
                margin: {
                    l: 40,
                    r: 10,
                    t: 40,
                    b: 40
                },
                yaxis: {
                    title: 'Exposure (%)',
                    range: [0, Math.max(...assets.map(a => a.exposure)) * 1.2]
                }
            };
            
            Plotly.newPlot('assetExposureChart', data, layout, {responsive: true});
        }
        
        // Render strategy allocation chart
        function renderStrategyAllocationChart(strategyRisk) {
            const chartContainer = document.getElementById('strategyAllocationChart');
            if (!chartContainer) return;
            
            const data = [{
                type: 'pie',
                labels: strategyRisk.map(s => s.strategy),
                values: strategyRisk.map(s => s.allocation),
                textinfo: 'label+percent',
                insidetextorientation: 'radial',
                marker: {
                    colors: [
                        'rgba(59, 130, 246, 0.7)',   // Blue
                        'rgba(16, 185, 129, 0.7)',   // Green
                        'rgba(139, 92, 246, 0.7)',   // Purple
                        'rgba(245, 158, 11, 0.7)',   // Amber
                        'rgba(236, 72, 153, 0.7)'    // Pink
                    ]
                }
            }];
            
            const layout = {
                title: 'Strategy Allocation',
                height: 250,
                margin: {
                    l: 10,
                    r: 10,
                    t: 40,
                    b: 10
                }
            };
            
            Plotly.newPlot('strategyAllocationChart', data, layout, {responsive: true});
        }
        
        // Render correlation matrix heatmap
        function renderCorrelationMatrixHeatmap(correlationMatrix) {
            const chartContainer = document.getElementById('correlationMatrixHeatmap');
            if (!chartContainer) return;
            
            // Convert matrix to the format needed for heatmap
            const assets = Object.keys(correlationMatrix);
            
            // Create z-values (correlation values)
            const zValues = [];
            
            for (const asset1 of assets) {
                const row = [];
                for (const asset2 of assets) {
                    row.push(correlationMatrix[asset1][asset2]);
                }
                zValues.push(row);
            }
            
            const data = [{
                type: 'heatmap',
                z: zValues,
                x: assets,
                y: assets,
                colorscale: [
                    [0, 'rgba(239, 68, 68, 0.7)'],      // Red for negative correlation
                    [0.5, 'rgba(243, 244, 246, 0.7)'],  // Light gray for no correlation
                    [1, 'rgba(16, 185, 129, 0.7)']      // Green for positive correlation
                ],
                zmin: -1,
                zmax: 1,
                showscale: true,
                colorbar: {
                    title: 'Correlation',
                    titleside: 'right'
                },
                hoverongaps: false,
                text: zValues.map(row => row.map(val => val.toFixed(2))),
                hoverinfo: 'text'
            }];
            
            const layout = {
                title: 'Asset Correlation Matrix',
                height: 400,
                margin: {
                    l: 50,
                    r: 50,
                    t: 40,
                    b: 50
                },
                xaxis: {
                    title: 'Asset'
                },
                yaxis: {
                    title: 'Asset'
                }
            };
            
            Plotly.newPlot('correlationMatrixHeatmap', data, layout, {responsive: true});
        }
        
        // Performance Analytics Dashboard Initialization
        function initializePerformanceAnalyticsDashboard() {
            fetchPerformanceAnalyticsData();
            
            // Setup refresh button
            const refreshButton = document.querySelector('.refresh-button[data-target="performanceOverview"]');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    fetchPerformanceAnalyticsData();
                    
                    // Show loading animation
                    this.classList.add('refreshing');
                    setTimeout(() => {
                        this.classList.remove('refreshing');
                    }, 500);
                });
            }
            
            // Setup time period selectors
            const periodTabs = document.querySelectorAll('.period-tab');
            periodTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    periodTabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Update summary with the selected period
                    const period = this.getAttribute('data-period');
                    updatePerformanceSummary(window.performanceData, period);
                });
            });
        }
        
        // Fetch performance analytics data
        function fetchPerformanceAnalyticsData() {
            fetch('/api/dashboard/performance-analytics')
                .then(response => response.json())
                .then(data => {
                    // Store the data globally for period tab changes
                    window.performanceData = data;
                    
                    // Update all sections with data
                    updatePerformanceSummary(data, 'daily'); // Default to daily view initially
                    updateStrategyPerformance(data.strategy_performance);
                    updateAssetPerformance(data.asset_performance);
                    updateTradeDistribution(data.trade_analytics.trade_distribution);
                    updatePerformanceFactors(data.trade_analytics.performance_factors);
                    updateRecentTrades(data.recent_trades);
                    renderEquityCurveChart(data.equity_curve);
                    renderDrawdownChart(data.equity_curve);
                    
                    // Update last updated timestamp
                    const lastUpdatedElement = document.getElementById('performanceLastUpdated');
                    if (lastUpdatedElement) {
                        lastUpdatedElement.textContent = data.last_updated;
                    }
                })
                .catch(error => {
                    console.error('Error fetching performance analytics data:', error);
                });
        }
        
        // Update performance summary based on selected time period
        function updatePerformanceSummary(data, period) {
            if (!data || !data.performance_summary || !data.performance_summary[period]) return;
            
            const summary = data.performance_summary[period];
            
            // Update main metrics
            document.getElementById('returnPct').textContent = `${summary.return_pct > 0 ? '+' : ''}${summary.return_pct}%`;
            document.getElementById('returnPct').className = summary.return_pct >= 0 ? 'metric-value positive' : 'metric-value negative';
            
            document.getElementById('winRate').textContent = `${summary.win_rate}%`;
            document.getElementById('totalTrades').textContent = summary.trades_count;
            document.getElementById('profitFactor').textContent = summary.profit_factor.toFixed(2);
            document.getElementById('expectedValue').textContent = `$${summary.expected_value}`;
            document.getElementById('sharpeRatio').textContent = summary.sharpe.toFixed(2);
            document.getElementById('maxDrawdown').textContent = `${summary.max_drawdown}%`;
            
            // Update additional metrics
            document.getElementById('winningTrades').textContent = summary.winning_trades;
            document.getElementById('losingTrades').textContent = summary.losing_trades;
            document.getElementById('avgProfit').textContent = `$${summary.avg_profit}`;
            document.getElementById('avgLoss').textContent = `$${summary.avg_loss}`;
            document.getElementById('tradingVolume').textContent = `$${summary.volume.toLocaleString()}`;
            document.getElementById('tradingFees').textContent = `$${summary.fees.toLocaleString()}`;
        }
        
        // Update strategy performance table
        function updateStrategyPerformance(strategies) {
            const tableBody = document.getElementById('strategyPerformanceTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            strategies.forEach(strategy => {
                const row = document.createElement('tr');
                
                const statusClass = strategy.status === 'active' ? 'status-active' : 'status-inactive';
                const returnClass = strategy.return_pct >= 0 ? 'positive' : 'negative';
                
                row.innerHTML = `
                    <td>${strategy.strategy}</td>
                    <td class="${returnClass}">${strategy.return_pct > 0 ? '+' : ''}${strategy.return_pct}%</td>
                    <td>${strategy.trades_count}</td>
                    <td>${strategy.win_rate}%</td>
                    <td>${strategy.profit_factor}</td>
                    <td>${strategy.sharpe}</td>
                    <td>${strategy.max_drawdown}%</td>
                    <td>${strategy.avg_holding_time}</td>
                    <td><span class="status-indicator ${statusClass}"></span></td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Update asset performance table
        function updateAssetPerformance(assets) {
            const tableBody = document.getElementById('assetPerformanceTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            assets.forEach(asset => {
                const row = document.createElement('tr');
                
                const returnClass = asset.return_pct >= 0 ? 'positive' : 'negative';
                const pnlClass = asset.unrealized_pnl >= 0 ? 'positive' : 'negative';
                
                row.innerHTML = `
                    <td>${asset.asset}</td>
                    <td class="${returnClass}">${asset.return_pct > 0 ? '+' : ''}${asset.return_pct}%</td>
                    <td>${asset.trades_count}</td>
                    <td>${asset.win_rate}%</td>
                    <td>${asset.profit_factor}</td>
                    <td>$${asset.avg_profit}</td>
                    <td>$${asset.avg_loss}</td>
                    <td>${asset.avg_holding_time}</td>
                    <td class="${pnlClass}">$${asset.unrealized_pnl}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Update trade distribution charts
        function updateTradeDistribution(distribution) {
            // Time of day distribution
            const timeLabels = Object.keys(distribution.time_of_day);
            const timeValues = Object.values(distribution.time_of_day);
            
            const timeData = [{
                x: timeLabels,
                y: timeValues,
                type: 'bar',
                marker: {
                    color: 'rgba(75, 192, 192, 0.7)'
                }
            }];
            
            const timeLayout = {
                title: 'Trades by Time of Day',
                height: 250,
                margin: { t: 30, r: 10, l: 40, b: 60 },
                xaxis: { title: 'Time Period' },
                yaxis: { title: 'Percentage (%)' }
            };
            
            Plotly.newPlot('timeOfDayChart', timeData, timeLayout, {responsive: true});
            
            // Day of week distribution
            const dayLabels = Object.keys(distribution.day_of_week);
            const dayValues = Object.values(distribution.day_of_week);
            
            const dayData = [{
                x: dayLabels,
                y: dayValues,
                type: 'bar',
                marker: {
                    color: 'rgba(54, 162, 235, 0.7)'
                }
            }];
            
            const dayLayout = {
                title: 'Trades by Day of Week',
                height: 250,
                margin: { t: 30, r: 10, l: 40, b: 60 },
                xaxis: { title: 'Day' },
                yaxis: { title: 'Percentage (%)' }
            };
            
            Plotly.newPlot('dayOfWeekChart', dayData, dayLayout, {responsive: true});
            
            // Trade size distribution
            const sizeLabels = Object.keys(distribution.trade_size);
            const sizeValues = Object.values(distribution.trade_size);
            
            const sizeData = [{
                labels: sizeLabels,
                values: sizeValues,
                type: 'pie',
                hole: 0.4,
                marker: {
                    colors: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 
                             'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)']
                },
                textinfo: 'label+percent',
                insidetextorientation: 'radial'
            }];
            
            const sizeLayout = {
                title: 'Trade Size Distribution',
                height: 300,
                margin: { t: 30, r: 10, l: 10, b: 10 },
                showlegend: false
            };
            
            Plotly.newPlot('tradeSizeChart', sizeData, sizeLayout, {responsive: true});
            
            // Holding time distribution
            const holdingLabels = Object.keys(distribution.holding_time);
            const holdingValues = Object.values(distribution.holding_time);
            
            const holdingData = [{
                labels: holdingLabels,
                values: holdingValues,
                type: 'pie',
                hole: 0.4,
                marker: {
                    colors: ['rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)', 
                             'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 
                             'rgba(255, 206, 86, 0.7)']
                },
                textinfo: 'label+percent',
                insidetextorientation: 'radial'
            }];
            
            const holdingLayout = {
                title: 'Holding Time Distribution',
                height: 300,
                margin: { t: 30, r: 10, l: 10, b: 10 },
                showlegend: false
            };
            
            Plotly.newPlot('holdingTimeChart', holdingData, holdingLayout, {responsive: true});
        }
        
        // Update performance factors visualization
        function updatePerformanceFactors(factors) {
            // Map the API keys to the HTML element IDs
            const factorMap = {
                'volatility_impact': 'volatilityImpact',
                'volume_impact': 'volumeImpact',
                'market_hour_impact': 'marketHourImpact',
                'news_sentiment_impact': 'newsSentimentImpact'
            };
            
            // For testing if keys don't match
            console.log("Performance factors received:", Object.keys(factors));
            
            // Update factor bars and values
            Object.keys(factors).forEach(key => {
                const value = factors[key];
                const elementId = factorMap[key] || key;
                const barElement = document.getElementById(`${elementId}Bar`);
                const valueElement = document.getElementById(`${elementId}Value`);
                
                if (barElement && valueElement) {
                    // Update the bar width based on factor value
                    const normalizedWidth = Math.min(Math.max(Math.abs(value), 5), 100); // At least 5%, max 100%
                    
                    // Set width and position (left or right based on sign)
                    if (value >= 0) {
                        barElement.style.width = `${normalizedWidth}%`;
                        barElement.style.left = '50%';
                        barElement.style.right = 'auto';
                        barElement.className = 'factor-bar positive';
                    } else {
                        barElement.style.width = `${normalizedWidth}%`;
                        barElement.style.right = '50%';
                        barElement.style.left = 'auto';
                        barElement.className = 'factor-bar negative';
                    }
                    
                    // Update the value text
                    valueElement.textContent = `${value > 0 ? '+' : ''}${value}%`;
                    valueElement.className = value >= 0 ? 'factor-value positive' : 'factor-value negative';
                }
            });
        }
        
        // Update recent trades table
        function updateRecentTrades(trades) {
            const tableBody = document.getElementById('recentTradesPerformanceTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            trades.forEach(trade => {
                const row = document.createElement('tr');
                
                const pnlClass = trade.profit_loss >= 0 ? 'positive' : 'negative';
                const sideClass = trade.side;
                
                row.innerHTML = `
                    <td>${trade.asset}</td>
                    <td>${trade.strategy}</td>
                    <td class="${sideClass}">${trade.side.toUpperCase()}</td>
                    <td>${trade.entry_price}</td>
                    <td>${trade.exit_price}</td>
                    <td class="${pnlClass}">$${trade.profit_loss}</td>
                    <td class="${pnlClass}">${trade.profit_loss_pct > 0 ? '+' : ''}${trade.profit_loss_pct}%</td>
                    <td>${trade.holding_time}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Render equity curve chart
        function renderEquityCurveChart(equityData) {
            const dates = equityData.dates;
            const equity = equityData.equity;
            const benchmark = equityData.benchmark;
            
            const data = [
                {
                    x: dates,
                    y: equity,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Portfolio',
                    line: {
                        color: 'rgba(75, 192, 192, 1)',
                        width: 2
                    }
                },
                {
                    x: dates,
                    y: benchmark,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Benchmark',
                    line: {
                        color: 'rgba(128, 128, 128, 0.7)',
                        width: 2,
                        dash: 'dot'
                    }
                }
            ];
            
            const layout = {
                title: 'Equity Curve',
                height: 370,
                margin: {
                    l: 50,
                    r: 20,
                    t: 40,
                    b: 40
                },
                legend: {
                    orientation: 'h',
                    y: -0.15
                },
                yaxis: {
                    title: 'Portfolio Value ($)',
                    tickprefix: '$'
                },
                xaxis: {
                    title: 'Date'
                },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('equityChart', data, layout, {responsive: true});
        }
        
        // Render drawdown chart
        function renderDrawdownChart(equityData) {
            const dates = equityData.dates;
            const drawdowns = equityData.drawdowns;
            
            const data = [
                {
                    x: dates,
                    y: drawdowns,
                    type: 'scatter',
                    fill: 'tozeroy',
                    mode: 'lines',
                    name: 'Drawdown',
                    line: {
                        color: 'rgba(255, 99, 132, 1)',
                        width: 2
                    },
                    fillcolor: 'rgba(255, 99, 132, 0.3)'
                }
            ];
            
            const layout = {
                title: 'Drawdown Analysis',
                height: 300,
                margin: {
                    l: 50,
                    r: 20,
                    t: 40,
                    b: 40
                },
                yaxis: {
                    title: 'Drawdown (%)',
                    ticksuffix: '%',
                    autorange: 'reversed' // Invert y-axis so drawdowns go down
                },
                xaxis: {
                    title: 'Date'
                },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('drawdownChart', data, layout, {responsive: true});
        }
        
        // Logs & Monitoring Dashboard Initialization
        function initializeLogsMonitoringDashboard() {
            fetchLogsMonitoringData();
            
            // Setup refresh button
            const refreshButton = document.querySelector('.refresh-button[data-target="systemLogs"]');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    fetchLogsMonitoringData();
                    
                    // Show loading animation
                    this.classList.add('refreshing');
                    setTimeout(() => {
                        this.classList.remove('refreshing');
                    }, 500);
                });
            }
            
            // Setup log search functionality
            const searchInput = document.getElementById('logsSearchInput');
            const searchButton = document.getElementById('logsSearchButton');
            
            if (searchInput && searchButton) {
                // Search on button click
                searchButton.addEventListener('click', function() {
                    filterLogs();
                });
                
                // Search on enter key
                searchInput.addEventListener('keyup', function(event) {
                    if (event.key === 'Enter') {
                        filterLogs();
                    }
                });
            }
            
            // Setup log filters
            const logLevelFilter = document.getElementById('logLevelFilter');
            const componentFilter = document.getElementById('componentFilter');
            
            if (logLevelFilter) {
                logLevelFilter.addEventListener('change', filterLogs);
            }
            
            if (componentFilter) {
                componentFilter.addEventListener('change', filterLogs);
            }
            
            // Setup pagination
            const prevPageButton = document.getElementById('prevLogsPage');
            const nextPageButton = document.getElementById('nextLogsPage');
            
            if (prevPageButton && nextPageButton) {
                prevPageButton.addEventListener('click', function() {
                    if (window.currentLogsPage > 1) {
                        window.currentLogsPage--;
                        displayLogs(window.filteredLogs);
                    }
                });
                
                nextPageButton.addEventListener('click', function() {
                    const totalPages = Math.ceil(window.filteredLogs.length / window.logsPerPage);
                    if (window.currentLogsPage < totalPages) {
                        window.currentLogsPage++;
                        displayLogs(window.filteredLogs);
                    }
                });
            }
        }
        
        // Filter logs based on search input and filters
        function filterLogs() {
            if (!window.allLogs) return;
            
            const searchTerm = document.getElementById('logsSearchInput').value.toLowerCase();
            const logLevel = document.getElementById('logLevelFilter').value;
            const component = document.getElementById('componentFilter').value;
            
            window.filteredLogs = window.allLogs.filter(log => {
                // Search term filter
                const matchesSearch = searchTerm === '' || 
                    log.message.toLowerCase().includes(searchTerm) || 
                    log.component.toLowerCase().includes(searchTerm);
                
                // Log level filter
                const matchesLevel = logLevel === 'all' || log.level === logLevel;
                
                // Component filter
                const matchesComponent = component === 'all' || log.component === component;
                
                return matchesSearch && matchesLevel && matchesComponent;
            });
            
            // Reset to first page when filtering
            window.currentLogsPage = 1;
            
            // Display filtered logs
            displayLogs(window.filteredLogs);
        }
        
        // Display logs with pagination
        function displayLogs(logs) {
            const tableBody = document.getElementById('systemLogsBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // Calculate pagination
            const startIndex = (window.currentLogsPage - 1) * window.logsPerPage;
            const endIndex = Math.min(startIndex + window.logsPerPage, logs.length);
            const pageInfo = document.getElementById('logsPageInfo');
            
            if (pageInfo) {
                const totalPages = Math.ceil(logs.length / window.logsPerPage);
                pageInfo.textContent = `Page ${window.currentLogsPage} of ${totalPages}`;
            }
            
            // Display logs for current page
            for (let i = startIndex; i < endIndex; i++) {
                const log = logs[i];
                const row = document.createElement('tr');
                
                // Format log level with appropriate class
                const levelClass = log.level.toLowerCase();
                
                row.innerHTML = `
                    <td>${log.timestamp}</td>
                    <td><span class="log-level ${levelClass}">${log.level}</span></td>
                    <td>${log.component}</td>
                    <td>${log.message}</td>
                `;
                
                tableBody.appendChild(row);
            }
        }
        
        // Fetch logs and monitoring data
        function fetchLogsMonitoringData() {
            fetch('/api/dashboard/logs-monitoring')
                .then(response => response.json())
                .then(data => {
                    // Store all logs globally for filtering
                    window.allLogs = data.system_logs;
                    window.filteredLogs = [...data.system_logs];
                    window.currentLogsPage = 1;
                    window.logsPerPage = 15;
                    
                    // Update logs display
                    displayLogs(window.filteredLogs);
                    
                    // Populate component filter options
                    populateComponentFilter(data.system_logs);
                    
                    // Update resource utilization
                    updateResourceUtilization(data.resource_utilization);
                    
                    // Update error distribution charts
                    renderErrorDistributionCharts(data.error_distribution);
                    
                    // Update API status
                    updateApiStatus(data.api_status);
                    
                    // Update recent requests
                    updateRecentRequests(data.recent_requests);
                    
                    // Update trade flow
                    updateTradeEventFlow(data.trade_flow);
                })
                .catch(error => {
                    console.error('Error fetching logs and monitoring data:', error);
                });
        }
        
        // Populate component filter dropdown with unique components
        function populateComponentFilter(logs) {
            const componentFilter = document.getElementById('componentFilter');
            if (!componentFilter) return;
            
            // Extract unique components
            const components = [...new Set(logs.map(log => log.component))];
            
            // Clear existing options (except the 'All Components' option)
            while (componentFilter.options.length > 1) {
                componentFilter.remove(1);
            }
            
            // Add component options
            components.forEach(component => {
                const option = document.createElement('option');
                option.value = component;
                option.textContent = component;
                componentFilter.appendChild(option);
            });
        }
        
        // Update resource utilization gauges and chart
        function updateResourceUtilization(data) {
            // Update gauges
            updateResourceGauge('cpu', data.cpu_usage[data.cpu_usage.length - 1]);
            updateResourceGauge('memory', data.memory_usage[data.memory_usage.length - 1]);
            updateResourceGauge('network', data.network_traffic[data.network_traffic.length - 1]);
            updateResourceGauge('latency', data.api_latency[data.api_latency.length - 1]);
            
            // Render utilization chart
            renderResourceUtilizationChart(data);
        }
        
        // Update resource gauge with current value
        function updateResourceGauge(resource, value) {
            const gaugeValue = document.getElementById(`${resource}GaugeValue`);
            const gaugeFill = document.getElementById(`${resource}GaugeFill`);
            
            if (gaugeValue && gaugeFill) {
                // Update text value
                if (resource === 'latency') {
                    gaugeValue.textContent = `${value}ms`;
                } else {
                    gaugeValue.textContent = `${value}%`;
                }
                
                // Update fill width
                let fillWidth;
                if (resource === 'latency') {
                    // Calculate percentage for latency (0-500ms range)
                    fillWidth = Math.min(value / 5, 100);
                } else {
                    fillWidth = value;
                }
                
                gaugeFill.style.width = `${fillWidth}%`;
                
                // Update color based on value
                if (fillWidth < 50) {
                    gaugeFill.style.backgroundColor = 'var(--positive)';
                } else if (fillWidth < 80) {
                    gaugeFill.style.backgroundColor = 'var(--warning)';
                } else {
                    gaugeFill.style.backgroundColor = 'var(--error)';
                }
            }
        }
        
        // Render resource utilization chart
        function renderResourceUtilizationChart(data) {
            const chartContainer = document.getElementById('resourceUtilizationChart');
            if (!chartContainer) return;
            
            const traces = [
                {
                    x: data.timestamps,
                    y: data.cpu_usage,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'CPU Usage',
                    line: { color: 'rgba(59, 130, 246, 1)', width: 2 }
                },
                {
                    x: data.timestamps,
                    y: data.memory_usage,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Memory',
                    line: { color: 'rgba(16, 185, 129, 1)', width: 2 }
                },
                {
                    x: data.timestamps,
                    y: data.network_traffic,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Network',
                    line: { color: 'rgba(139, 92, 246, 1)', width: 2 }
                },
                {
                    x: data.timestamps,
                    y: data.api_latency.map(l => l / 5), // Scale down latency for better visualization
                    type: 'scatter',
                    mode: 'lines',
                    name: 'API Latency (ms/5)',
                    line: { color: 'rgba(245, 158, 11, 1)', width: 2 }
                }
            ];
            
            const layout = {
                title: 'System Resource Utilization Over Time',
                height: 300,
                margin: { l: 50, r: 20, t: 40, b: 50 },
                legend: { orientation: 'h', y: -0.2 },
                yaxis: { title: 'Usage (%)', range: [0, 100] },
                xaxis: { title: 'Time' },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('resourceUtilizationChart', traces, layout, {responsive: true});
        }
        
        // Render error distribution charts
        function renderErrorDistributionCharts(errorData) {
            // Errors by component
            renderErrorPieChart('errorByComponentChart', errorData.by_component, 'Errors by Component');
            
            // Errors by type
            renderErrorPieChart('errorByTypeChart', errorData.by_type, 'Errors by Type');
            
            // Errors by severity
            renderErrorPieChart('errorBySeverityChart', errorData.by_severity, 'Errors by Severity');
        }
        
        // Render a single error pie chart
        function renderErrorPieChart(containerId, data, title) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const labels = Object.keys(data);
            const values = Object.values(data);
            
            const chartData = [{
                type: 'pie',
                labels: labels,
                values: values,
                textinfo: 'label+percent',
                insidetextorientation: 'radial',
                marker: {
                    colors: [
                        'rgba(239, 68, 68, 0.7)',    // Red
                        'rgba(245, 158, 11, 0.7)',   // Amber
                        'rgba(59, 130, 246, 0.7)',   // Blue
                        'rgba(16, 185, 129, 0.7)',   // Green
                        'rgba(139, 92, 246, 0.7)',   // Purple
                        'rgba(236, 72, 153, 0.7)',   // Pink
                        'rgba(75, 85, 99, 0.7)',     // Gray
                        'rgba(251, 146, 60, 0.7)'    // Orange
                    ]
                }
            }];
            
            const layout = {
                title: title,
                height: 250,
                margin: { l: 0, r: 0, t: 30, b: 0 },
                showlegend: false
            };
            
            Plotly.newPlot(containerId, chartData, layout, {responsive: true});
        }
        
        // Update API status display
        function updateApiStatus(apiStatus) {
            const apiStatusGrid = document.getElementById('apiStatusGrid');
            if (!apiStatusGrid) return;
            
            apiStatusGrid.innerHTML = '';
            
            apiStatus.forEach(api => {
                const statusItem = document.createElement('div');
                statusItem.className = 'api-status-item';
                
                // Determine status class
                const statusClass = api.status;
                
                // Create status HTML
                statusItem.innerHTML = `
                    <div class="api-status-name">
                        <span class="api-status-indicator ${statusClass}"></span>
                        ${api.name}
                    </div>
                    <div class="api-status-metrics">
                        <div class="api-metric">
                            <div class="api-metric-name">Success Rate</div>
                            <div class="api-metric-value">${api.success_rate}%</div>
                        </div>
                        <div class="api-metric">
                            <div class="api-metric-name">Avg Response Time</div>
                            <div class="api-metric-value">${api.avg_response_time}ms</div>
                        </div>
                        <div class="api-metric">
                            <div class="api-metric-name">Rate Limit Used</div>
                            <div class="api-metric-value">${api.rate_limit_used}%</div>
                        </div>
                        <div class="api-metric">
                            <div class="api-metric-name">Last Checked</div>
                            <div class="api-metric-value">${api.last_checked}</div>
                        </div>
                    </div>
                `;
                
                apiStatusGrid.appendChild(statusItem);
            });
        }
        
        // Update recent requests table
        function updateRecentRequests(requests) {
            const tableBody = document.getElementById('recentRequestsBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            requests.slice(0, 20).forEach(request => {
                const row = document.createElement('tr');
                
                // Determine status code class
                let statusClass = 'success';
                if (request.status_code >= 400 && request.status_code < 500) {
                    statusClass = 'warning';
                } else if (request.status_code >= 500) {
                    statusClass = 'error';
                }
                
                row.innerHTML = `
                    <td>${request.timestamp}</td>
                    <td>${request.exchange}</td>
                    <td>${request.method}</td>
                    <td class="url-cell">${request.url}</td>
                    <td><span class="status-code ${statusClass}">${request.status_code}</span></td>
                    <td>${request.response_time}ms</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Update trade event flow display
        function updateTradeEventFlow(flowData) {
            const flowContainer = document.getElementById('tradeEventFlow');
            if (!flowContainer) return;
            
            flowContainer.innerHTML = '';
            
            // Group flow events by flow_id
            const flowGroups = {};
            flowData.forEach(event => {
                if (!flowGroups[event.flow_id]) {
                    flowGroups[event.flow_id] = [];
                }
                flowGroups[event.flow_id].push(event);
            });
            
            // Sort and display each flow
            Object.keys(flowGroups).forEach(flowId => {
                const events = flowGroups[flowId];
                
                // Sort events by timestamp
                events.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                // Create flow group element
                const flowGroup = document.createElement('div');
                flowGroup.className = 'flow-group';
                
                // Create flow header
                const flowHeader = document.createElement('div');
                flowHeader.className = 'flow-header';
                flowHeader.innerHTML = `
                    <div class="flow-title">Trade Flow ${flowId}</div>
                    <div class="flow-timestamp">Started at ${events[0].timestamp}</div>
                `;
                
                // Create flow steps container
                const flowSteps = document.createElement('div');
                flowSteps.className = 'flow-steps';
                
                // Add each step
                events.forEach(event => {
                    const step = document.createElement('div');
                    step.className = 'flow-step';
                    
                    // Format duration to 2 decimal places
                    const duration = event.duration_ms.toFixed(2);
                    
                    step.innerHTML = `
                        <div class="step-indicator ${event.status}">
                            <i data-feather="${event.status === 'success' ? 'check' : event.status === 'warning' ? 'alert-triangle' : 'x'}"></i>
                        </div>
                        <div class="step-content">
                            <div class="step-name">${event.component}</div>
                            <div class="step-message">${event.message}</div>
                            <div class="step-duration">${duration}ms</div>
                        </div>
                    `;
                    
                    flowSteps.appendChild(step);
                });
                
                // Assemble flow group
                flowGroup.appendChild(flowHeader);
                flowGroup.appendChild(flowSteps);
                
                // Add to container
                flowContainer.appendChild(flowGroup);
            });
            
            // Initialize Feather icons in the flow steps
            feather.replace();
        }
        
        // Guided Tour Functions
        function showTourButton() {
            const tourButtonContainer = document.createElement('div');
            tourButtonContainer.id = 'tourButtonContainer';
            tourButtonContainer.className = 'tour-button-container';
            
            const tourButton = document.createElement('button');
            tourButton.id = 'startTourButton';
            tourButton.className = 'tour-button';
            tourButton.innerHTML = '<i data-feather="help-circle"></i><span>Take a Tour</span>';
            
            tourButtonContainer.appendChild(tourButton);
            document.body.appendChild(tourButtonContainer);
            
            // Initialize feather icons for the button
            feather.replace();
            
            // Add click event
            tourButton.addEventListener('click', startGuidedTour);
        }
        
        function startGuidedTour() {
            // Initialize the tour
            const tour = new Shepherd.Tour({
                useModalOverlay: true,
                defaultStepOptions: {
                    cancelIcon: {
                        enabled: true
                    },
                    classes: 'shepherd-theme-arrows',
                    scrollTo: true
                }
            });
            
            // Add steps to the tour
            tour.addStep({
                id: 'welcome',
                title: 'Welcome to the AI Trading Dashboard',
                text: 'This tour will guide you through the main features of the dashboard. Click "Next" to continue.',
                buttons: [
                    {
                        action: tour.cancel,
                        classes: 'shepherd-button-secondary',
                        text: 'Skip'
                    },
                    {
                        action: tour.next,
                        text: 'Next'
                    }
                ]
            });
            
            tour.addStep({
                id: 'system-controls',
                title: 'System Controls',
                text: 'These controls allow you to start/stop the trading system and toggle between trading modes.',
                attachTo: {
                    element: '.system-controls',
                    on: 'bottom'
                },
                buttons: [
                    {
                        action: tour.back,
                        classes: 'shepherd-button-secondary',
                        text: 'Back'
                    },
                    {
                        action: tour.next,
                        text: 'Next'
                    }
                ]
            });
            
            tour.addStep({
                id: 'data-source',
                title: 'Data Source',
                text: 'Switch between mock data (for testing) and real data from the trading system.',
                attachTo: {
                    element: '.data-source-control',
                    on: 'bottom'
                },
                buttons: [
                    {
                        action: tour.back,
                        classes: 'shepherd-button-secondary',
                        text: 'Back'
                    },
                    {
                        action: tour.next,
                        text: 'Next'
                    }
                ]
            });
            
            tour.addStep({
                id: 'theme-toggle',
                title: 'Theme Toggle',
                text: 'Switch between light and dark themes based on your preference.',
                attachTo: {
                    element: '.theme-toggle-container',
                    on: 'bottom'
                },
                buttons: [
                    {
                        action: tour.back,
                        classes: 'shepherd-button-secondary',
                        text: 'Back'
                    },
                    {
                        action: tour.next,
                        text: 'Next'
                    }
                ]
            });
            
            tour.addStep({
                id: 'navigation',
                title: 'Dashboard Navigation',
                text: 'Use these tabs to navigate between different sections of the dashboard.',
                attachTo: {
                    element: '.dashboard-tabs',
                    on: 'bottom'
                },
                buttons: [
                    {
                        action: tour.back,
                        classes: 'shepherd-button-secondary',
                        text: 'Back'
                    },
                    {
                        action: tour.next,
                        text: 'Next'
                    }
                ]
            });
            
            tour.addStep({
                id: 'complete',
                title: 'Tour Complete',
                text: 'You\'re now ready to use the AI Trading Dashboard! You can access this tour again from the help menu.',
                buttons: [
                    {
                        action: function() {
                            // Mark tour as seen
                            localStorage.setItem('hasSeenTour', 'true');
                            
                            // Hide tour button
                            const tourButton = document.getElementById('tourButtonContainer');
                            if (tourButton) {
                                tourButton.style.display = 'none';
                            }
                            
                            tour.complete();
                        },
                        text: 'Finish'
                    }
                ]
            });
            
            // Start the tour
            tour.start();
        }
    </script>
    
    <!-- Guided tour button -->
    <div id="tourButtonContainer" class="tour-button-container" style="display:none;">
        <button id="startTourButton" class="tour-button">
            <i data-feather="help-circle"></i>
            <span>Take a Tour</span>
        </button>
    </div>
    
    <!-- Include settings panel -->
    {% include 'settings_panel.html' %}
</body>
</html><div id="settingsPanel" class="settings-panel">
    <div class="settings-header">
        <h2>Dashboard Settings</h2>
        <button id="closeSettings" class="close-settings">
            <i data-feather="x"></i>
        </button>
    </div>
    
    <div class="settings-content">
        <div class="settings-section">
            <h3>Appearance</h3>
            
            <div class="settings-item">
                <label for="themeSelect">Theme</label>
                <div class="settings-control">
                    <select id="themeSelect" class="settings-select">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="system">System Default</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-item">
                <label for="densitySelect">Density</label>
                <div class="settings-control">
                    <select id="densitySelect" class="settings-select">
                        <option value="comfortable">Comfortable</option>
                        <option value="compact">Compact</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-item">
                <label for="animationsToggle">Animations</label>
                <div class="settings-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="animationsToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <h3>Dashboard Layout</h3>
            
            <div class="settings-item">
                <label for="defaultTab">Default Tab</label>
                <div class="settings-control">
                    <select id="defaultTab" class="settings-select">
                        <option value="overview">Overview</option>
                        <option value="market-regime">Market Regime</option>
                        <option value="sentiment">Sentiment Analysis</option>
                        <option value="risk">Risk Management</option>
                        <option value="performance">Performance Analytics</option>
                        <option value="logs">Logs & Monitoring</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-item">
                <label for="layoutSelect">Layout Type</label>
                <div class="settings-control">
                    <select id="layoutSelect" class="settings-select">
                        <option value="grid">Grid</option>
                        <option value="list">List</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-item">
                <label>Visible Cards</label>
                <div class="settings-control settings-checkboxes">
                    <div class="checkbox-item">
                        <input type="checkbox" id="showSystemHealth" checked>
                        <label for="showSystemHealth">System Health</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showTradingPerformance" checked>
                        <label for="showTradingPerformance">Trading Performance</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showMarketRegime" checked>
                        <label for="showMarketRegime">Market Regime</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showSentiment" checked>
                        <label for="showSentiment">Sentiment</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showPositions" checked>
                        <label for="showPositions">Positions</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="showRecentTrades" checked>
                        <label for="showRecentTrades">Recent Trades</label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <h3>Data Preferences</h3>
            
            <div class="settings-item">
                <label for="refreshRateSelect">Data Refresh Rate</label>
                <div class="settings-control">
                    <select id="refreshRateSelect" class="settings-select">
                        <option value="5000">5 seconds</option>
                        <option value="10000">10 seconds</option>
                        <option value="30000" selected>30 seconds</option>
                        <option value="60000">1 minute</option>
                        <option value="300000">5 minutes</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-item">
                <label for="dataSourceSelect">Default Data Source</label>
                <div class="settings-control">
                    <select id="dataSourceSelect" class="settings-select">
                        <option value="mock">Mock Data</option>
                        <option value="real">Real Data</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-item">
                <label for="timeFormatSelect">Time Format</label>
                <div class="settings-control">
                    <select id="timeFormatSelect" class="settings-select">
                        <option value="12h">12-hour (AM/PM)</option>
                        <option value="24h">24-hour</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <h3>Notifications</h3>
            
            <div class="settings-item">
                <label for="notificationsToggle">Enable Notifications</label>
                <div class="settings-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="notificationsToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-item">
                <label for="alertSoundToggle">Alert Sounds</label>
                <div class="settings-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="alertSoundToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-item">
                <label>Notification Types</label>
                <div class="settings-control settings-checkboxes">
                    <div class="checkbox-item">
                        <input type="checkbox" id="notifySystem" checked>
                        <label for="notifySystem">System</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="notifyTrades" checked>
                        <label for="notifyTrades">Trades</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="notifyMarket" checked>
                        <label for="notifyMarket">Market</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="notifyAlerts" checked>
                        <label for="notifyAlerts">Alerts</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="settings-footer">
        <button id="resetSettings" class="reset-settings-btn">Reset to Defaults</button>
        <button id="saveSettings" class="save-settings-btn">Save Changes</button>
    </div>
</div>

<div id="settingsOverlay" class="settings-overlay"></div><div id="exportPanel" class="export-panel">
    <div class="export-header">
        <h2>Export Data</h2>
        <button id="closeExport" class="close-export">
            <i data-feather="x"></i>
        </button>
    </div>
    
    <div class="export-content">
        <div class="export-section">
            <h3>Export Options</h3>
            
            <div class="export-item">
                <label for="exportTypeSelect">Export Type</label>
                <div class="export-control">
                    <select id="exportTypeSelect" class="export-select">
                        <option value="current">Current View</option>
                        <option value="custom">Custom Selection</option>
                        <option value="full">Full Dashboard Data</option>
                    </select>
                </div>
            </div>
            
            <div class="export-item">
                <label for="exportFormatSelect">File Format</label>
                <div class="export-control">
                    <select id="exportFormatSelect" class="export-select">
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="excel">Excel</option>
                        <option value="pdf">PDF</option>
                    </select>
                </div>
            </div>
            
            <div class="export-item">
                <label for="dateRangeSelect">Date Range</label>
                <div class="export-control">
                    <select id="dateRangeSelect" class="export-select">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="last7days">Last 7 Days</option>
                        <option value="last30days">Last 30 Days</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
            </div>
            
            <div id="customDateRange" class="export-item custom-date-range" style="display: none;">
                <div class="date-range-inputs">
                    <div class="date-input-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate" class="export-input">
                    </div>
                    <div class="date-input-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate" class="export-input">
                    </div>
                </div>
            </div>
        </div>
        
        <div id="customExportOptions" class="export-section" style="display: none;">
            <h3>Data Selection</h3>
            
            <div class="export-checkboxes">
                <div class="checkbox-item">
                    <input type="checkbox" id="exportSystemHealth" checked>
                    <label for="exportSystemHealth">System Health</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="exportTradingPerformance" checked>
                    <label for="exportTradingPerformance">Trading Performance</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="exportMarketRegime" checked>
                    <label for="exportMarketRegime">Market Regime</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="exportSentiment" checked>
                    <label for="exportSentiment">Sentiment</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="exportPositions" checked>
                    <label for="exportPositions">Positions</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="exportRecentTrades" checked>
                    <label for="exportRecentTrades">Recent Trades</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="exportLogs" checked>
                    <label for="exportLogs">System Logs</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="exportPerformanceMetrics" checked>
                    <label for="exportPerformanceMetrics">Performance Metrics</label>
                </div>
            </div>
        </div>
        
        <div class="export-section">
            <h3>Schedule Export</h3>
            
            <div class="export-item">
                <label for="scheduleExportToggle">Schedule Recurring Export</label>
                <div class="export-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="scheduleExportToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div id="scheduleOptions" class="schedule-options" style="display: none;">
                <div class="export-item">
                    <label for="scheduleFrequencySelect">Frequency</label>
                    <div class="export-control">
                        <select id="scheduleFrequencySelect" class="export-select">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </div>
                
                <div class="export-item">
                    <label for="emailRecipients">Email To</label>
                    <div class="export-control">
                        <input type="text" id="emailRecipients" class="export-input" placeholder="email@example.com">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="export-footer">
        <button id="cancelExport" class="cancel-export-btn">Cancel</button>
        <button id="downloadExport" class="download-export-btn">Export Now</button>
    </div>
</div>

<div id="exportOverlay" class="export-overlay"></div><div id="notificationCenter" class="notification-center">
    <div class="notification-header">
        <h2>Notifications</h2>
        <div class="notification-actions">
            <button id="markAllRead" class="mark-all-read-btn" title="Mark all as read">
                <i data-feather="check-square"></i>
            </button>
            <button id="clearAllNotifications" class="clear-all-btn" title="Clear all">
                <i data-feather="trash-2"></i>
            </button>
            <button id="closeNotificationCenter" class="close-notifications">
                <i data-feather="x"></i>
            </button>
        </div>
    </div>
    
    <div class="notification-tabs">
        <button class="notification-tab active" data-tab="all">All</button>
        <button class="notification-tab" data-tab="system">System</button>
        <button class="notification-tab" data-tab="trading">Trading</button>
        <button class="notification-tab" data-tab="alerts">Alerts</button>
    </div>
    
    <div class="notification-content">
        <div id="notificationList" class="notification-list">
            <!-- Notification items will be dynamically added here -->
            <div class="notification-empty">
                <i data-feather="bell-off"></i>
                <p>No notifications yet</p>
            </div>
        </div>
    </div>
    
    <div class="notification-footer">
        <button id="notificationSettings" class="notification-settings-btn">
            <i data-feather="settings"></i>
            <span>Notification Settings</span>
        </button>
    </div>
</div>

<div id="notificationOverlay" class="notification-overlay"></div>

<!-- Notification toast template -->
<div id="notificationToast" class="notification-toast">
    <div class="notification-toast-icon">
        <i data-feather="info"></i>
    </div>
    <div class="notification-toast-content">
        <div class="notification-toast-title">Notification Title</div>
        <div class="notification-toast-message">Notification message text goes here</div>
    </div>
    <button class="notification-toast-close">
        <i data-feather="x"></i>
    </button>
</div>