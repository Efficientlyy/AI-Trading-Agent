<!-- 
    Strategy Performance Comparison Panel Component
    
    This component displays side-by-side comparisons of multiple strategies
    with benchmark comparison and performance attribution.
-->

<div class="card strategy-comparison-panel">
    <div class="card-header">
        <div class="card-title">
            <h3>Strategy Performance Comparison</h3>
            <div class="card-actions">
                <button id="add-strategy-btn" class="btn btn-icon" data-tooltip="Add strategy" data-position="top">
                    <i data-feather="plus-circle"></i>
                </button>
                <button id="benchmark-toggle-btn" class="btn btn-icon" data-tooltip="Toggle benchmark" data-position="top">
                    <i data-feather="trending-up"></i>
                </button>
                <button id="expand-comparison-btn" class="btn btn-icon" data-tooltip="Expand panel" data-position="top">
                    <i data-feather="maximize-2"></i>
                </button>
            </div>
        </div>
        <div class="comparison-controls">
            <div class="time-period-selector">
                <label for="comparison-period">Time Period:</label>
                <select id="comparison-period" class="form-select">
                    <option value="1w">1 Week</option>
                    <option value="1m">1 Month</option>
                    <option value="3m">3 Months</option>
                    <option value="6m">6 Months</option>
                    <option value="1y" selected>1 Year</option>
                    <option value="ytd">Year to Date</option>
                    <option value="all">All Time</option>
                </select>
            </div>
            <div class="metrics-selector">
                <label for="comparison-metric">Metric:</label>
                <select id="comparison-metric" class="form-select">
                    <option value="returns" selected>Total Returns</option>
                    <option value="drawdown">Maximum Drawdown</option>
                    <option value="sharpe">Sharpe Ratio</option>
                    <option value="sortino">Sortino Ratio</option>
                    <option value="volatility">Volatility</option>
                    <option value="win-rate">Win Rate</option>
                    <option value="profit-factor">Profit Factor</option>
                </select>
            </div>
            <div class="benchmark-selector">
                <label for="comparison-benchmark">Benchmark:</label>
                <select id="comparison-benchmark" class="form-select">
                    <option value="BTC-USD" selected>BTC-USD</option>
                    <option value="ETH-USD">ETH-USD</option>
                    <option value="CRYPTO10">CRYPTO10 Index</option>
                    <option value="SP500">S&P 500</option>
                    <option value="NONE">None</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        <div class="performance-charts">
            <div class="performance-main-chart">
                <div id="performance-chart" class="chart-container">
                    <div class="chart-overlay">Loading...</div>
                </div>
            </div>
            <div class="performance-metrics">
                <div class="metrics-table-container">
                    <table id="metrics-table" class="metrics-table">
                        <thead>
                            <tr>
                                <th>Strategy</th>
                                <th>Returns</th>
                                <th>Drawdown</th>
                                <th>Sharpe</th>
                                <th>Win Rate</th>
                                <th>Trades</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="strategy-row" data-strategy="strategy1">
                                <td class="strategy-name">
                                    <span class="color-dot" style="background-color: var(--primary);"></span>
                                    MA Crossover
                                </td>
                                <td class="returns positive">+42.5%</td>
                                <td class="drawdown">-15.3%</td>
                                <td class="sharpe">1.87</td>
                                <td class="win-rate">68%</td>
                                <td class="trades">142</td>
                                <td class="actions">
                                    <button class="btn btn-icon btn-sm" data-tooltip="View details" data-position="left">
                                        <i data-feather="eye"></i>
                                    </button>
                                    <button class="btn btn-icon btn-sm remove-strategy" data-tooltip="Remove" data-position="left">
                                        <i data-feather="x"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr class="strategy-row" data-strategy="strategy2">
                                <td class="strategy-name">
                                    <span class="color-dot" style="background-color: var(--success);"></span>
                                    Sentiment-based
                                </td>
                                <td class="returns positive">+31.2%</td>
                                <td class="drawdown">-18.7%</td>
                                <td class="sharpe">1.45</td>
                                <td class="win-rate">62%</td>
                                <td class="trades">87</td>
                                <td class="actions">
                                    <button class="btn btn-icon btn-sm" data-tooltip="View details" data-position="left">
                                        <i data-feather="eye"></i>
                                    </button>
                                    <button class="btn btn-icon btn-sm remove-strategy" data-tooltip="Remove" data-position="left">
                                        <i data-feather="x"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr class="strategy-row benchmark" data-strategy="benchmark">
                                <td class="strategy-name">
                                    <span class="color-dot" style="background-color: var(--text-light);"></span>
                                    BTC-USD (Benchmark)
                                </td>
                                <td class="returns positive">+28.9%</td>
                                <td class="drawdown">-27.1%</td>
                                <td class="sharpe">1.02</td>
                                <td class="win-rate">-</td>
                                <td class="trades">-</td>
                                <td class="actions">
                                    <button class="btn btn-icon btn-sm toggle-benchmark" data-tooltip="Hide benchmark" data-position="left">
                                        <i data-feather="eye-off"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="attribution-section">
            <h4>Performance Attribution</h4>
            <div class="attribution-charts">
                <div class="attribution-chart">
                    <h5>Return Contribution by Factor</h5>
                    <div id="attribution-chart" class="chart-container-sm">
                        <div class="chart-overlay">Loading...</div>
                    </div>
                </div>
                <div class="attribution-chart">
                    <h5>Win/Loss Distribution</h5>
                    <div id="distribution-chart" class="chart-container-sm">
                        <div class="chart-overlay">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-footer">
        <div class="strategy-badges">
            <span class="strategy-badge active" data-strategy="strategy1">
                MA Crossover
                <span class="badge positive">+42.5%</span>
            </span>
            <span class="strategy-badge active" data-strategy="strategy2">
                Sentiment-based
                <span class="badge positive">+31.2%</span>
            </span>
            <span class="strategy-badge active benchmark" data-strategy="benchmark">
                BTC-USD (Benchmark)
                <span class="badge positive">+28.9%</span>
            </span>
            <button id="add-strategy-inline" class="btn btn-sm">
                <i data-feather="plus"></i> Add Strategy
            </button>
        </div>
    </div>
</div>

<!-- Add Strategy Modal -->
<div id="strategy-modal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Strategy for Comparison</h3>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="strategy-type">Strategy:</label>
                    <select id="strategy-type" class="form-select">
                        <option value="ma-crossover" selected>Moving Average Crossover</option>
                        <option value="sentiment">Sentiment-based Strategy</option>
                        <option value="rsi-strategy">RSI Strategy</option>
                        <option value="market-maker">Market Making Strategy</option>
                        <option value="ml-strategy">Machine Learning Strategy</option>
                        <option value="custom">Custom Strategy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="strategy-period">Time Period:</label>
                    <select id="strategy-period" class="form-select">
                        <option value="1m">1 Month</option>
                        <option value="3m">3 Months</option>
                        <option value="6m">6 Months</option>
                        <option value="1y" selected>1 Year</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="strategy-assets">Assets:</label>
                    <select id="strategy-assets" class="form-select multiple" multiple>
                        <option value="BTC-USD" selected>BTC-USD</option>
                        <option value="ETH-USD">ETH-USD</option>
                        <option value="SOL-USD">SOL-USD</option>
                        <option value="ADA-USD">ADA-USD</option>
                        <option value="DOT-USD">DOT-USD</option>
                    </select>
                    <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple assets</small>
                </div>
                <div class="form-group">
                    <label for="strategy-color">Color:</label>
                    <input type="color" id="strategy-color" class="form-input" value="#6c5ce7">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="add-strategy-confirm">Add Strategy</button>
            </div>
        </div>
    </div>
</div>

<!-- Add CSS for the strategy comparison panel -->
<style>
    .strategy-comparison-panel {
        margin-bottom: 1.5rem;
    }
    
    .comparison-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        margin-top: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-light);
    }
    
    .time-period-selector,
    .metrics-selector,
    .benchmark-selector {
        min-width: 160px;
    }
    
    .performance-charts {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .performance-main-chart {
        width: 100%;
    }
    
    .chart-container {
        width: 100%;
        height: 350px;
        position: relative;
        background-color: var(--card-bg);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .chart-container-sm {
        width: 100%;
        height: 220px;
        position: relative;
        background-color: var(--card-bg);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .chart-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(var(--card-bg-rgb), 0.8);
        font-size: 1rem;
        color: var(--text-light);
    }
    
    .attribution-section {
        margin-top: 1.5rem;
        border-top: 1px solid var(--border-light);
        padding-top: 1.5rem;
    }
    
    .attribution-section h4 {
        margin-bottom: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .attribution-charts {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
    }
    
    .attribution-chart {
        flex: 1;
        min-width: 300px;
    }
    
    .attribution-chart h5 {
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--text-light);
    }
    
    .metrics-table-container {
        width: 100%;
        overflow-x: auto;
    }
    
    .metrics-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    
    .metrics-table th,
    .metrics-table td {
        padding: 0.75rem 1rem;
        text-align: right;
        border-bottom: 1px solid var(--border-light);
    }
    
    .metrics-table th:first-child,
    .metrics-table td:first-child {
        text-align: left;
    }
    
    .metrics-table th {
        font-weight: 600;
        color: var(--text-light);
        background-color: var(--bg-light);
    }
    
    .metrics-table tr:hover {
        background-color: var(--bg-hover);
    }
    
    .strategy-name {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
    }
    
    .color-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .positive {
        color: var(--success);
    }
    
    .negative {
        color: var(--danger);
    }
    
    .btn-icon.btn-sm {
        width: 1.75rem;
        height: 1.75rem;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .strategy-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
    }
    
    .strategy-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        background-color: var(--bg-light);
        font-size: 0.85rem;
        color: var(--text);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .strategy-badge.active {
        background-color: var(--bg);
        font-weight: 500;
    }
    
    .strategy-badge:hover {
        background-color: var(--bg);
    }
    
    .strategy-badge .badge {
        display: inline-flex;
        padding: 0.15rem 0.5rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .strategy-badge .badge.positive {
        background-color: rgba(var(--success-rgb), 0.15);
    }
    
    .strategy-badge .badge.negative {
        background-color: rgba(var(--danger-rgb), 0.15);
    }
    
    .strategy-badge.benchmark {
        border: 1px dashed var(--border);
    }
    
    #add-strategy-inline {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 50px;
        background-color: var(--bg-light);
        font-size: 0.75rem;
        color: var(--text);
        border: none;
        cursor: pointer;
    }
    
    #add-strategy-inline:hover {
        background-color: var(--bg);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .comparison-controls {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .time-period-selector,
        .metrics-selector,
        .benchmark-selector {
            width: 100%;
        }
        
        .chart-container {
            height: 300px;
        }
        
        .attribution-chart {
            min-width: 100%;
        }
    }
</style>

<!-- JavaScript for strategy comparison panel functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    renderPerformanceChart();
    renderAttributionCharts();
    
    // Set up event listeners
    setupStrategyComparisonEventListeners();
    
    // Initialize Feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});

function setupStrategyComparisonEventListeners() {
    // Period change
    document.getElementById('comparison-period').addEventListener('change', function() {
        renderPerformanceChart();
    });
    
    // Metric change
    document.getElementById('comparison-metric').addEventListener('change', function() {
        renderPerformanceChart();
    });
    
    // Benchmark change
    document.getElementById('comparison-benchmark').addEventListener('change', function() {
        updateBenchmark();
    });
    
    // Add strategy buttons
    const addButtons = [
        document.getElementById('add-strategy-btn'),
        document.getElementById('add-strategy-inline')
    ];
    
    addButtons.forEach(button => {
        if (button) {
            button.addEventListener('click', showStrategyModal);
        }
    });
    
    // Add strategy confirmation
    const addStrategyConfirm = document.getElementById('add-strategy-confirm');
    if (addStrategyConfirm) {
        addStrategyConfirm.addEventListener('click', addStrategy);
    }
    
    // Close modal buttons
    const closeModalButtons = document.querySelectorAll('[data-dismiss="modal"]');
    closeModalButtons.forEach(button => {
        button.addEventListener('click', hideStrategyModal);
    });
    
    // Strategy badge toggles
    const strategyBadges = document.querySelectorAll('.strategy-badge');
    strategyBadges.forEach(badge => {
        badge.addEventListener('click', function() {
            toggleStrategy(badge.dataset.strategy);
        });
    });
    
    // Remove strategy buttons
    const removeButtons = document.querySelectorAll('.remove-strategy');
    removeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const strategyRow = button.closest('.strategy-row');
            if (strategyRow) {
                removeStrategy(strategyRow.dataset.strategy);
            }
        });
    });
    
    // Toggle benchmark button
    const toggleBenchmarkButton = document.querySelector('.toggle-benchmark');
    if (toggleBenchmarkButton) {
        toggleBenchmarkButton.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleBenchmark();
        });
    }
    
    // Benchmark toggle button
    const benchmarkToggleBtn = document.getElementById('benchmark-toggle-btn');
    if (benchmarkToggleBtn) {
        benchmarkToggleBtn.addEventListener('click', toggleBenchmark);
    }
    
    // Expand panel button
    const expandButton = document.getElementById('expand-comparison-btn');
    if (expandButton) {
        expandButton.addEventListener('click', expandPanel);
    }
}

function renderPerformanceChart() {
    const container = document.getElementById('performance-chart');
    const period = document.getElementById('comparison-period').value;
    const metric = document.getElementById('comparison-metric').value;
    
    // Remove loading overlay
    const overlay = container.querySelector('.chart-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
    
    // Generate mock performance data
    const data = generatePerformanceData(period);
    
    // Create traces for each strategy
    const traces = [];
    
    // Strategy 1 trace
    traces.push({
        type: 'scatter',
        mode: 'lines',
        name: 'MA Crossover',
        x: data.dates,
        y: data.strategy1,
        line: {
            color: 'var(--primary)',
            width: 2
        }
    });
    
    // Strategy 2 trace
    traces.push({
        type: 'scatter',
        mode: 'lines',
        name: 'Sentiment-based',
        x: data.dates,
        y: data.strategy2,
        line: {
            color: 'var(--success)',
            width: 2
        }
    });
    
    // Benchmark trace
    traces.push({
        type: 'scatter',
        mode: 'lines',
        name: 'BTC-USD (Benchmark)',
        x: data.dates,
        y: data.benchmark,
        line: {
            color: 'var(--text-light)',
            width: 1.5,
            dash: 'dot'
        }
    });
    
    // Set up layout
    const layout = {
        title: {
            text: getChartTitle(period, metric),
            font: {
                size: 14,
                color: 'var(--text-light)'
            }
        },
        showlegend: true,
        legend: {
            orientation: 'h',
            y: -0.2
        },
        xaxis: {
            title: '',
            showgrid: true,
            gridcolor: 'var(--border-light)',
            gridwidth: 1,
            autorange: true
        },
        yaxis: {
            title: getYAxisTitle(metric),
            showgrid: true,
            gridcolor: 'var(--border-light)',
            gridwidth: 1,
            autorange: true,
            tickformat: getTickFormat(metric)
        },
        margin: {
            l: 50,
            r: 20,
            t: 40,
            b: 40
        },
        paper_bgcolor: 'var(--card-bg)',
        plot_bgcolor: 'var(--card-bg)',
        font: {
            color: 'var(--text)',
            size: 11
        },
        hovermode: 'x unified',
        hoverlabel: {
            bgcolor: 'var(--tooltip-bg)',
            bordercolor: 'var(--tooltip-border)',
            font: {
                color: 'var(--tooltip-text)',
                size: 11
            }
        }
    };
    
    // Configuration
    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['select2d', 'lasso2d', 'resetScale2d', 'toggleSpikelines'],
        displaylogo: false
    };
    
    // Render the chart
    if (typeof Plotly !== 'undefined') {
        Plotly.newPlot('performance-chart', traces, layout, config);
    }
}

function generatePerformanceData(period) {
    // Get date range based on period
    const end = new Date();
    let start = new Date();
    let points = 0;
    
    switch (period) {
        case '1w':
            start.setDate(end.getDate() - 7);
            points = 7;
            break;
        case '1m':
            start.setMonth(end.getMonth() - 1);
            points = 30;
            break;
        case '3m':
            start.setMonth(end.getMonth() - 3);
            points = 90;
            break;
        case '6m':
            start.setMonth(end.getMonth() - 6);
            points = 180;
            break;
        case '1y':
            start.setFullYear(end.getFullYear() - 1);
            points = 365;
            break;
        case 'ytd':
            start = new Date(end.getFullYear(), 0, 1);
            points = Math.floor((end - start) / (1000 * 60 * 60 * 24));
            break;
        case 'all':
            start.setFullYear(end.getFullYear() - 3);
            points = 1095;
            break;
        default:
            start.setFullYear(end.getFullYear() - 1);
            points = 365;
    }
    
    // Generate dates
    const dates = [];
    const msPerDay = 24 * 60 * 60 * 1000;
    for (let i = 0; i < points; i++) {
        dates.push(new Date(start.getTime() + i * msPerDay));
    }
    
    // Generate strategy and benchmark values
    const strategy1 = generateCumulativeReturns(1.0, points, 0.08, 0.15);
    const strategy2 = generateCumulativeReturns(1.0, points, 0.06, 0.12);
    const benchmark = generateCumulativeReturns(1.0, points, 0.05, 0.20);
    
    return {
        dates,
        strategy1,
        strategy2,
        benchmark
    };
}

function generateCumulativeReturns(initial, points, meanReturn, volatility) {
    const values = [initial];
    let current = initial;
    
    for (let i = 1; i < points; i++) {
        // Random daily return with specified mean and volatility
        const dailyReturn = (Math.random() - 0.5) * volatility + meanReturn / 365;
        current = current * (1 + dailyReturn);
        values.push(current);
    }
    
    return values;
}

function getChartTitle(period, metric) {
    const periodTexts = {
        '1w': '1 Week',
        '1m': '1 Month',
        '3m': '3 Months',
        '6m': '6 Months',
        '1y': '1 Year',
        'ytd': 'Year to Date',
        'all': 'All Time'
    };
    
    const metricTexts = {
        'returns': 'Performance Comparison',
        'drawdown': 'Drawdown Comparison',
        'sharpe': 'Sharpe Ratio Comparison',
        'sortino': 'Sortino Ratio Comparison',
        'volatility': 'Volatility Comparison',
        'win-rate': 'Win Rate Comparison',
        'profit-factor': 'Profit Factor Comparison'
    };
    
    return `${metricTexts[metric] || 'Performance'} - ${periodTexts[period] || period}`;
}

function getYAxisTitle(metric) {
    const titles = {
        'returns': 'Cumulative Returns',
        'drawdown': 'Drawdown',
        'sharpe': 'Sharpe Ratio',
        'sortino': 'Sortino Ratio',
        'volatility': 'Volatility',
        'win-rate': 'Win Rate',
        'profit-factor': 'Profit Factor'
    };
    
    return titles[metric] || '';
}

function getTickFormat(metric) {
    if (metric === 'returns' || metric === 'drawdown' || metric === 'volatility' || metric === 'win-rate') {
        return '.1%'; // Percentage format
    }
    
    return '.2f'; // Default decimal format
}

function renderAttributionCharts() {
    renderAttributionChart();
    renderDistributionChart();
}

function renderAttributionChart() {
    const container = document.getElementById('attribution-chart');
    if (!container) return;
    
    // Hide loading overlay
    const overlay = container.querySelector('.chart-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
    
    // Define data for attribution chart
    const data = [
        {
            type: 'bar',
            x: ['Market', 'Technical', 'Sentiment', 'Momentum', 'Volatility', 'Timing', 'Alpha'],
            y: [12.5, 8.3, 7.2, 6.8, 4.5, 3.2, 2.5],
            marker: {
                color: [
                    'rgba(var(--primary-rgb), 0.7)',
                    'rgba(var(--success-rgb), 0.7)',
                    'rgba(var(--info-rgb), 0.7)',
                    'rgba(var(--warning-rgb), 0.7)',
                    'rgba(var(--danger-rgb), 0.7)',
                    'rgba(var(--purple-rgb), 0.7)',
                    'rgba(var(--secondary-rgb), 0.7)'
                ]
            },
            name: 'Contribution (%)'
        }
    ];
    
    // Layout for attribution chart
    const layout = {
        autosize: true,
        margin: { t: 10, l: 50, r: 10, b: 60 },
        paper_bgcolor: 'var(--card-bg)',
        plot_bgcolor: 'var(--card-bg)',
        font: {
            color: 'var(--text)',
            size: 10
        },
        xaxis: {
            tickangle: -45
        },
        yaxis: {
            title: 'Contribution (%)',
            ticksuffix: '%'
        },
        showlegend: false
    };
    
    // Configuration
    const config = {
        responsive: true,
        displayModeBar: false
    };
    
    // Render chart
    if (typeof Plotly !== 'undefined') {
        Plotly.newPlot('attribution-chart', data, layout, config);
    }
}

function renderDistributionChart() {
    const container = document.getElementById('distribution-chart');
    if (!container) return;
    
    // Hide loading overlay
    const overlay = container.querySelector('.chart-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
    
    // Generate mock distribution data
    const trace1 = {
        x: generateDistributionData(0.5, 0.2, 100),
        type: 'histogram',
        opacity: 0.7,
        marker: {
            color: 'rgba(var(--success-rgb), 0.7)'
        },
        name: 'Profitable Trades'
    };
    
    const trace2 = {
        x: generateDistributionData(-0.3, 0.15, 50),
        type: 'histogram',
        opacity: 0.7,
        marker: {
            color: 'rgba(var(--danger-rgb), 0.7)'
        },
        name: 'Loss-making Trades'
    };
    
    const data = [trace1, trace2];
    
    // Layout for distribution chart
    const layout = {
        autosize: true,
        margin: { t: 10, l: 50, r: 10, b: 40 },
        paper_bgcolor: 'var(--card-bg)',
        plot_bgcolor: 'var(--card-bg)',
        barmode: 'overlay',
        font: {
            color: 'var(--text)',
            size: 10
        },
        legend: {
            orientation: 'h',
            y: -0.2
        },
        xaxis: {
            title: 'Return (%)',
            tickformat: '.0%'
        },
        yaxis: {
            title: 'Frequency'
        }
    };
    
    // Configuration
    const config = {
        responsive: true,
        displayModeBar: false
    };
    
    // Render chart
    if (typeof Plotly !== 'undefined') {
        Plotly.newPlot('distribution-chart', data, layout, config);
    }
}

function generateDistributionData(mean, stdDev, count) {
    const values = [];
    
    for (let i = 0; i < count; i++) {
        // Box-Muller transform for normal distribution
        const u1 = Math.random();
        const u2 = Math.random();
        const z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        
        // Apply mean and standard deviation
        const value = mean + z0 * stdDev;
        values.push(value);
    }
    
    return values;
}

function showStrategyModal() {
    const modal = document.getElementById('strategy-modal');
    if (modal) {
        modal.style.display = 'block';
    }
}

function hideStrategyModal() {
    const modal = document.getElementById('strategy-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function addStrategy() {
    const strategyType = document.getElementById('strategy-type').value;
    const strategyPeriod = document.getElementById('strategy-period').value;
    const strategyColor = document.getElementById('strategy-color').value;
    
    // Generate a unique ID for the strategy
    const strategyId = 'strategy' + Date.now();
    
    // Get strategy name from select option
    const strategySelect = document.getElementById('strategy-type');
    const strategyName = strategySelect.options[strategySelect.selectedIndex].text;
    
    // Mock return value
    const mockReturn = (Math.random() * 30 + 10).toFixed(1);
    
    // Add strategy to badge list
    const badgesContainer = document.querySelector('.strategy-badges');
    if (badgesContainer) {
        const badge = document.createElement('span');
        badge.className = 'strategy-badge active';
        badge.dataset.strategy = strategyId;
        badge.innerHTML = `
            ${strategyName}
            <span class="badge positive">+${mockReturn}%</span>
        `;
        
        // Add before add-strategy button
        const addButton = document.getElementById('add-strategy-inline');
        if (addButton) {
            badgesContainer.insertBefore(badge, addButton);
        } else {
            badgesContainer.appendChild(badge);
        }
        
        // Add event listener
        badge.addEventListener('click', function() {
            toggleStrategy(strategyId);
        });
    }
    
    // Add strategy to metrics table
    const metricsTable = document.querySelector('#metrics-table tbody');
    if (metricsTable) {
        const row = document.createElement('tr');
        row.className = 'strategy-row';
        row.dataset.strategy = strategyId;
        row.innerHTML = `
            <td class="strategy-name">
                <span class="color-dot" style="background-color: ${strategyColor};"></span>
                ${strategyName}
            </td>
            <td class="returns positive">+${mockReturn}%</td>
            <td class="drawdown">-${(Math.random() * 20 + 5).toFixed(1)}%</td>
            <td class="sharpe">${(Math.random() * 1 + 0.8).toFixed(2)}</td>
            <td class="win-rate">${Math.floor(Math.random() * 20 + 50)}%</td>
            <td class="trades">${Math.floor(Math.random() * 100 + 50)}</td>
            <td class="actions">
                <button class="btn btn-icon btn-sm" data-tooltip="View details" data-position="left">
                    <i data-feather="eye"></i>
                </button>
                <button class="btn btn-icon btn-sm remove-strategy" data-tooltip="Remove" data-position="left">
                    <i data-feather="x"></i>
                </button>
            </td>
        `;
        
        // Add to table
        metricsTable.appendChild(row);
        
        // Initialize Feather icons for the new row
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
        
        // Add remove event listener
        const removeButton = row.querySelector('.remove-strategy');
        if (removeButton) {
            removeButton.addEventListener('click', function(e) {
                e.stopPropagation();
                removeStrategy(strategyId);
            });
        }
    }
    
    // Update chart with new strategy
    updatePerformanceChart();
    
    // Hide modal
    hideStrategyModal();
}

function removeStrategy(strategyId) {
    // Remove from badges
    const badge = document.querySelector(`.strategy-badge[data-strategy="${strategyId}"]`);
    if (badge) {
        badge.remove();
    }
    
    // Remove from table
    const row = document.querySelector(`.strategy-row[data-strategy="${strategyId}"]`);
    if (row) {
        row.remove();
    }
    
    // Update chart
    updatePerformanceChart();
}

function toggleStrategy(strategyId) {
    // Toggle active state in badge
    const badge = document.querySelector(`.strategy-badge[data-strategy="${strategyId}"]`);
    if (badge) {
        badge.classList.toggle('active');
    }
    
    // Toggle visibility in table
    const row = document.querySelector(`.strategy-row[data-strategy="${strategyId}"]`);
    if (row) {
        if (row.style.opacity === '0.5') {
            row.style.opacity = '1';
        } else {
            row.style.opacity = '0.5';
        }
    }
    
    // Update chart visibility
    updatePerformanceChart();
}

function toggleBenchmark() {
    const benchmarkBadge = document.querySelector('.strategy-badge.benchmark');
    if (benchmarkBadge) {
        benchmarkBadge.classList.toggle('active');
    }
    
    const benchmarkRow = document.querySelector('.strategy-row.benchmark');
    if (benchmarkRow) {
        if (benchmarkRow.style.opacity === '0.5') {
            benchmarkRow.style.opacity = '1';
        } else {
            benchmarkRow.style.opacity = '0.5';
        }
    }
    
    // Update chart
    updatePerformanceChart();
}

function updateBenchmark() {
    const benchmark = document.getElementById('comparison-benchmark').value;
    
    // Update badge and table
    const badge = document.querySelector('.strategy-badge.benchmark');
    const row = document.querySelector('.strategy-row.benchmark');
    
    if (benchmark === 'NONE') {
        // Hide benchmark
        if (badge) badge.style.display = 'none';
        if (row) row.style.display = 'none';
    } else {
        // Show and update benchmark
        if (badge) {
            badge.style.display = '';
            const badgeText = benchmark + ' (Benchmark)';
            badge.textContent = badgeText;
        }
        
        if (row) {
            row.style.display = '';
            const nameTd = row.querySelector('.strategy-name');
            if (nameTd) {
                nameTd.innerHTML = `
                    <span class="color-dot" style="background-color: var(--text-light);"></span>
                    ${benchmark} (Benchmark)
                `;
            }
        }
    }
    
    // Update chart
    updatePerformanceChart();
}

function updatePerformanceChart() {
    // This function would update the chart based on visible strategies
    // For simplicity, we'll just re-render the whole chart
    renderPerformanceChart();
}

function expandPanel() {
    // This would implement full-screen functionality
    const panel = document.querySelector('.strategy-comparison-panel');
    if (!panel) return;
    
    if (!document.fullscreenElement) {
        panel.requestFullscreen().catch(err => {
            console.error(`Error attempting to enable full-screen mode: ${err.message}`);
        });
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}
</script>